<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>Puppet coding - Wikitech</title>
<script>document.documentElement.className="client-js";RLCONF={"wgBreakFrames":false,"wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgRequestId":"6caaba58-2db3-47bc-bef1-4fef5acfc727","wgCSPNonce":false,"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Puppet_coding","wgTitle":"Puppet coding","wgCurRevisionId":1952559,"wgRevisionId":1952559,"wgArticleId":4895,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Puppet"],"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgRelevantPageName":"Puppet_coding","wgRelevantArticleId":4895,"wgIsProbablyEditable":false,"wgRelevantPageIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgVisualEditor":{"pageLanguageCode":"en",
"pageLanguageDir":"ltr","pageVariantFallbacks":"en"},"wgMFDisplayWikibaseDescriptions":{"search":true,"nearby":true,"watchlist":true,"tagline":false},"wgWMESchemaEditAttemptStepOversample":false,"wgWMEPageLength":50000,"wgMediaViewerOnClick":true,"wgMediaViewerEnabledByDefault":true,"wgULSCurrentAutonym":"English","wgEditSubmitButtonLabelPublish":true,"wgDiscussionToolsFeaturesEnabled":{"replytool":true,"newtopictool":false,"sourcemodetoolbar":true,"topicsubscription":false,"autotopicsub":false},"wgDiscussionToolsFallbackEditMode":"visual","wgULSPosition":"personal","wgULSisCompactLinksEnabled":true,"wgSiteNoticeId":"2.0"};RLSTATE={"ext.gadget.enwp-boxes":"ready","site.styles":"ready","user.styles":"ready","user":"ready","user.options":"loading","ext.cite.styles":"ready","ext.pygments":"ready","ext.discussionTools.init.styles":"ready","skins.vector.styles.legacy":"ready","ext.visualEditor.desktopArticleTarget.noscript":"ready","ext.uls.pt":"ready","ext.dismissableSiteNotice.styles":
"ready"};RLPAGEMODULES=["ext.cite.ux-enhancements","site","mediawiki.page.ready","mediawiki.toc","skins.vector.legacy.js","mmv.head","mmv.bootstrap.autostart","ext.visualEditor.desktopArticleTarget.init","ext.visualEditor.targetLoader","ext.eventLogging","ext.wikimediaEvents","ext.gadget.site","ext.discussionTools.init","ext.uls.compactlinks","ext.uls.interface","ext.dismissableSiteNotice"];</script>
<script>(RLQ=window.RLQ||[]).push(function(){mw.loader.implement("user.options@1i9g4",function($,jQuery,require,module){mw.user.tokens.set({"patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});});});</script>
<link rel="stylesheet" href="/w/load.php?lang=en&amp;modules=ext.cite.styles%7Cext.discussionTools.init.styles%7Cext.dismissableSiteNotice.styles%7Cext.pygments%7Cext.uls.pt%7Cext.visualEditor.desktopArticleTarget.noscript%7Cskins.vector.styles.legacy&amp;only=styles&amp;skin=vector"/>
<script async="" src="/w/load.php?lang=en&amp;modules=startup&amp;only=scripts&amp;raw=1&amp;skin=vector"></script>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="/w/load.php?lang=en&amp;modules=ext.gadget.enwp-boxes&amp;only=styles&amp;skin=vector"/>
<link rel="stylesheet" href="/w/load.php?lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector"/>
<meta name="generator" content="MediaWiki 1.39.0-wmf.12"/>
<meta name="referrer" content="origin"/>
<meta name="referrer" content="origin-when-crossorigin"/>
<meta name="referrer" content="origin-when-cross-origin"/>
<meta name="format-detection" content="telephone=no"/>
<meta property="og:title" content="Puppet coding - Wikitech"/>
<meta property="og:type" content="website"/>
<link rel="preconnect" href="//upload.wikimedia.org"/>
<link rel="shortcut icon" href="/static/favicon/wikitech.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="/w/opensearch_desc.php" title="Wikitech (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="//wikitech.wikimedia.org/w/api.php?action=rsd"/>
<link rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/"/>
<link rel="canonical" href="https://wikitech.wikimedia.org/wiki/Puppet_coding"/>
</head>
<body class="ext-discussiontools-replytool-enabled ext-discussiontools-sourcemodetoolbar-enabled mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Puppet_coding rootpage-Puppet_coding skin-vector action-view skin-vector-legacy"><div id="mw-page-base" class="noprint"></div>
<div id="mw-head-base" class="noprint"></div>
<div id="content" class="mw-body" role="main">
	<a id="top"></a>
	<div id="siteNotice"><div id="mw-dismissablenotice-anonplace"></div><script>(function(){var node=document.getElementById("mw-dismissablenotice-anonplace");if(node){node.outerHTML="\u003Cdiv class=\"mw-dismissable-notice\"\u003E\u003Cdiv class=\"mw-dismissable-notice-close\"\u003E[\u003Ca tabindex=\"0\" role=\"button\"\u003Edismiss\u003C/a\u003E]\u003C/div\u003E\u003Cdiv class=\"mw-dismissable-notice-body\"\u003E\u003Cdiv id=\"localNotice\"\u003E\u003Cdiv class=\"sitenotice\" lang=\"en\" dir=\"ltr\"\u003E\u003Cdiv class=\"center\"\u003E\u003Ca href=\"https://www.mediawiki.org/wiki/Wikimedia_Hackathon_2022\" class=\"extiw\" title=\"mw:Wikimedia Hackathon 2022\"\u003EWikimedia Hackathon 2022\u003C/a\u003E will be held \u003Ci\u003Eonline\u003C/i\u003E May 20-22, 2022.\u003C/div\u003E\u003C/div\u003E\u003C/div\u003E\u003C/div\u003E\u003C/div\u003E";}}());</script></div>
	<div class="mw-indicators">
	</div>
	<h1 id="firstHeading" class="firstHeading mw-first-heading">Puppet coding</h1>
	<div id="bodyContent" class="vector-body">
		<div id="siteSub" class="noprint">From Wikitech</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr"><div class="mw-parser-output"><p>This page is about writing puppet code: how to write it, when to write it, where to put it.  For information about how to install or manage puppet, visit <a href="/wiki/Puppet" title="Puppet">Puppet</a>.
</p>
<div style="clear: both; margin-bottom: .5em; float: right; margin-left:2.5em; width: auto;" class="toclimit-3"><div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none" /><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Getting_the_source"><span class="tocnumber">1</span> <span class="toctext">Getting the source</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Set_up_local_environment"><span class="tocnumber">2</span> <span class="toctext">Set up local environment</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#Install_ruby_and_python_tox_packages"><span class="tocnumber">2.1</span> <span class="toctext">Install ruby and python tox packages</span></a>
<ul>
<li class="toclevel-3 tocsection-4"><a href="#MacOS_macports"><span class="tocnumber">2.1.1</span> <span class="toctext">MacOS macports</span></a></li>
<li class="toclevel-3 tocsection-5"><a href="#MacOS_Homebrew"><span class="tocnumber">2.1.2</span> <span class="toctext">MacOS Homebrew</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#Debian/Ubuntu"><span class="tocnumber">2.1.3</span> <span class="toctext">Debian/Ubuntu</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-7"><a href="#Setup_env"><span class="tocnumber">2.2</span> <span class="toctext">Setup env</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-8"><a href="#When_we_use_Puppet"><span class="tocnumber">3</span> <span class="toctext">When we use Puppet</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="#Wikimedia_Cloud_VPS"><span class="tocnumber">3.1</span> <span class="toctext">Wikimedia Cloud VPS</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#Organization"><span class="tocnumber">4</span> <span class="toctext">Organization</span></a>
<ul>
<li class="toclevel-2 tocsection-11"><a href="#Modules"><span class="tocnumber">4.1</span> <span class="toctext">Modules</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#Profiles"><span class="tocnumber">4.2</span> <span class="toctext">Profiles</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#Roles"><span class="tocnumber">4.3</span> <span class="toctext">Roles</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#Hiera"><span class="tocnumber">4.4</span> <span class="toctext">Hiera</span></a></li>
<li class="toclevel-2 tocsection-15"><a href="#Nodes_in_site.pp"><span class="tocnumber">4.5</span> <span class="toctext">Nodes in site.pp</span></a></li>
<li class="toclevel-2 tocsection-16"><a href="#A_working_example:_deployment_host"><span class="tocnumber">4.6</span> <span class="toctext">A working example: deployment host</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="#When_should_a_profile_include_another_profile"><span class="tocnumber">4.7</span> <span class="toctext">When should a profile include another profile</span></a></li>
<li class="toclevel-2 tocsection-18"><a href="#WMF_Design_conventions"><span class="tocnumber">4.8</span> <span class="toctext">WMF Design conventions</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-19"><a href="#Coding_Style"><span class="tocnumber">5</span> <span class="toctext">Coding Style</span></a>
<ul>
<li class="toclevel-2 tocsection-20"><a href="#format"><span class="tocnumber">5.1</span> <span class="toctext">format</span></a>
<ul>
<li class="toclevel-3 tocsection-21"><a href="#Spacing,_Indentation,_&amp;_Whitespace"><span class="tocnumber">5.1.1</span> <span class="toctext">Spacing, Indentation, &amp; Whitespace</span></a></li>
<li class="toclevel-3 tocsection-22"><a href="#Quoting"><span class="tocnumber">5.1.2</span> <span class="toctext">Quoting</span></a></li>
<li class="toclevel-3 tocsection-23"><a href="#Resources"><span class="tocnumber">5.1.3</span> <span class="toctext">Resources</span></a></li>
<li class="toclevel-3 tocsection-24"><a href="#Conditionals"><span class="tocnumber">5.1.4</span> <span class="toctext">Conditionals</span></a></li>
<li class="toclevel-3 tocsection-25"><a href="#Classes"><span class="tocnumber">5.1.5</span> <span class="toctext">Classes</span></a></li>
<li class="toclevel-3 tocsection-26"><a href="#Including"><span class="tocnumber">5.1.6</span> <span class="toctext">Including</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-27"><a href="#Useful_global_variables"><span class="tocnumber">5.2</span> <span class="toctext">Useful global variables</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-28"><a href="#Testing_a_patch"><span class="tocnumber">6</span> <span class="toctext">Testing a patch</span></a>
<ul>
<li class="toclevel-2 tocsection-29"><a href="#Parser_validation"><span class="tocnumber">6.1</span> <span class="toctext">Parser validation</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="#Lint"><span class="tocnumber">6.2</span> <span class="toctext">Lint</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#on_Debian/Ubuntu"><span class="tocnumber">6.3</span> <span class="toctext">on Debian/Ubuntu</span></a>
<ul>
<li class="toclevel-3 tocsection-32"><a href="#on_Mac_OS_X"><span class="tocnumber">6.3.1</span> <span class="toctext">on Mac OS X</span></a></li>
<li class="toclevel-3 tocsection-33"><a href="#generic_(Ruby_gem)"><span class="tocnumber">6.3.2</span> <span class="toctext">generic (Ruby gem)</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-34"><a href="#How_to_use"><span class="tocnumber">6.4</span> <span class="toctext">How to use</span></a></li>
<li class="toclevel-2 tocsection-35"><a href="#Ignoring_lint_warnings_and_errors"><span class="tocnumber">6.5</span> <span class="toctext">Ignoring lint warnings and errors</span></a></li>
<li class="toclevel-2 tocsection-36"><a href="#Find_out_which_warnings/errors_are_currently_ignored"><span class="tocnumber">6.6</span> <span class="toctext">Find out which warnings/errors are currently ignored</span></a></li>
<li class="toclevel-2 tocsection-37"><a href="#Cloud_VPS_testing"><span class="tocnumber">6.7</span> <span class="toctext">Cloud VPS testing</span></a></li>
<li class="toclevel-2 tocsection-38"><a href="#catalog_compilation"><span class="tocnumber">6.8</span> <span class="toctext">catalog compilation</span></a></li>
<li class="toclevel-2 tocsection-39"><a href="#Manual_module_testing"><span class="tocnumber">6.9</span> <span class="toctext">Manual module testing</span></a></li>
<li class="toclevel-2 tocsection-40"><a href="#Unit_Testing_modules"><span class="tocnumber">6.10</span> <span class="toctext">Unit Testing modules</span></a>
<ul>
<li class="toclevel-3 tocsection-41"><a href="#Rake_tests"><span class="tocnumber">6.10.1</span> <span class="toctext">Rake tests</span></a></li>
<li class="toclevel-3 tocsection-42"><a href="#Custom_tests"><span class="tocnumber">6.10.2</span> <span class="toctext">Custom tests</span></a></li>
<li class="toclevel-3 tocsection-43"><a href="#Common_errors"><span class="tocnumber">6.10.3</span> <span class="toctext">Common errors</span></a>
<ul>
<li class="toclevel-4 tocsection-44"><a href="#tab_character_found_on_line_.."><span class="tocnumber">6.10.3.1</span> <span class="toctext">tab character found on line ..</span></a></li>
<li class="toclevel-4 tocsection-45"><a href="#double_quoted_string_containing_no_variables"><span class="tocnumber">6.10.3.2</span> <span class="toctext">double quoted string containing no variables</span></a></li>
<li class="toclevel-4 tocsection-46"><a href="#unquoted_file_mode"><span class="tocnumber">6.10.3.3</span> <span class="toctext">unquoted file mode</span></a></li>
<li class="toclevel-4 tocsection-47"><a href="#line_has_more_than_80_characters"><span class="tocnumber">6.10.3.4</span> <span class="toctext">line has more than 80 characters</span></a></li>
<li class="toclevel-4 tocsection-48"><a href="#not_in_autoload_module_layout"><span class="tocnumber">6.10.3.5</span> <span class="toctext">not in autoload module layout</span></a></li>
<li class="toclevel-4 tocsection-49"><a href="#ensure_found_on_line_but_it&#39;s_not_the_first_attribute"><span class="tocnumber">6.10.3.6</span> <span class="toctext">ensure found on line but it's not the first attribute</span></a></li>
<li class="toclevel-4 tocsection-50"><a href="#unquoted_resource_title"><span class="tocnumber">6.10.3.7</span> <span class="toctext">unquoted resource title</span></a></li>
<li class="toclevel-4 tocsection-51"><a href="#top-scope_variable_being_used_without_an_explicit_namespace"><span class="tocnumber">6.10.3.8</span> <span class="toctext">top-scope variable being used without an explicit namespace</span></a></li>
<li class="toclevel-4 tocsection-52"><a href="#class_defined_inside_a_class"><span class="tocnumber">6.10.3.9</span> <span class="toctext">class defined inside a class</span></a></li>
<li class="toclevel-4 tocsection-53"><a href="#quoted_boolean_value"><span class="tocnumber">6.10.3.10</span> <span class="toctext">quoted boolean value</span></a></li>
<li class="toclevel-4 tocsection-54"><a href="#case_statement_without_a_default_case"><span class="tocnumber">6.10.3.11</span> <span class="toctext">case statement without a default case</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-55"><a href="#Puppet_modules"><span class="tocnumber">7</span> <span class="toctext">Puppet modules</span></a>
<ul>
<li class="toclevel-2 tocsection-56"><a href="#3rd_party_or_upstream_modules"><span class="tocnumber">7.1</span> <span class="toctext">3rd party or upstream modules</span></a>
<ul>
<li class="toclevel-3 tocsection-57"><a href="#Adding_a_3rd_Party_module"><span class="tocnumber">7.1.1</span> <span class="toctext">Adding a 3rd Party module</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-58"><a href="#Miscellaneous"><span class="tocnumber">8</span> <span class="toctext">Miscellaneous</span></a>
<ul>
<li class="toclevel-2 tocsection-59"><a href="#VIM_guidelines"><span class="tocnumber">8.1</span> <span class="toctext">VIM guidelines</span></a></li>
<li class="toclevel-2 tocsection-60"><a href="#Emacs_guidelines"><span class="tocnumber">8.2</span> <span class="toctext">Emacs guidelines</span></a></li>
<li class="toclevel-2 tocsection-61"><a href="#Puppet_for_Wikimedia_VPS_Projects"><span class="tocnumber">8.3</span> <span class="toctext">Puppet for Wikimedia VPS Projects</span></a></li>
<li class="toclevel-2 tocsection-62"><a href="#Packages_that_use_pip,_gem,_etc."><span class="tocnumber">8.4</span> <span class="toctext">Packages that use pip, gem, etc.</span></a></li>
<li class="toclevel-2 tocsection-63"><a href="#Different_ways_to_install_apt_packages_with_puppet"><span class="tocnumber">8.5</span> <span class="toctext">Different ways to install apt packages with puppet</span></a>
<ul>
<li class="toclevel-3 tocsection-64"><a href="#method_1:_ensure_present"><span class="tocnumber">8.5.1</span> <span class="toctext">method 1: ensure present</span></a></li>
<li class="toclevel-3 tocsection-65"><a href="#method_2:_ensure_latest"><span class="tocnumber">8.5.2</span> <span class="toctext">method 2: ensure latest</span></a></li>
<li class="toclevel-3 tocsection-66"><a href="#method_3:_ensure_version"><span class="tocnumber">8.5.3</span> <span class="toctext">method 3: ensure version</span></a></li>
<li class="toclevel-3 tocsection-67"><a href="#method_4:_install_options"><span class="tocnumber">8.5.4</span> <span class="toctext">method 4: install options</span></a></li>
<li class="toclevel-3 tocsection-68"><a href="#method_5:_apt_pinning"><span class="tocnumber">8.5.5</span> <span class="toctext">method 5: apt pinning</span></a></li>
<li class="toclevel-3 tocsection-69"><a href="#method_6:_combination"><span class="tocnumber">8.5.6</span> <span class="toctext">method 6: combination</span></a></li>
<li class="toclevel-3 tocsection-70"><a href="#method_7:_apt_configuration_before_installation"><span class="tocnumber">8.5.7</span> <span class="toctext">method 7: apt configuration before installation</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-71"><a href="#References"><span class="tocnumber">9</span> <span class="toctext">References</span></a></li>
</ul>
</div>
</div>
<h2><span class="mw-headline" id="Getting_the_source" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Getting_the_source&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:2,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Getting_the_source"></span>Getting the source<span data-mw-comment-end="h-Getting_the_source"></span></span></h2>
<div class="alert alert-info"><strong>Source code:</strong> <code><a rel="nofollow" class="external text" href="https://github.com/wikimedia/puppet">operations/puppet.git</a></code></div>
<p><code>git clone --recursive https://gerrit.wikimedia.org/r/operations/puppet</code>
</p><p>If you have a slow internet connection:
</p>
<pre>git clone --recursive https://gerrit.wikimedia.org/r/operations/puppet --depth 1
cd puppet 
git fetch --unshallow
</pre><p>  else use below 
</p><h2><span class="mw-headline" id="Set_up_local_environment" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Set_up_local_environment&quot;,&quot;replies&quot;:[&quot;h-Install_ruby_and_python_tox_packages-Set_up_local_environment&quot;,&quot;h-Setup_env-Set_up_local_environment&quot;],&quot;headingLevel&quot;:2,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Set_up_local_environment"></span>Set up local environment<span data-mw-comment-end="h-Set_up_local_environment"></span></span></h2>
<p>It is possible to run some tests locally. To do that, you will need an environment setup.
</p>
<h3><span class="mw-headline" id="Install_ruby_and_python_tox_packages" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Install_ruby_and_python_tox_packages-Set_up_local_environment&quot;,&quot;replies&quot;:[&quot;h-MacOS_macports-Install_ruby_and_python_tox_packages&quot;,&quot;h-MacOS_Homebrew-Install_ruby_and_python_tox_packages&quot;,&quot;h-Debian\/Ubuntu-Install_ruby_and_python_tox_packages&quot;],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Install_ruby_and_python_tox_packages-Set_up_local_environment"></span>Install ruby and python tox packages<span data-mw-comment-end="h-Install_ruby_and_python_tox_packages-Set_up_local_environment"></span></span></h3>
<style data-mw-deduplicate="TemplateStyles:r1938107">.mw-parser-output table.ambox{margin:0 10%;border:1px solid #a2a9b1;border-left:10px solid #36c;background-color:#fbfbfb;box-sizing:border-box}.mw-parser-output table.ambox+table.ambox,.mw-parser-output table.ambox+link+table.ambox,.mw-parser-output table.ambox+style+table.ambox{margin-top:-1px}.mw-parser-output .ambox td.mbox-empty-cell{border:none;padding:0;width:1px}.mw-parser-output .ambox th.mbox-text,.mw-parser-output .ambox td.mbox-text{border:none;padding:0.25em 0.5em;width:100%}.mw-parser-output .ambox td.mbox-image{padding:2px 0 2px 0.5em}.mw-parser-output .ambox td.mbox-imageright{padding:2px 0.5em 2px 0}.mw-parser-output table.ambox-notice{border-left-color:#36c}.mw-parser-output table.ambox-speedy{background-color:#fee7e6}.mw-parser-output table.ambox-delete,.mw-parser-output table.ambox-speedy{border-left-color:#b32424}.mw-parser-output table.ambox-content{border-left-color:#f28500}.mw-parser-output table.ambox-style{border-left-color:#fc3}.mw-parser-output table.ambox-move{border-left-color:#9932cc}.mw-parser-output table.ambox-protection{border-left-color:#a2a9b1}html body.mediawiki .mw-parser-output .ambox.mbox-small{clear:right;float:right;margin:4px 0 4px 1em;box-sizing:border-box;width:238px;font-size:88%;line-height:1.25em}html body.mediawiki .mw-parser-output .ambox.mbox-small-left{margin:4px 1em 4px 0;box-sizing:border-box;overflow:hidden;width:238px;border-collapse:collapse;font-size:88%;line-height:1.25em}</style><table class="plainlinks metadata plainlinks ambox ambox-content" role="presentation"><tbody><tr><td class="mbox-image"><div style="width:52px"><span typeof="mw:Image"><span><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/OOjs_UI_icon_notice-warning.svg/40px-OOjs_UI_icon_notice-warning.svg.png" decoding="async" width="40" height="40" srcset="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/OOjs_UI_icon_notice-warning.svg/60px-OOjs_UI_icon_notice-warning.svg.png 1.5x, https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/OOjs_UI_icon_notice-warning.svg/80px-OOjs_UI_icon_notice-warning.svg.png 2x" data-file-width="20" data-file-height="20"/></span></span></div></td><td class="mbox-text"><div class="mbox-text-span">The instructions below refer to <tt>rbenv</tt> and <tt>.ruby-version</tt>. The latter file is gone (it was outdated for a long time) and the former may have better replacements. This documentation should updated accordingly. Until then, if your system has the same Ruby version as the puppet masters, things will likely be okay.</div></td></tr></tbody></table>
<p><br/>
You need to make sure that you have a ruby version installed that matches the version in production (see the <tt>.ruby-version</tt> file in the puppet repo).
If your system version of ruby differs from that, you may use <tt>rbenv</tt> to build the required version for you.
</p>
<h4><span class="mw-headline" id="MacOS_macports" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-MacOS_macports-Install_ruby_and_python_tox_packages&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-MacOS_macports-Install_ruby_and_python_tox_packages"></span>MacOS macports<span data-mw-comment-end="h-MacOS_macports-Install_ruby_and_python_tox_packages"></span></span></h4>
<pre> # port install rbenv ruby-build
 # port search tox
 # port install py&lt;ver>-tox
</pre>
<h4><span class="mw-headline" id="MacOS_Homebrew" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-MacOS_Homebrew-Install_ruby_and_python_tox_packages&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-MacOS_Homebrew-Install_ruby_and_python_tox_packages"></span>MacOS Homebrew<span data-mw-comment-end="h-MacOS_Homebrew-Install_ruby_and_python_tox_packages"></span></span></h4>
<pre> # brew install tox rbenv
</pre>
<h4><span id="Debian.2FUbuntu"></span><span class="mw-headline" id="Debian/Ubuntu" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Debian\/Ubuntu-Install_ruby_and_python_tox_packages&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Debian/Ubuntu-Install_ruby_and_python_tox_packages"></span>Debian/Ubuntu<span data-mw-comment-end="h-Debian/Ubuntu-Install_ruby_and_python_tox_packages"></span></span></h4>
<pre> # sudo apt install ruby bundler tox
</pre>
<p>If not using the ruby system package:
</p>
<pre> # sudo apt install rbenv ruby-build tox
</pre>
<p>If you're using ubuntu 18.04, also install <code>libssl1.0-dev</code>, as ruby 2.3.3 <a rel="nofollow" class="external text" href="https://github.com/rbenv/ruby-build/issues/1207#issuecomment-399744332">doesn't support openssl 1.1</a>.
</p>
<h3><span class="mw-headline" id="Setup_env" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Setup_env-Set_up_local_environment&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Setup_env-Set_up_local_environment"></span>Setup env<span data-mw-comment-end="h-Setup_env-Set_up_local_environment"></span></span></h3>
<ul><li>Either run <tt>rbenv init</tt> to hook rbenv to your shell or follow instructions from here <a rel="nofollow" class="external text" href="https://github.com/rbenv/rbenv#how-rbenv-hooks-into-your-shell">https://github.com/rbenv/rbenv#how-rbenv-hooks-into-your-shell</a>.</li>
<li>Go to your local puppet repo to have rbenv install the appropriate ruby version</li></ul>
<pre> $ rbenv install
 $ rbenv versions 
 # This command should list a version alongside your "system" version
</pre>
<ul><li>Install bundler (skip this if using the bundler system package)</li></ul>
<pre> $ rbenv exec gem install bundler
</pre>
<ul><li>Install dependencies</li></ul>
<pre> $ rbenv exec bundle install
 # If using ruby/bundler system package:
 $ bundle install --path vendor/bundle
</pre>
<ul><li>Test that it is ok, the following will show you a list of tasks</li></ul>
<pre> $ rbenv exec bundle exec rake --tasks
</pre>
<p>Done, your env is ready!
</p>
<h2><span class="mw-headline" id="When_we_use_Puppet" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-When_we_use_Puppet&quot;,&quot;replies&quot;:[&quot;h-Wikimedia_Cloud_VPS-When_we_use_Puppet&quot;],&quot;headingLevel&quot;:2,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-When_we_use_Puppet"></span>When we use Puppet<span data-mw-comment-end="h-When_we_use_Puppet"></span></span></h2>
<p>Puppet is our configuration management system. Anything related to the configuration files &amp; state of a server should be puppetized. There are a few cases where configurations are deployed into systems without involving Puppet but these are the exceptions rather than the rule (<a href="/wiki/How_to_deploy_code" title="How to deploy code">MediaWiki configuration</a> etc.); all package installs and configurations should happen via Puppet in order to ensure peer review and reproducibility.
</p><p>However, Puppet is <i>not</i> being used as a deployment system at Wikimedia. Pushing code via Puppet, e.g. with the define <code>git::clone</code> should be avoided. Depending on the case, Debian packages or the use of our deployment system (<a href="/wiki/Scap3" class="mw-redirect" title="Scap3">Scap3</a>) should be employed. Deploying software via Scap3 can be achieved in Puppet by using the puppet class <code>scap::target</code>.
</p>
<h3><span class="mw-headline" id="Wikimedia_Cloud_VPS" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Wikimedia_Cloud_VPS-When_we_use_Puppet&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Wikimedia_Cloud_VPS-When_we_use_Puppet"></span>Wikimedia <a href="/wiki/Help:Cloud_Services_Introduction#VPS_.3D.3E_Wikimedia_VPS" class="mw-redirect" title="Help:Cloud Services Introduction">Cloud VPS</a><span data-mw-comment-end="h-Wikimedia_Cloud_VPS-When_we_use_Puppet"></span></span></h3>
<p>Cloud VPS users have considerable freedom in the configuration of their systems, and the state of machines is frequently not puppetized.  Specific projects (e.g. <a href="https://iw.toolforge.org/" class="extiw" title="toolforge:">Toolforge</a>) often have their own systems for maintaining code and configuration.
</p><p>That said, any system being used for semi-production purposes (e.g. public test sites, bot hosts, etc.) should be fully puppetized. VPS users should always be ready for their instance to vanish at a moment's notice, and have a plan to reproduce the same functionality on a new instance -- generally this is accomplished using Puppet.
</p><p>The node definitions for a VPS instances are not stored in <code>manifests/site.pp</code> -- they are configured via the <a href="/wiki/Horizon" class="mw-redirect" title="Horizon">OpenStack Horizon</a> user interface and stored in a backing persistent data store. In order to test and develop puppet manifests for Cloud VPS it might be helpful to setup a <a href="/wiki/Help:Standalone_puppetmaster" title="Help:Standalone puppetmaster">Standalone puppetmaster</a>.
</p><p>We maintain certain instance standards that must be preserved, such as: LDAP, DNS, security settings, administrative accounts, etc.  Removing or overriding these settings means an instance is no longer manageable as part of the Cloud VPS environment.  These instances may be removed or turned off out of necessity. This is part of the <a href="/wiki/Instance_lifecycle" class="mw-redirect" title="Instance lifecycle">instance lifecycle</a>.
</p>
<h2><span class="mw-headline" id="Organization" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Organization&quot;,&quot;replies&quot;:[&quot;h-Modules-Organization&quot;,&quot;h-Profiles-Organization&quot;,&quot;h-Roles-Organization&quot;,&quot;h-Hiera-Organization&quot;,&quot;h-Nodes_in_site.pp-Organization&quot;,&quot;h-A_working_example:_deployment_host-Organization&quot;,&quot;h-When_should_a_profile_include_another_profile-Organization&quot;,&quot;h-WMF_Design_conventions-Organization&quot;],&quot;headingLevel&quot;:2,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Organization"></span>Organization<span data-mw-comment-end="h-Organization"></span></span></h2>
<p>As of December 2016, we decided<sup id="cite_ref-1" class="reference"><a href="#cite_note-1">[1]</a></sup> to adopt our own variation of the role/profile pattern that is pretty common in puppet coding nowadays. Please note that existing code might not respect this convention, but any new code should definitely follow this model.
</p><p>The code should be organized in modules, profiles and roles, where 
</p>
<ol><li><b>Modules should be basic units of functionality</b> (e.g. "set up, configure and run HHVM")</li>
<li><b>Profiles are collection of resources from modules that represent a high-level functionality</b>  ("a webserver able to serve mediawiki"),</li>
<li><b>Roles represent a collective function of one class of servers</b> (e.g. "A mediawiki appserver for the API cluster")</li>
<li><b>Any node declaration must only include one role, invoked with the role function</b>. No exceptions to this rule. If you need to include two roles in a node, that means that's another role including the two.</li></ol>
<p>Let's see more in detail what rules apply to each of this logical divisions.
</p>
<h3><span class="mw-headline" id="Modules" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Modules-Organization&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Modules-Organization"></span>Modules<span data-mw-comment-end="h-Modules-Organization"></span></span></h3>
<p>Modules should represent basic units of functionality and should be mostly general-purpose and reusable across very different environments. Rules regarding organizing code in modules are simple enough:
</p>
<ol><li>Any class, define or resource in a module <b>must not  use classes from other modules</b>, and avoid, wherever possible, to use defines from other modules as well.</li>
<li><b>No hiera call, explicit or implicit, should happen within a module.</b></li></ol>
<p>These rules will ensure the amount of WMF-specific code that makes it into modules is minimal, and improve debugging/refactoring/testing of modules as they don't really depend on each other. Keeping up with the HHVM module example, the base class <a rel="nofollow" class="external text" href="https://github.com/wikimedia/operations-puppet/blob/875aadfcbfcccb33ae02265c57b26ced410611c2/modules/hhvm/manifests/init.pp">hhvm</a> is a good example of what should be in a module, while <a rel="nofollow" class="external text" href="https://github.com/wikimedia/operations-puppet/blob/875aadfcbfcccb33ae02265c57b26ced410611c2/modules/hhvm/manifests/admin.pp">hhvm::admin</a> is a good example of what should <b>not</b> be in a module; surely not in this one: it is a class to configure apache to forward requests to HHVM, depends mostly on another module (apache) and also adds ferm rules, which of course requires the WMF-specific <code>network::constants</code> class.
</p>
<h3><span class="mw-headline" id="Profiles" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Profiles-Organization&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Profiles-Organization"></span>Profiles<span data-mw-comment-end="h-Profiles-Organization"></span></span></h3>
<p>Profiles are the classes where resources from modules are collected together, organized and configured. There are several rules on how to write a profile, specifically:
</p>
<ol><li>Profile classes <b>should only have parameters that are set via explicit lookup calls</b>. You may optionally provide a default by using the <code>{default_value}</code> construct.
<ul><li><code>$web_workers = lookup('profile::ores::web::workers')</code> is good.</li>
<li><code>$web_workers = lookup('profile::ores::web::workers', {'default_value' => 48})</code> is also good.</li></ul></li>
<li>use of the legacy hiera functions (<code>hiera</code>, <code>hiera_hash</code> &amp; <code>hiera_include</code>) are now deprecated and CI will throw an error</li>
<li>No hiera call should be made outside of said parameters.</li>
<li>No resource should be added to a profile using the <code>include class</code> method, but with <b>explicit class instantiations</b>. Only very specific exceptions are allowed, like global classes like the network::constants class.</li>
<li>If a profile needs another one as a precondition, it must be listed with a <code>require ::profile::foo</code> at the start of the class, but it's preferred to have roles compose profiles that don't need to depend on each other. See <a href="/wiki/Puppet_coding#When_should_a_profile_include_another_profile" title="Puppet coding">below</a> for more context.</li></ol>
<p>Most of what we used to call "roles" at the WMF are in fact profiles. Following our example, an apache webserver that proxies to a local HHVM installation should be configured via a <code>profile::hhvm::webproxy</code> class; a mediawiki installation served through such a webserver should be configured via a <code>profile::mediawiki::web</code> class.
</p>
<h3><span class="mw-headline" id="Roles" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Roles-Organization&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Roles-Organization"></span>Roles<span data-mw-comment-end="h-Roles-Organization"></span></span></h3>
<p>Roles are the abstraction describing a class of servers, and:
</p>
<ol><li><b>Roles must only include profiles</b> via the <code>include</code> keyword, plus a <code>system::role</code> definition describing the role</li>
<li>A role can include more than one profile, but <b>no conditionals, hiera calls, etc are allowed</b>.</li>
<li><b>Inheritance can be used between roles, but it is strongly discouraged</b>: for instance, it should be remembered that inheritance will not work in hiera.</li>
<li>All roles should include the standard profile</li></ol>
<p>Following our example, we should have a <code>role::mediawiki::web</code> that just includes <code>profile::mediawiki::web</code> and <code>profile::hhvm::webproxy</code>.
</p>
<h3><span class="mw-headline" id="Hiera" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Hiera-Organization&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Hiera-Organization"></span>Hiera<span data-mw-comment-end="h-Hiera-Organization"></span></span></h3>
<p>Hiera is a powerful tool to decouple data from code in puppet. However, as we saw while transitioning to its use, it is not without dangers and can easily become a tangled mess. To make it easier to understand and debug, the following rules apply when using it:
</p>
<ol><li><b>No class parameter autolookup is allowed, ever.</b> This means you should explicitly declare any variable as a parameter of the profile classes, and passed along explicitly to the classes/defines within the profile.</li>
<li><b>Hiera calls can only be defined in profiles, as default values of class parameters</b>.</li>
<li>All hiera definitions for such parameters should be defined in the <code>role</code> hierarchy. Only exceptions can be shared data structures that can be used by many profiles or to feed different modules with their data. Those should go in the <code>common/$site</code> global hierarchy. A good example is, in our codebase, <code>ganglia_clusters</code>, or any list of servers (the memcached hosts for mediawiki, for example).</li>
<li><b>Per-host hiera</b> should only be used to allow tweaking some knobs for testing or to maybe declare canaries in a cluster. It <b>should not be used to add/subtract functionality.</b> If you need to do that, add a new role and configure it accordingly, within its own hiera namespace.</li>
<li><b>Hiera keys must reflect the most specific common shared namespace of the puppet classes trying to look them up</b>. This should allow easier grepping and avoid conflicts. Global variables should be avoided as much as possible. This means that a parameter specific to a profile will have its namespace (say <code>profile::hhvm::webproxy::fcgi_settings</code>), while things shared among all profiles for a technology should be at the smallest common level (say the common settings for any hhvm install, <code>profile::hhvm::common_settings</code>), and finally global variables should have no namespace (the <code>ganglia_clusters</code> example above) and use only snake case and no semicolons.</li></ol>
<link rel="mw-deduplicated-inline-style" href="mw-data:TemplateStyles:r1938107"/><table class="plainlinks metadata plainlinks ambox ambox-content" role="presentation"><tbody><tr><td class="mbox-image"><div style="width:52px"><span typeof="mw:Image"><span><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/OOjs_UI_icon_notice-warning.svg/40px-OOjs_UI_icon_notice-warning.svg.png" decoding="async" width="40" height="40" srcset="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/OOjs_UI_icon_notice-warning.svg/60px-OOjs_UI_icon_notice-warning.svg.png 1.5x, https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/OOjs_UI_icon_notice-warning.svg/80px-OOjs_UI_icon_notice-warning.svg.png 2x" data-file-width="20" data-file-height="20"/></span></span></div></td><td class="mbox-text"><div class="mbox-text-span">The classic Hiera functions have been <a rel="nofollow" class="external text" href="https://puppet.com/docs/puppet/5.1/hiera_migrate_functions.html">deprecated</a> and will be removed in Puppet 6. Future-proof your code by using the <a rel="nofollow" class="external text" href="https://puppet.com/docs/puppet/5.5/hiera_automatic.html">lookup</a> function instead.</div></td></tr></tbody></table>
<h3><span class="mw-headline" id="Nodes_in_site.pp" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Nodes_in_site.pp-Organization&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Nodes_in_site.pp-Organization"></span>Nodes in site.pp<span data-mw-comment-end="h-Nodes_in_site.pp-Organization"></span></span></h3>
<p>Our traditional node definitions included a lot of global variables and boilerplate that needed to be added. Nowadays, your node definitions should just include a simple one-liner:
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">node</span> <span class="s">'redis2001.codfw.wmnet'</span> <span class="p">{</span>
    <span class="k">role</span><span class="p">(</span><span class="na">db</span><span class="p">::</span><span class="na">redis</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>this will include the class role::db::redis and look for role-related hiera configs in <tt>hieradata/role/codfw/db/redis.yaml</tt> and then in <tt>hieradata/role/common/db/redis.yaml</tt>, which may for example be:
</p>
<div class="mw-highlight mw-highlight-lang-yaml mw-content-ltr" dir="ltr"><pre><span></span><span class="nt">cluster</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">redis</span>
<span class="l l-Scalar l-Scalar-Plain">profile::admin::groups</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">redis-admins</span>
</pre></div>
<h3><span class="mw-headline" id="A_working_example:_deployment_host" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-A_working_example:_deployment_host-Organization&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-A_working_example:_deployment_host-Organization"></span>A working example: deployment host<span data-mw-comment-end="h-A_working_example:_deployment_host-Organization"></span></span></h3>
<p>Say we want to set up a deployment host role with the following things:
</p>
<ul><li>A scap 3 master, which includes the scap configuration and a simple http server</li>
<li>A docker build and deploy environment, which will need the kubernetes client cli tool</li></ul><p>
So we will want to have a simple module that installs and does the basic scap setup:</p><div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="c"># Class docs, see below for the format</span>
<span class="k">class</span> <span class="na">scap3</span> <span class="p">(</span>
    <span class="nv">$config</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="na">require_package</span><span class="p">(</span><span class="s">'python-scap3'</span><span class="p">,</span> <span class="s">'git'</span><span class="p">)</span>
    <span class="na">scap3</span><span class="p">::</span><span class="na">config</span> <span class="p">{</span> <span class="s">'main'</span><span class="p">:</span>
        <span class="na">config</span> <span class="o">=></span> <span class="nv">$config,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>as you can see, the only resource referenced is coming from the same module. In order for a master to work, we also need apache set up and firewall rules to be created. This is going to be a profile: we are defining one specific unit of functionality, the scap master.</p><div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="c"># Class docs, as usual</span>
<span class="k">class</span> <span class="na">profile</span><span class="p">::</span><span class="na">scap3</span><span class="p">::</span><span class="na">master</span> <span class="p">(</span>
    <span class="nv">$scap_config</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="s">'profile::scap3::base_config'</span><span class="p">),</span><span class="c"> # This might be shared with other profiles</span>
    <span class="nv">$server_name</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="s">'profile::scap3::master::server_name'</span><span class="p">),</span>
    <span class="nv">$max_post_size</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="s">'profile::scap3::master::max_post_size'</span><span class="p">),</span>
    <span class="nv">$mediawiki_proxies</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="s">'scap_mediawiki_proxies'</span><span class="p">),</span><span class="c"> # This is a global list</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="k">class</span> <span class="p">{</span> <span class="s">'scap3'</span><span class="p">:</span>
        <span class="na">config</span> <span class="o">=></span> <span class="na">merge</span><span class="p">({</span> <span class="s">'server_name'</span> <span class="o">=></span> <span class="nv">$server_name},</span> <span class="nv">$scap_config),</span>
    <span class="p">}</span><span class="c"></span>
<span class="c">    </span>
<span class="c">    # Set up apache</span>
    <span class="na">apache</span><span class="p">::</span><span class="na">conf</span> <span class="p">{</span> <span class="s">'Max_post_size'</span><span class="p">:</span>
        <span class="na">content</span> <span class="o">=></span> <span class="s">"LimitRequestBody ${max_post_size}"</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="na">apache</span><span class="p">::</span><span class="na">site</span> <span class="p">{</span> <span class="s">'scap_master'</span><span class="p">:</span>
        <span class="na">content</span> <span class="o">=></span> <span class="k">template</span><span class="p">(</span><span class="s">'profile/scap/scap_master.conf.erb'</span><span class="p">),</span>
        <span class="err">...</span>
    <span class="p">}</span><span class="c"></span>
<span class="c">    # Firewalling</span>
    <span class="na">ferm</span><span class="p">::</span><span class="k">service</span> <span class="p">{</span> <span class="s">'scap_http'</span><span class="p">:</span>
        <span class="na">proto</span> <span class="o">=></span> <span class="s">'tcp'</span><span class="p">,</span>
        <span class="na">port</span>  <span class="o">=></span> <span class="nv">$scap_config</span><span class="p">[</span><span class="s">'http_port'</span><span class="p">],</span>
    <span class="p">}</span><span class="c"></span>
<span class="c">    </span>
<span class="c">    # Monitoring</span>
    <span class="na">monitoring</span><span class="p">::</span><span class="k">service</span> <span class="p">{</span> <span class="s">'scap_http'</span><span class="p">:</span>
        <span class="na">command</span> <span class="o">=></span> <span class="s">"check_http!${server_name}!/"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>For the docker building environment, you will probably want to set up a specific profile, and then set one up for the docker deployment environment. The latter actually depends on the former in order to work. Assuming we already have a docker module that helps set install docker and set it up on a server, and that we have a kubernetes module that has a class for installing the cli tools, we can first create a profile for the build environment:</p><div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">class</span> <span class="na">profile</span><span class="p">::</span><span class="na">docker</span><span class="p">::</span><span class="na">builder</span><span class="p">(</span>
    <span class="nv">$proxy_address</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="s">'profile::docker::builder::proxy_address'</span><span class="p">),</span>
    <span class="nv">$proxy_port</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="s">'profile::docker::builder::proxy_port'</span><span class="p">),</span>
    <span class="nv">$registry</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="s">'docker_registry'</span><span class="p">),</span><span class="c"> # this is a global variable again</span>
<span class="p">){</span><span class="c">  </span>
<span class="c">    # Let's suppose we have a simple class setting up docker, with no params</span>
<span class="c">    # to override in this case</span>
    <span class="k">class</span> <span class="p">{</span> <span class="s">'docker'</span><span class="p">:</span>
    <span class="p">}</span><span class="c"></span>

<span class="c">    # We will need docker baseimages</span>
    <span class="k">class</span> <span class="p">{</span> <span class="s">'docker::baseimages'</span><span class="p">:</span>
        <span class="na">docker_registry</span> <span class="o">=></span> <span class="nv">$registry,</span>
        <span class="na">proxy_address</span>   <span class="o">=></span> <span class="nv">$proxy_address,</span>
        <span class="na">proxy_port</span>      <span class="o">=></span> <span class="nv">$proxy_port,</span>
        <span class="na">distributions</span>   <span class="o">=></span> <span class="p">[</span><span class="s">'jessie'</span><span class="p">],</span>
    <span class="p">}</span><span class="c"></span>

<span class="c">    # we will need some build scripts; they belong here</span>
    <span class="k">file</span> <span class="p">{</span> <span class="s">'/usr/local/bin/build-in-docker'</span><span class="p">:</span>
        <span class="na">source</span> <span class="o">=></span> <span class="s">'puppet:///modules/profile/docker/builder/build-in-docker.sh'</span><span class="p">,</span>
        <span class="err">...</span>
    <span class="p">}</span>
    <span class="err">...</span><span class="c"></span>
<span class="c">    # Monitoring goes here, not in the docker class</span>
    <span class="na">nrpe</span><span class="p">::</span><span class="na">monitor_systemd_unit_state</span> <span class="p">{</span> <span class="s">'docker-engine'</span><span class="p">:</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>and then the deployment profile will need to add credentials for the docker registry for uploading, the kubernetes cli tools, and a deploy script. It can't work if the profile::docker::builder::profile is not included, though</p><div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">class</span> <span class="na">profile</span><span class="p">::</span><span class="na">docker</span><span class="p">::</span><span class="na">deployment_server</span> <span class="p">(</span>
    <span class="nv">$registry</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="s">'docker_registry'</span><span class="p">)</span>
    <span class="nv">$registry_credentials</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="s">'profile::docker::registry_credentials'</span><span class="p">),</span>
<span class="p">)</span> <span class="p">{</span><span class="c"></span>
<span class="c">    # Require a profile needed by this one</span>
    <span class="na">require</span> <span class="p">::</span><span class="na">profile</span><span class="p">::</span><span class="na">docker</span><span class="p">::</span><span class="na">builder</span><span class="c"></span>
<span class="c">    # auth config</span>
    <span class="k">file</span> <span class="p">{</span> <span class="s">'/root/.docker/config.json'</span><span class="p">:</span>
    <span class="err">...</span>
    <span class="p">}</span>
    <span class="k">class</span> <span class="p">{</span> <span class="s">'kubernetes::cli'</span><span class="p">:</span>
    <span class="p">}</span><span class="c"></span>
<span class="c">    # Kubernetes-based deployment script</span>
    <span class="na">require_package</span><span class="p">(</span><span class="s">'kubernetes-deploy'</span><span class="p">)</span>
<span class="p">}</span>
</pre></div><p>Then the role class for the whole deployment server will just include the relevant profiles:</p><div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">class</span> <span class="k">role</span><span class="p">::</span><span class="na">deployment_server</span> <span class="p">{</span>
    <span class="na">system</span><span class="p">::</span><span class="k">role</span> <span class="p">{</span> <span class="s">'role::deployment_server'</span><span class="p">:</span>
        <span class="na">description</span> <span class="o">=></span> <span class="s">'Deployment server for production.'</span>
    <span class="p">}</span><span class="c"></span>
<span class="c">    # Standard is a profile, to all effects</span>
    <span class="k">include</span> <span class="na">standard</span>
    <span class="k">include</span> <span class="na">profile</span><span class="p">::</span><span class="na">scap3</span><span class="p">::</span><span class="na">master</span>
    <span class="k">include</span> <span class="na">profile</span><span class="p">::</span><span class="na">docker</span><span class="p">::</span><span class="na">deployment_server</span>
<span class="p">}</span>
</pre></div><p>and in site.pp</p><div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">node</span> <span class="o">/</span><span class="na">deployment</span><span class="err">.</span><span class="o">*/</span> <span class="p">{</span>
    <span class="k">role</span><span class="p">(</span><span class="s">'deployment_server'</span><span class="p">)</span>
<span class="p">}</span>
</pre></div><p>Configuration will be done via hiera; most of the definitions will go into the role hierarchy, so in this case:
<b>hieradata/role/common/deployment_server.yaml</b></p><div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="na">profile</span><span class="p">::</span><span class="na">scap3</span><span class="p">::</span><span class="na">master</span><span class="p">::</span><span class="na">server_name</span><span class="p">:</span> <span class="s">"deployment.%{::site}.wmnet"</span><span class="c"></span>
<span class="c"># This could be shared with other roles and thus defined in a common hierarchy in some cases.</span>
<span class="na">profile</span><span class="p">::</span><span class="na">scap3</span><span class="p">::</span><span class="na">base_config</span><span class="p">:</span>
    <span class="na">use_proxies</span><span class="p">:</span> <span class="na">yes</span>
    <span class="na">deployment_dir</span><span class="p">:</span> <span class="s">"/srv"</span> 
<span class="na">profile</span><span class="p">::</span><span class="na">scap3</span><span class="p">::</span><span class="na">master</span><span class="p">::</span><span class="na">max_post_size</span><span class="p">:</span> <span class="s">"100M"</span>
<span class="na">profile</span><span class="p">::</span><span class="na">docker</span><span class="p">::</span><span class="na">builder</span><span class="p">::</span><span class="na">proxy_address</span><span class="p">:</span> <span class="s">'http://webproxy.eqiad.wmnet:3128'</span>
<span class="err">...</span>
</pre></div><p>some other definitions are global, and they might go in the common hierarchy, so:
<b>hieradata/common.yaml</b></p><div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="na">docker_registry</span><span class="p">:</span> <span class="s">'https://registry.wikimedia.org'</span>
<span class="na">mediawiki_scap_proxies</span><span class="p">:</span>
    <span class="o">-</span> <span class="na">mw1121</span><span class="err">.</span><span class="na">eqiad</span><span class="err">.</span><span class="na">wmnet</span>
    <span class="o">-</span> <span class="na">mw2212</span><span class="err">.</span><span class="na">eqiad</span><span class="err">.</span><span class="na">wmnet</span>
</pre></div><p>while others can be shared between multiple profiles (in this case, note the 'private' prefix as this is supposed to be a secret)
<b>hieradata/private/common/profile/docker.yaml</b></p><div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="na">profile</span><span class="p">::</span><span class="na">docker</span><span class="p">::</span><span class="na">registry_credentials</span><span class="p">:</span> <span class="s">"some_secret"</span>
</pre></div>
<h3><span class="mw-headline" id="When_should_a_profile_include_another_profile" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-When_should_a_profile_include_another_profile-Organization&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-When_should_a_profile_include_another_profile-Organization"></span>When should a profile include another profile<span data-mw-comment-end="h-When_should_a_profile_include_another_profile-Organization"></span></span></h3>
<p>There has been some confusion regarding one of the rules in the style guide, specifically the one about profiles requiring each other.
</p><p>The point of underlining that profiles should mostly not include other profiles is that we don't want to create fat profiles that devoid roles of their "composition of functionality" function.
</p><p>Let's make a simple example: we want to install a python application (ORES) that needs to use a redis database. One might be tempted to do
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">class</span> <span class="na">profile</span><span class="p">::</span><span class="na">ores</span> <span class="p">{</span><span class="c"></span>
<span class="c">   # ores needs redis on localhost</span>
   <span class="na">require</span> <span class="na">profile</span><span class="p">::</span><span class="na">redis</span>
   <span class="k">class</span> <span class="p">{</span><span class="s">'ores'</span><span class="p">:</span> <span class="p">}</span>
   <span class="err">...</span>
<span class="p">}</span>

<span class="k">class</span> <span class="k">role</span><span class="p">::</span><span class="na">ores</span> <span class="p">{</span>
  <span class="k">include</span> <span class="na">profile</span><span class="p">::</span><span class="na">ores</span>
<span class="p">}</span>
</pre></div>
<p>This is what we want to prevent. The application can work just fine with a remote redis, so the profile doesn't really <i>require</i> the redis one. The code above should instead be something like
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">class</span> <span class="na">profile</span><span class="p">::</span><span class="na">ores</span><span class="p">(</span><span class="nv">$redis_dsn</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="err">...</span><span class="p">))</span> <span class="p">{</span>
   <span class="k">class</span> <span class="p">{</span><span class="s">'ores'</span><span class="p">:</span> <span class="na">redis_dsn</span> <span class="o">=></span> <span class="nv">$redis_dsn}</span>
   <span class="err">...</span>
<span class="p">}</span><span class="c"></span>

<span class="c"># Role that installs ores and a local redis cache</span>
<span class="k">class</span> <span class="k">role</span><span class="p">::</span><span class="na">ores</span> <span class="p">{</span>
  <span class="k">include</span> <span class="na">profile</span><span class="p">::</span><span class="na">redis</span>
  <span class="k">include</span> <span class="na">profile</span><span class="p">::</span><span class="na">ores</span>
<span class="p">}</span>
</pre></div>
<p>The advantage is clear: you will be able to also define a different role where redis is reached on a remote machine, without having to rewrite all of your classes. Also, your role clearly states what's installed on your server.
</p><p>Now, let's say our python application needs an UWSGI server to be installed, and we already have a working `profile::uwsgi`. ORES would not work unless this profile is included too.
</p><p>In this case, you <b>are not only allowed, but encouraged</b> to mark that dependency clearly:
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">class</span> <span class="na">profile</span><span class="p">::</span><span class="na">ores</span><span class="p">(</span><span class="nv">$redis_dsn</span> <span class="o">=</span> <span class="na">lookup</span><span class="p">(</span><span class="err">...</span><span class="p">))</span> <span class="p">{</span>
   <span class="na">require</span> <span class="na">profile</span><span class="p">::</span><span class="na">uwsgi</span>
   <span class="k">class</span> <span class="p">{</span><span class="s">'ores'</span><span class="p">:</span> <span class="na">redis_dsn</span> <span class="o">=></span> <span class="nv">$redis_dsn}</span>
   <span class="err">...</span>
<span class="p">}</span><span class="c"></span>

<span class="c"># Role that installs ores and a local redis cache</span>
<span class="k">class</span> <span class="k">role</span><span class="p">::</span><span class="na">ores</span> <span class="p">{</span>
  <span class="k">include</span> <span class="na">profile</span><span class="p">::</span><span class="na">redis</span>
  <span class="k">include</span> <span class="na">profile</span><span class="p">::</span><span class="na">ores</span>
<span class="p">}</span>
</pre></div>
<p>Please note that, if you want it to be easy to see that profile::uwsgi is included in the role, you can still add it explicitly to `role::ores`. But `profile::ores` will still need to add the `require` keyword.
</p>
<h3><span class="mw-headline" id="WMF_Design_conventions" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-WMF_Design_conventions-Organization&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-WMF_Design_conventions-Organization"></span>WMF Design conventions<span data-mw-comment-end="h-WMF_Design_conventions-Organization"></span></span></h3>
<ul><li><b>Always</b> include the 'base' class for every node (note that <i>standard</i> includes <i>base</i> and should be used in most cases)</li></ul>
<ul><li>For every service deployed, please use a <tt>system::role</tt> definition (defined in <tt>modules/system/manifests/role.pp</tt>) to indicate what a server is running. This will be put in the MOTD. As the definition name, you should normally use the relevant puppet class. For example:</li></ul>
<pre>system::role { "role::cache::bits": description => "bits Varnish cache server" }
</pre>
<ul><li>Files that are fully deployed by Puppet using the <i>file</i> type, should generally use a read-only file mode (i.e., <b>0444</b> or <b>0555</b>). This makes it more obvious that this file should not be modified, as Puppet will overwrite it anyway.</li>
<li>For each service, create a nested class with the name <code>profile::<i>service</i>::monitoring</code> (e.g. <i>profile::squid::monitoring</i>) which sets up any required (Nagios) monitoring configuration on the monitoring server.</li>
<li>Any top-level class definitions should be documented with descriptive header, like this:</li></ul>
<pre> # Mediawiki_singlnode: A one-step class for setting up a single-node MediaWiki install,
 #  running from a Git tree.
 #
 #  Roles can insert additional lines into LocalSettings.php via the
 #  $role_requires and $role_config_lines vars.
 #  etc.
</pre>
<p>Such descriptions are especially important for role classes.  Comments like these are used to generate our <a class="external text" href="https://doc.wikimedia.org/puppet/">online puppet documentation</a>.
</p>
<h2><span class="mw-headline" id="Coding_Style" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Coding_Style&quot;,&quot;replies&quot;:[&quot;h-format-Coding_Style&quot;,&quot;h-Useful_global_variables-Coding_Style&quot;],&quot;headingLevel&quot;:2,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Coding_Style"></span>Coding Style<span data-mw-comment-end="h-Coding_Style"></span></span></h2>
<p>Please read the <a rel="nofollow" class="external text" href="https://puppet.com/docs/puppet/latest/style_guide.html">upstream style-guide</a>. And install <a href="/wiki/Puppet_coding#Lint" title="Puppet coding">puppet-lint</a>.
</p><p>
Our codebase is only compatible with Puppet 4.5 and above. Use of puppet 4.x constructs like loops, new functions, and in particular parameter types are strongly encouraged. See the slides linked here for more details. </p><figure class="mw-default-size" typeof="mw:Image/Thumb"><a href="/wiki/File:Puppet_4_-_An_introduction.pdf" class="mw-file-description"><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/33/Puppet_4_-_An_introduction.pdf/page1-220px-Puppet_4_-_An_introduction.pdf.jpg" decoding="async" width="220" height="124" srcset="https://upload.wikimedia.org/wikipedia/commons/thumb/3/33/Puppet_4_-_An_introduction.pdf/page1-330px-Puppet_4_-_An_introduction.pdf.jpg 1.5x, https://upload.wikimedia.org/wikipedia/commons/thumb/3/33/Puppet_4_-_An_introduction.pdf/page1-440px-Puppet_4_-_An_introduction.pdf.jpg 2x" data-file-width="1500" data-file-height="843"/></a><figcaption>The slideset for a short presentation about the new things in recent versions of the  puppet language.</figcaption></figure>
<h3><span class="mw-headline" id="format" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-format-Coding_Style&quot;,&quot;replies&quot;:[&quot;h-Spacing,_Indentation,_&amp;_Whitespace-format&quot;,&quot;h-Quoting-format&quot;,&quot;h-Resources-format&quot;,&quot;h-Conditionals-format&quot;,&quot;h-Classes-format&quot;,&quot;h-Including-format&quot;],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-format-Coding_Style"></span>format<span data-mw-comment-end="h-format-Coding_Style"></span></span></h3>
<p>Many existing manifests use two-spaces (as suggested in the style guide) instead of our 4 space indent standard; when working on existing code always follow the existing whitespace style of the file or module you are editing. Please do not mix cleanup changes with functional changes in a single patch.
</p>
<h4><span id="Spacing.2C_Indentation.2C_.26_Whitespace"></span><span class="mw-headline" id="Spacing,_Indentation,_&amp;_Whitespace" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Spacing,_Indentation,_&amp;_Whitespace-format&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Spacing,_Indentation,_&amp;_Whitespace-format"></span>Spacing, Indentation, &amp; Whitespace<span data-mw-comment-end="h-Spacing,_Indentation,_&amp;_Whitespace-format"></span></span></h4>
<ul><li>Must use four-space soft tabs.</li>
<li>Must not use literal tab characters.</li>
<li>Must not contain trailing white space</li>
<li>Must align fat comma arrows (=>) within blocks of attributes.</li></ul>
<h4><span class="mw-headline" id="Quoting" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Quoting-format&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Quoting-format"></span>Quoting<span data-mw-comment-end="h-Quoting-format"></span></span></h4>
<ul><li>Must use single quotes unless interpolating variables.</li>
<li>All variables should be enclosed in in braces ({}) when being interpolated in a string. <a rel="nofollow" class="external text" href="http://puppet-lint.com/checks/variables_not_enclosed/">like this</a></li>
<li>Variables standing by themselves should not be quoted.<a rel="nofollow" class="external text" href="http://puppet-lint.com/checks/only_variable_string/">like this</a></li>
<li>Must not quote booleans: <b><tt>true</tt></b> is ok, but not <b><tt>'true'</tt></b> or <b><tt>"true"</tt></b></li></ul>
<h4><span class="mw-headline" id="Resources" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Resources-format&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Resources-format"></span>Resources<span data-mw-comment-end="h-Resources-format"></span></span></h4>
<ul><li>Must single quote all resource names and their attribute, except ensure. (unless they contain a variable, of course).</li>
<li>Ensure must always be the first attribute.</li>
<li>Put a trailing comma after the final resource parameter.</li>
<li>Again: Must align fat comma arrows (=>) within blocks of attributes.</li>
<li>Don't group resources of the same type (a.k.a compression) :</li></ul>
<p>do
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">file</span> <span class="p">{</span> <span class="s">'/etc/default/exim4'</span><span class="p">:</span>
    <span class="na">require</span> <span class="o">=></span> <span class="k">Package</span><span class="p">[</span><span class="s">'exim4-config'</span><span class="p">],</span>
    <span class="na">owner</span>   <span class="o">=></span> <span class="s">'root'</span><span class="p">,</span>
    <span class="na">group</span>   <span class="o">=></span> <span class="s">'root'</span><span class="p">,</span>
    <span class="na">mode</span>    <span class="o">=></span> <span class="s">'0444'</span><span class="p">,</span>
    <span class="na">content</span> <span class="o">=></span> <span class="k">template</span><span class="p">(</span><span class="s">'exim/exim4.default.erb'</span><span class="p">),</span>
<span class="p">}</span>
<span class="k">file</span> <span class="p">{</span> <span class="s">'/etc/exim4/aliases/'</span><span class="p">:</span>
    <span class="na">ensure</span>  <span class="o">=></span> <span class="k">directory</span><span class="p">,</span>
    <span class="na">require</span> <span class="o">=></span> <span class="k">Package</span><span class="p">[</span><span class="s">'exim4-config'</span><span class="p">],</span>
    <span class="na">mode</span>    <span class="o">=></span> <span class="s">'0755'</span><span class="p">,</span>
    <span class="na">owner</span>   <span class="o">=></span> <span class="s">'root'</span><span class="p">,</span>
    <span class="na">group</span>   <span class="o">=></span> <span class="s">'root'</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
<p>don't do
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">file</span> <span class="p">{</span> <span class="s">'/etc/default/exim4'</span><span class="p">:</span>
    <span class="na">require</span> <span class="o">=></span> <span class="k">Package</span><span class="p">[</span><span class="s">'exim4-config'</span><span class="p">],</span>
    <span class="na">owner</span>   <span class="o">=></span> <span class="s">'root'</span><span class="p">,</span> 
    <span class="na">group</span>   <span class="o">=></span> <span class="s">'root'</span><span class="p">,</span> 
    <span class="na">mode</span>    <span class="o">=></span> <span class="s">'0444'</span><span class="p">,</span> 
    <span class="na">content</span> <span class="o">=></span> <span class="k">template</span><span class="p">(</span><span class="s">'exim/exim4.default.erb'</span><span class="p">);</span>
<span class="s">'/etc/exim4/aliases/'</span><span class="p">:</span>
    <span class="na">ensure</span>  <span class="o">=></span> <span class="k">directory</span><span class="p">,</span>
    <span class="na">require</span> <span class="o">=></span> <span class="k">Package</span><span class="p">[</span><span class="s">'exim4-config'</span><span class="p">],</span>
    <span class="na">mode</span>    <span class="o">=></span> <span class="s">'0755'</span><span class="p">,</span> 
    <span class="na">owner</span>   <span class="o">=></span> <span class="s">'root'</span><span class="p">,</span> 
    <span class="na">group</span>   <span class="o">=></span> <span class="s">'root'</span><span class="p">,</span> 
<span class="p">}</span>
</pre></div>
<ul><li>keep the resource name and the resource type on the same line. No need for extra indentation.</li></ul>
<h4><span class="mw-headline" id="Conditionals" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Conditionals-format&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Conditionals-format"></span>Conditionals<span data-mw-comment-end="h-Conditionals-format"></span></span></h4>
<ul><li>Don't use selectors inside resources:</li></ul>
<p>good:
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="nv">$file_mode</span> <span class="o">=</span> <span class="nv">$facts['os']</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">?</span> <span class="p">{</span>
    <span class="na">debian</span> <span class="o">=></span> <span class="s">'0007'</span><span class="p">,</span>
    <span class="na">redhat</span> <span class="o">=></span> <span class="s">'0776'</span><span class="p">,</span>
    <span class="na">fedora</span> <span class="o">=></span> <span class="s">'0007'</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">file</span> <span class="p">{</span> <span class="s">'/tmp/readme.txt'</span><span class="p">:</span>
    <span class="na">content</span> <span class="o">=></span> <span class="s">"Hello World\n"</span><span class="p">,</span>
    <span class="na">mode</span>    <span class="o">=></span> <span class="nv">$file_mode,</span>
<span class="p">}</span>
</pre></div>
<p>bad:
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">file</span> <span class="p">{</span> <span class="s">'/tmp/readme.txt'</span><span class="p">:</span>
    <span class="na">mode</span> <span class="o">=></span> <span class="nv">$facts['os']</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">?</span> <span class="p">{</span>
        <span class="na">debian</span> <span class="o">=></span> <span class="s">'0777'</span><span class="p">,</span>
        <span class="na">redhat</span> <span class="o">=></span> <span class="s">'0776'</span><span class="p">,</span>
        <span class="na">fedora</span> <span class="o">=></span> <span class="s">'0007'</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<ul><li>Case statements should have default cases. <a rel="nofollow" class="external text" href="http://puppet-lint.com/checks/case_without_default/">like this</a>.</li></ul>
<h4><span class="mw-headline" id="Classes" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Classes-format&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Classes-format"></span>Classes<span data-mw-comment-end="h-Classes-format"></span></span></h4>
<p>All classes and resource type definitions must be in separate files in the manifests directory of their module. 
</p>
<ul><li>Do not nest classes.</li>
<li>NEVER EVER use inheritance, puppet is not good at that. Also, inheritance will make your life harder when you need to use hiera - really, don't.</li>
<li>When refering to facts try prefer to use the facts hash to distinguish them from Global variables:</li></ul>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="c"># good</span>
<span class="nv">$facts</span><span class="p">[</span><span class="s">'fqdn'</span><span class="p">]</span><span class="c"></span>
<span class="c"># bad</span>
<span class="nv">$::fqdn</span>
</pre></div>
<ul><li>when referring to global variables always refer to them with them as fully qualified variables</li></ul>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="c"># good</span>
<span class="nv">$::site</span><span class="c"></span>
<span class="c"># bad</span>
<span class="nv">$site</span>
</pre></div>
<ul><li>Do not use dashes in class names, preferably use alphabetic names only.</li>
<li>In parameterized class and defined resource type declarations, parameters that are required should be listed before optional parameters. <a rel="nofollow" class="external text" href="http://puppet-lint.com/checks/parameter_order/">like this</a>.</li>
<li>It is in general better to avoid parameters that don't have a default; that will only make your life harder as you need to define that variable for every host that includes it.</li></ul>
<h4><span class="mw-headline" id="Including" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Including-format&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Including-format"></span>Including<span data-mw-comment-end="h-Including-format"></span></span></h4>
<ul><li>One include per line.</li>
<li>One class per include.</li>
<li>Include only the class you need, not the entire scope.</li></ul>
<h3><span class="mw-headline" id="Useful_global_variables" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Useful_global_variables-Coding_Style&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Useful_global_variables-Coding_Style"></span>Useful global variables<span data-mw-comment-end="h-Useful_global_variables-Coding_Style"></span></span></h3>
<p>These are useful variables you can refer to from anywhere in the Puppet manifests. Most of these get defined in <tt>realm.pp</tt> or <tt>base.pp</tt>.
</p>
<dl><dt><code>$::realm</code></dt>
<dd>The "realm" the system belongs to. As of July 2021 we have the realms <b>production</b>, or <b>labs</b>.</dd>
<dt><code>$::site</code></dt>
<dd>Contains the 5-letter site name of the server, e.g. "<a href="/wiki/Eqiad" class="mw-redirect" title="Eqiad">eqiad</a>", "<a href="/wiki/Codfw" class="mw-redirect" title="Codfw">codfw</a>", "<a href="/wiki/Esams" class="mw-redirect" title="Esams">esams</a>", "<a href="/wiki/Ulsfo" class="mw-redirect" title="Ulsfo">ulsfo</a>" or "<a href="/wiki/Eqsin" class="mw-redirect" title="Eqsin">eqsin</a>".</dd></dl>
<h2><span class="mw-headline" id="Testing_a_patch" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Testing_a_patch&quot;,&quot;replies&quot;:[&quot;h-Parser_validation-Testing_a_patch&quot;,&quot;h-Lint-Testing_a_patch&quot;,&quot;h-on_Debian\/Ubuntu-Testing_a_patch&quot;,&quot;h-How_to_use-Testing_a_patch&quot;,&quot;h-Ignoring_lint_warnings_and_errors-Testing_a_patch&quot;,&quot;h-Find_out_which_warnings\/errors_are_currently_ignored-Testing_a_patch&quot;,&quot;h-Cloud_VPS_testing-Testing_a_patch&quot;,&quot;h-catalog_compilation-Testing_a_patch&quot;,&quot;h-Manual_module_testing-Testing_a_patch&quot;,&quot;h-Unit_Testing_modules-Testing_a_patch&quot;],&quot;headingLevel&quot;:2,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Testing_a_patch"></span>Testing a patch<span data-mw-comment-end="h-Testing_a_patch"></span></span></h2>
<p>Before submitting a patch and have Jenkins downvote you, you can do it yourself. After committing changes you can run 
</p>
<pre> $ rbenv exec bundle exec rake test
</pre>
<p>And if you want to run something closer to the CI environment, you can run the script (from the root of the repo, uses docker):
</p>
<pre> $ ./utils/run_ci_locally.sh
</pre>
<p>You should get a <tt>congratulations :)</tt> message
</p>
<h4><span class="mw-headline" id="Parser_validation" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Parser_validation-Testing_a_patch&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Parser_validation-Testing_a_patch"></span>Parser validation<span data-mw-comment-end="h-Parser_validation-Testing_a_patch"></span></span></h4>
<p>You can syntax check your changes by
</p>
<pre># rbenv exec puppet parser validate filename-here
</pre>
<h4><span class="mw-headline" id="Lint" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Lint-Testing_a_patch&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Lint-Testing_a_patch"></span>Lint<span data-mw-comment-end="h-Lint-Testing_a_patch"></span></span></h4>
<p>You can locally install <a rel="nofollow" class="external text" href="http://puppet-lint.com/">puppet-lint</a> and use it to check your code before submitting, or enhance existing code by fixing puppet-lint errors/warnings.
<a rel="nofollow" class="external text" href="https://github.com/rodjek/puppet-lint">puppet-lint on github</a>
</p>
<h4><span id="on_Debian.2FUbuntu"></span><span class="mw-headline" id="on_Debian/Ubuntu" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-on_Debian\/Ubuntu-Testing_a_patch&quot;,&quot;replies&quot;:[&quot;h-on_Mac_OS_X-on_Debian\/Ubuntu&quot;,&quot;h-generic_(Ruby_gem)-on_Debian\/Ubuntu&quot;],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-on_Debian/Ubuntu-Testing_a_patch"></span>on Debian/Ubuntu<span data-mw-comment-end="h-on_Debian/Ubuntu-Testing_a_patch"></span></span></h4>
<pre>apt-get install puppet-lint  <a rel="nofollow" class="external autonumber" href="https://launchpad.net/ubuntu/+source/puppet-lint">[1]</a>, <a rel="nofollow" class="external autonumber" href="http://packages.debian.org/search?keywords=puppet-lint">[2]</a>
</pre>
<h5><span class="mw-headline" id="on_Mac_OS_X" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-on_Mac_OS_X-on_Debian\/Ubuntu&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-on_Mac_OS_X-on_Debian/Ubuntu"></span>on Mac OS X<span data-mw-comment-end="h-on_Mac_OS_X-on_Debian/Ubuntu"></span></span></h5>
<pre>sudo gem install puppet-lint
</pre>
<h5><span id="generic_.28Ruby_gem.29"></span><span class="mw-headline" id="generic_(Ruby_gem)" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-generic_(Ruby_gem)-on_Debian\/Ubuntu&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-generic_(Ruby_gem)-on_Debian/Ubuntu"></span>generic (Ruby gem)<span data-mw-comment-end="h-generic_(Ruby_gem)-on_Debian/Ubuntu"></span></span></h5>
<pre>gem install puppet-lint
</pre>
<h4><span class="mw-headline" id="How_to_use" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-How_to_use-Testing_a_patch&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-How_to_use-Testing_a_patch"></span>How to use<span data-mw-comment-end="h-How_to_use-Testing_a_patch"></span></span></h4>
<pre>puppet-lint manifest.pp
</pre>
<p>or
</p>
<pre>puppet-lint --with-filename /etc/puppet/modules
</pre>
<h4><span class="mw-headline" id="Ignoring_lint_warnings_and_errors" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Ignoring_lint_warnings_and_errors-Testing_a_patch&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Ignoring_lint_warnings_and_errors-Testing_a_patch"></span>Ignoring lint warnings and errors<span data-mw-comment-end="h-Ignoring_lint_warnings_and_errors-Testing_a_patch"></span></span></h4>
<p>If you want you can always ignore specific warnings/errors by surrounding the relevant lines with a special "lint::ignore"-comment. For example, this would ignore "WARNING: top-scope variable being used without an explicit namespace" on line 54.
</p>
<pre> 53         # lint:ignore:variable_scope
 54         default     => $fqdn
 55         # lint:endignore
</pre>
<p>You can get all the names of the separate checks with <b>puppet-lint --help</b>. More info is on <a rel="nofollow" class="external free" href="http://puppet-lint.com/controlcomments/">http://puppet-lint.com/controlcomments/</a>
</p>
<h4><span id="Find_out_which_warnings.2Ferrors_are_currently_ignored"></span><span class="mw-headline" id="Find_out_which_warnings/errors_are_currently_ignored" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Find_out_which_warnings\/errors_are_currently_ignored-Testing_a_patch&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Find_out_which_warnings/errors_are_currently_ignored-Testing_a_patch"></span>Find out which warnings/errors are currently ignored<span data-mw-comment-end="h-Find_out_which_warnings/errors_are_currently_ignored-Testing_a_patch"></span></span></h4>
<p>There are 2 parts to this. The first is to check the global .puppet-lint.rc file in the root of the puppet repo. You will see that the following 4 checks are currently ignored globally:
</p>
<ul><li>--no-80-chars-check (This is about the lines over 80 chars, we are not planning to remove this exception)</li>
<li>--no-autoloader_layout-check (This is about moving all remaining class out of manifests/role/ and <a class="external free" href="https://phabricator.wikimedia.org/T119042">https://phabricator.wikimedia.org/T119042</a> we want this fixed)</li>
<li>--no-puppet-url_without_modules-check (Yes, we want this fixed)</li>
<li>--no-documentation-check (<a class="external free" href="https://phabricator.wikimedia.org/T127797">https://phabricator.wikimedia.org/T127797</a>)</li></ul>
<p>The second part is checking for individual ignores, find these with a <b>grep -r "lint:ignore" *</b> in the root of the puppet repo. You can help by fixing and removing any of these remaining issues.
</p><p>The tracking task for getting this to perfection is <a class="external free" href="https://phabricator.wikimedia.org/T93645">https://phabricator.wikimedia.org/T93645</a>.
</p>
<h3><span class="mw-headline" id="Cloud_VPS_testing" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Cloud_VPS_testing-Testing_a_patch&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Cloud_VPS_testing-Testing_a_patch"></span><a href="/wiki/Portal:Wikimedia_VPS" class="mw-redirect" title="Portal:Wikimedia VPS">Cloud VPS</a> testing<span data-mw-comment-end="h-Cloud_VPS_testing-Testing_a_patch"></span></span></h3>
<p>Nontrivial puppet changes should be applied to a Cloud VPS instance before being merged into production.  This can uncover some behaviors and code interactions that don't appear during individual file tests -- for example, puppet runs frequently fail due to duplicate resource definitions that aren't obvious to the naked eye.
</p><p>To test a puppet patch:
</p><p>1. Create a <a href="/wiki/Help:Standalone_puppetmaster" title="Help:Standalone puppetmaster">standalone puppetmaster</a>  instance.
</p><p>2. Configure that instance so that it defines the class you're working on.  You can do this either via the 'configure instance' page or by editing /var/lib/git/operations/puppet/manifests/site.pp to contain something like this:
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span>    <span class="k">node</span> <span class="na">this</span><span class="o">-</span><span class="na">is</span><span class="o">-</span><span class="na">my</span><span class="o">-</span><span class="na">hostname</span> <span class="p">{</span>
        <span class="k">include</span> <span class="k">class</span><span class="p">::</span><span class="na">I</span><span class="p">::</span><span class="na">am</span><span class="p">::</span><span class="na">working</span><span class="p">::</span><span class="na">on</span>
    <span class="p">}</span>
</pre></div>
<p>3. Run puppet a couple of times ('$ sudo puppetd -tv') until each subsequent puppet run is clean doesn't modify anything
</p><p>4. Apply your patch to /var/lib/git/operations/puppet.  Do this by cherry-picking from gerrit or by rsyncing from a local working directory.
</p><p>5. Run puppet again, and note the changes that this puppet run makes.  Does puppet succeed?  Are the changes what you expected?
</p><p><br/>
</p>
<h3><span class="mw-headline" id="catalog_compilation" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-catalog_compilation-Testing_a_patch&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-catalog_compilation-Testing_a_patch"></span>catalog compilation<span data-mw-comment-end="h-catalog_compilation-Testing_a_patch"></span></span></h3>
<p>You can compile the puppet catalog and see a diff and have a preview of warnings/errors.
</p><p>There are several ways of doing this (Jekins, local, etc). See main article: <a href="/wiki/Help:Puppet-compiler" title="Help:Puppet-compiler"> puppet-compiler</a>.
</p>
<h3><span class="mw-headline" id="Manual_module_testing" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Manual_module_testing-Testing_a_patch&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Manual_module_testing-Testing_a_patch"></span>Manual module testing<span data-mw-comment-end="h-Manual_module_testing-Testing_a_patch"></span></span></h3>
<p>A relatively simple and crude testing way is
</p>
<pre>puppet apply --noop --modulepath /path/to/modules &lt;manifest>.pp
</pre>
<p>Do note however that this might not work if you reference stuff outside of the module hierarchy
</p><p>You can get around the missing module hierarchy problem by cloning a local copy of the puppet repo and symlinking in your new module directory.
</p><p>eg.
</p>
<pre>git clone --branch production https://gerrit.wikimedia.org/r/operations/puppet.git
cd puppet/modules
ln -s /path/to/mymodule .
puppet apply --verbose --noop --modulepath=/home/${USER}/puppet/modules /path/to/mymodule/manifest/init.pp
</pre>
<h3><span class="mw-headline" id="Unit_Testing_modules" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Unit_Testing_modules-Testing_a_patch&quot;,&quot;replies&quot;:[&quot;h-Rake_tests-Unit_Testing_modules&quot;,&quot;h-Custom_tests-Unit_Testing_modules&quot;,&quot;h-Common_errors-Unit_Testing_modules&quot;],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Unit_Testing_modules-Testing_a_patch"></span>Unit Testing modules<span data-mw-comment-end="h-Unit_Testing_modules-Testing_a_patch"></span></span></h3>
<h4><span class="mw-headline" id="Rake_tests" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Rake_tests-Unit_Testing_modules&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Rake_tests-Unit_Testing_modules"></span>Rake tests<span data-mw-comment-end="h-Rake_tests-Unit_Testing_modules"></span></span></h4>
<p>Some modules have unit tests already written -- the other modules still need them!  Modules with tests have 'rakefile' in their top dir, and a subdir called 'spec'.
</p><p>Modules imported from upstream typically have tests that run against other upstream modules -- we, however, seek to have tests pass when running only against our own repository.  In order to set that up you'll need to run
</p>
<pre> $ rake spec
</pre>
<p>once in the top level directory to get things set up properly.  After that you can test individual modules by running
</p>
<pre> $ rake spec_standalone
</pre>
<p>in specific module subdirs.
</p><p>If you want to compare your results with the test results on our official testing box, check out this page:  <a class="external free" href="https://integration.wikimedia.org/ci/job/test-puppet-rspec/">https://integration.wikimedia.org/ci/job/test-puppet-rspec/</a>
</p><p><br/>
</p>
<h4><span class="mw-headline" id="Custom_tests" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Custom_tests-Unit_Testing_modules&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Custom_tests-Unit_Testing_modules"></span>Custom tests<span data-mw-comment-end="h-Custom_tests-Unit_Testing_modules"></span></span></h4>
<p>If you are testing a module it makes sense to group these simple tests in a tests/ directory in your modules hierarchy. Your tests can be as simple as 
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="c">#</span>

<span class="k">include</span> <span class="na">myclass</span>
</pre></div>
<p>in a file called <code>myclass.pp</code> in the tests directory. 
</p><p>or a lot more complex, calling parameterized classes and definitions.
</p><p>All this can also be automated by including in the tests directory the following <code>Makefile</code>
</p>
<div class="mw-highlight mw-highlight-lang-make mw-content-ltr" dir="ltr"><pre><span></span><span class="nv">MANIFESTS</span><span class="o">=</span><span class="k">$(</span>wildcard *.pp<span class="k">)</span>
<span class="nv">OBJS</span><span class="o">=</span><span class="k">$(</span>MANIFESTS:.pp<span class="o">=</span>.po<span class="k">)</span>
<span class="nv">TESTS_DIR</span><span class="o">=</span><span class="k">$(</span>dir <span class="k">$(</span>CURDIR<span class="k">))</span>
<span class="nv">MODULE_DIR</span><span class="o">=</span><span class="k">$(</span>TESTS_DIR:/<span class="o">=</span><span class="k">)</span>
<span class="nv">MODULES_DIR</span><span class="o">=</span><span class="k">$(</span>dir <span class="k">$(</span>MODULE_DIR<span class="k">))</span>

<span class="nf">all</span><span class="o">:</span>	<span class="n">test</span>

<span class="nf">test</span><span class="o">:</span>	<span class="k">$(</span><span class="nv">OBJS</span><span class="k">)</span>

<span class="nf">%.po</span><span class="o">:</span>	%.<span class="n">pp</span>
	puppet parser validate $&lt;
	puppet apply --noop --modulepath <span class="k">$(</span>MODULES_DIR<span class="k">)</span> $&lt;
</pre></div>
<p>and running <code>make</code> from the command line (assuming you have make installed)
</p><p>Please note that <code>--noop</code> does not mean that no code will be executed. It means puppet will not change the state of any resource. So at least exec resources' conditionals as well puppet parser functions and facts will execute normally. So don't go around testing untrusted code.
</p>
<h4><span class="mw-headline" id="Common_errors" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Common_errors-Unit_Testing_modules&quot;,&quot;replies&quot;:[&quot;h-tab_character_found_on_line_..-Common_errors&quot;,&quot;h-double_quoted_string_containing_no_variables-Common_errors&quot;,&quot;h-unquoted_file_mode-Common_errors&quot;,&quot;h-line_has_more_than_80_characters-Common_errors&quot;,&quot;h-not_in_autoload_module_layout-Common_errors&quot;,&quot;h-ensure_found_on_line_but_it's_not_the_first_attribute-Common_errors&quot;,&quot;h-unquoted_resource_title-Common_errors&quot;,&quot;h-top-scope_variable_being_used_without_an_explicit_namespace-Common_errors&quot;,&quot;h-class_defined_inside_a_class-Common_errors&quot;,&quot;h-quoted_boolean_value-Common_errors&quot;,&quot;h-case_statement_without_a_default_case-Common_errors&quot;],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Common_errors-Unit_Testing_modules"></span>Common errors<span data-mw-comment-end="h-Common_errors-Unit_Testing_modules"></span></span></h4>
<h5><span class="mw-headline" id="tab_character_found_on_line_.." data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-tab_character_found_on_line_..-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-tab_character_found_on_line_..-Common_errors"></span>tab character found on line ..<span data-mw-comment-end="h-tab_character_found_on_line_..-Common_errors"></span></span></h5>
<p>FIX: do not use tabs, use 4-space soft tabs
</p><p>Have this in your vim config (<code>.vimrc</code>):
</p>
<div class="mw-highlight mw-highlight-lang-vim mw-content-ltr" dir="ltr"><pre><span></span><span class="k">set</span> <span class="nb">tabstop</span><span class="p">=</span><span class="m">4</span>
<span class="k">set</span> <span class="nb">shiftwidth</span><span class="p">=</span><span class="m">4</span>
<span class="k">set</span> <span class="nb">softtabstop</span><span class="p">=</span><span class="m">4</span>
<span class="k">set</span> <span class="nb">smarttab</span>
<span class="k">set</span> <span class="nb">expandtab</span>
</pre></div>
<p>or use something like this (if your local path is ./wmf/puppet/) to apply it to puppet files only.
</p>
<div class="mw-highlight mw-highlight-lang-vim mw-content-ltr" dir="ltr"><pre><span></span><span class="c">" Wikimedia style uses 4 spaces for indentation</span>
autocmd <span class="nb">BufRead</span> *<span class="sr">/wmf/</span>puppet<span class="sr">/**/</span>*.<span class="k">pp</span> <span class="k">set</span> <span class="k">sw</span><span class="p">=</span><span class="m">4</span> <span class="k">ts</span><span class="p">=</span><span class="m">4</span> <span class="nb">et</span>
autocmd <span class="nb">BufNewFile</span> *<span class="sr">/wmf/</span>puppet<span class="sr">/**/</span>*.<span class="k">pp</span> <span class="k">set</span> <span class="k">sw</span><span class="p">=</span><span class="m">4</span> <span class="k">ts</span><span class="p">=</span><span class="m">4</span> <span class="nb">et</span>
</pre></div>
<p>open the file, :retab, :wq, done.  Make sure to review the resulting change carefully before submitting it.
</p><p>Or put this in your emacs config (.emacs)
</p>
<div class="mw-highlight mw-highlight-lang-emacs mw-content-ltr" dir="ltr"><pre><span></span><span class="c1">;; Puppet config with 4 spaces</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">puppet-indent-level</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">puppet-include-indent</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
<h5><span class="mw-headline" id="double_quoted_string_containing_no_variables" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-double_quoted_string_containing_no_variables-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-double_quoted_string_containing_no_variables-Common_errors"></span>double quoted string containing no variables<span data-mw-comment-end="h-double_quoted_string_containing_no_variables-Common_errors"></span></span></h5>
<p>FIX: use single quotes (') for all strings unless there are variables to parse in it
</p>
<h5><span class="mw-headline" id="unquoted_file_mode" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-unquoted_file_mode-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-unquoted_file_mode-Common_errors"></span>unquoted file mode<span data-mw-comment-end="h-unquoted_file_mode-Common_errors"></span></span></h5>
<p>FIX: always quote file modes with single quotes,like:  mode => '0750'
</p>
<h5><span class="mw-headline" id="line_has_more_than_80_characters" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-line_has_more_than_80_characters-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-line_has_more_than_80_characters-Common_errors"></span>line has more than 80 characters<span data-mw-comment-end="h-line_has_more_than_80_characters-Common_errors"></span></span></h5>
<p>FIX: wrap your lines to be less than 80 chars, if you have to, there is \&lt;newline>.
Vim can help when writing. Place this in your .vimrc
</p>
<pre>set textwidth=80
</pre>
<h5><span class="mw-headline" id="not_in_autoload_module_layout" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-not_in_autoload_module_layout-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-not_in_autoload_module_layout-Common_errors"></span>not in autoload module layout<span data-mw-comment-end="h-not_in_autoload_module_layout-Common_errors"></span></span></h5>
<p>FIX: turn your code into a puppet module (<a rel="nofollow" class="external text" href="http://docs.puppetlabs.com/puppet/2.7/reference/modules_fundamentals.html">Module Fundamentals</a>)
</p>
<h5><span id="ensure_found_on_line_but_it.27s_not_the_first_attribute"></span><span class="mw-headline" id="ensure_found_on_line_but_it's_not_the_first_attribute" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-ensure_found_on_line_but_it's_not_the_first_attribute-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-ensure_found_on_line_but_it's_not_the_first_attribute-Common_errors"></span>ensure found on line but it's not the first attribute<span data-mw-comment-end="h-ensure_found_on_line_but_it's_not_the_first_attribute-Common_errors"></span></span></h5>
<p>FIX: move your "ensure =>" to the top of the resource section. (don't forget to turn a ; into a , if it was the last attribute before)
</p>
<h5><span class="mw-headline" id="unquoted_resource_title" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-unquoted_resource_title-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-unquoted_resource_title-Common_errors"></span>unquoted resource title<span data-mw-comment-end="h-unquoted_resource_title-Common_errors"></span></span></h5>
<p>FIX: quote all resource titles, single quotes
</p>
<h5><span class="mw-headline" id="top-scope_variable_being_used_without_an_explicit_namespace" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-top-scope_variable_being_used_without_an_explicit_namespace-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-top-scope_variable_being_used_without_an_explicit_namespace-Common_errors"></span>top-scope variable being used without an explicit namespace<span data-mw-comment-end="h-top-scope_variable_being_used_without_an_explicit_namespace-Common_errors"></span></span></h5>
<p>FIX: use an explicit namespace in variable names (<a rel="nofollow" class="external text" href="http://docs.puppetlabs.com/guides/scope_and_puppet.html">Scope and Puppet</a>)
</p>
<h5><span class="mw-headline" id="class_defined_inside_a_class" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-class_defined_inside_a_class-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-class_defined_inside_a_class-Common_errors"></span>class defined inside a class<span data-mw-comment-end="h-class_defined_inside_a_class-Common_errors"></span></span></h5>
<p>FIX: don't define classes inside classes
</p>
<h5><span class="mw-headline" id="quoted_boolean_value" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-quoted_boolean_value-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-quoted_boolean_value-Common_errors"></span>quoted boolean value<span data-mw-comment-end="h-quoted_boolean_value-Common_errors"></span></span></h5>
<p>FIX: do NOT quote boolean values ( => true/ => false)
</p>
<h5><span class="mw-headline" id="case_statement_without_a_default_case" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-case_statement_without_a_default_case-Common_errors&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:5,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-case_statement_without_a_default_case-Common_errors"></span>case statement without a default case<span data-mw-comment-end="h-case_statement_without_a_default_case-Common_errors"></span></span></h5>
<p>FIX: add a default case to your case statement
</p>
<h2><span class="mw-headline" id="Puppet_modules" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Puppet_modules&quot;,&quot;replies&quot;:[&quot;h-3rd_party_or_upstream_modules-Puppet_modules&quot;],&quot;headingLevel&quot;:2,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Puppet_modules"></span>Puppet modules<span data-mw-comment-end="h-Puppet_modules"></span></span></h2>
<p>There are currently two high level types of modules.  For most things, modules should not contain anything that is specific to the Wikimedia Foundation.  Non WMF specific modules could be useable an other puppet repository at any other organization. A WMF specific module is different: it may contain configurations specific to WMF (duh), but remember that it is still a module, so it must be useable on its own as well. Users of either type of module should be able able to use the module without editing anything inside of the module.  WMF specific modules will probably be higher level abstractions of services that use and depend on other modules, but they may not refer to anything inside of the top level manifests/ directory.  E.g. the 'applicationserver' module abstracts usages of apache, php and pybal to set up a WMF application server.
</p><p>Often it will be difficult to choose between creating role classes and creating a WMF specific module.  There isn't a hard rule on this.  You should use your best judgement.  If role classes start to get overly complicated, you might consider creating a WMF specific module instead.
</p>
<h3><span class="mw-headline" id="3rd_party_or_upstream_modules" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-3rd_party_or_upstream_modules-Puppet_modules&quot;,&quot;replies&quot;:[&quot;h-Adding_a_3rd_Party_module-3rd_party_or_upstream_modules&quot;],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-3rd_party_or_upstream_modules-Puppet_modules"></span>3rd party or upstream modules<span data-mw-comment-end="h-3rd_party_or_upstream_modules-Puppet_modules"></span></span></h3>
<p>There are so many great modules out there!  Why spend time writing your own?!
</p><p>Well, for good reasons.  Puppet runs as root on the production nodes.  We can't import just any 3rd party module, as we can't be sure to trust them.  Not because they would do something malicious (although they might), but because they might do something stupid.
</p><p>All 3rd party modules must be reviewed in the same manner that we review our own code before it goes to production.
</p>
<h4><span class="mw-headline" id="Adding_a_3rd_Party_module" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Adding_a_3rd_Party_module-3rd_party_or_upstream_modules&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Adding_a_3rd_Party_module-3rd_party_or_upstream_modules"></span>Adding a 3rd Party module<span data-mw-comment-end="h-Adding_a_3rd_Party_module-3rd_party_or_upstream_modules"></span></span></h4>
<p>Third party modules use to be added using git submodules however this proved to be somewhat error prone and there were complex to update.  As such for the few third party modules  we copy them directly into the puppet tree and update them in a single commit.  As an example to update the stdlib module to 6.6.0 i would use the following process
</p>
<div class="mw-highlight mw-highlight-lang-console mw-content-ltr" dir="ltr"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> ~/git/puppetlabs-stdlib/
<span class="gp">$ </span>git fetch --all
<span class="go">Fetching origin</span>
<span class="go">Fetching upstream</span>
<span class="go">remote: Enumerating objects: 1119, done.</span>
<span class="go">remote: Counting objects: 100% (1119/1119), done.</span>
<span class="go">remote: Compressing objects: 100% (115/115), done.</span>
<span class="go">remote: Total 753 (delta 632), reused 725 (delta 619), pack-reused 0</span>
<span class="go">Receiving objects: 100% (753/753), 105.71 KiB | 1.53 MiB/s, done.</span>
<span class="go">Resolving deltas: 100% (632/632), completed with 338 local objects.</span>
<span class="go">From https://github.com/puppetlabs/puppetlabs-stdlib</span>
<span class="go">   3373a08c..a26d0c59  main                                       -> upstream/main</span>
<span class="go"> * [new branch]        pdksync_maint/main/deprecate_rhel_5_family -> upstream/pdksync_maint/main/deprecate_rhel_5_family</span>
<span class="go"> * [new branch]        pdksync_maint/main/deprecate_sles11        -> upstream/pdksync_maint/main/deprecate_sles11</span>
<span class="go"> * [new branch]        pdksync_maint/main/perform_pdk_update      -> upstream/pdksync_maint/main/perform_pdk_update</span>
<span class="go"> + 1152b998...b5afe245 pdksync_remove_puppet5                     -> upstream/pdksync_remove_puppet5  (forced update)</span>
<span class="go">   9492b860..f11132d6  release                                    -> upstream/release</span>
<span class="go"> * [new tag]           v7.0.0                                     -> v7.0.0</span>
<span class="gp">$ </span>git checkout v6.6.0
<span class="go">M       spec/type_aliases/unixpath_spec.rb</span>
<span class="go">M       types/unixpath.pp</span>
<span class="go">Note: checking out 'v6.6.0'.</span>

<span class="go">You are in 'detached HEAD' state. You can look around, make experimental</span>
<span class="go">changes and commit them, and you can discard any commits you make in this</span>
<span class="go">state without impacting any branches by performing another checkout.</span>

<span class="go">If you want to create a new branch to retain commits you create, you may</span>
<span class="go">do so (now or later) by using -b with the checkout command again. Example:</span>

<span class="go">  git checkout -b &lt;new-branch-name></span>

<span class="go">HEAD is now at 9492b860 Merge pull request #1158 from sanfrancrisko/release_prep_v6_6_0</span>
<span class="gp">$ </span><span class="nb">cd</span> ~/git/puppet
<span class="gp">$ </span>git fetch --all <span class="p">;</span> git reset --hard origin/production 
<span class="go">Fetching origin</span>
<span class="go">remote: Counting objects: 6903, done</span>
<span class="go">remote: Finding sources: 100% (20/20)</span>
<span class="go">remote: Getting sizes: 100% (8/8)</span>
<span class="go">remote: Total 20 (delta 9), reused 18 (delta 9)</span>
<span class="go">Unpacking objects: 100% (20/20), done.</span>
<span class="go">From ssh://gerrit.wikimedia.org:29418/operations/puppet</span>
<span class="go">   0e6f06938a..e7d94c968e  production -> origin/production</span>
<span class="go">HEAD is now at e7d94c968e mariadb: Productionize db2145</span>
<span class="gp">$ </span>rm -rf modules/stdlib/
<span class="gp">$ </span>cp -r ~/git/puppetlabs-stdlib modules/stdlib
<span class="gp">$ </span>git add modules/stdlib/
<span class="gp">$ </span>git commit -m <span class="s1">'stdlib: update stdlib to v6.6.0'</span>
<span class="go">[production 536e4aafd4] stdlib: update stdlib to v6.6.0</span>
<span class="go"> 2 files changed, 2 insertions(+), 1 deletion(-)</span>
<span class="gp">$ </span>git-review
</pre></div>
<h2><span class="mw-headline" id="Miscellaneous" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Miscellaneous&quot;,&quot;replies&quot;:[&quot;h-VIM_guidelines-Miscellaneous&quot;,&quot;h-Emacs_guidelines-Miscellaneous&quot;,&quot;h-Puppet_for_Wikimedia_VPS_Projects-Miscellaneous&quot;,&quot;h-Packages_that_use_pip,_gem,_etc.-Miscellaneous&quot;,&quot;h-Different_ways_to_install_apt_packages_with_puppet-Miscellaneous&quot;],&quot;headingLevel&quot;:2,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Miscellaneous"></span>Miscellaneous<span data-mw-comment-end="h-Miscellaneous"></span></span></h2>
<h3><span class="mw-headline" id="VIM_guidelines" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-VIM_guidelines-Miscellaneous&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-VIM_guidelines-Miscellaneous"></span>VIM guidelines<span data-mw-comment-end="h-VIM_guidelines-Miscellaneous"></span></span></h3>
<p>The following in <code>~/.vim/ftdetect/puppet.vim</code> can help with a lot of formatting errors
</p>
<div class="mw-highlight mw-highlight-lang-vim mw-content-ltr" dir="ltr"><pre><span></span><span class="c">" detect puppet filetype</span>
autocmd <span class="nb">BufRead</span><span class="p">,</span><span class="nb">BufNewFile</span> *.<span class="k">pp</span> <span class="k">set</span> <span class="k">filetype</span><span class="p">=</span>puppet
autocmd <span class="nb">BufRead</span><span class="p">,</span><span class="nb">BufNewFile</span> *.<span class="k">pp</span> <span class="k">setlocal</span> <span class="nb">tabstop</span><span class="p">=</span><span class="m">4</span> <span class="nb">shiftwidth</span><span class="p">=</span><span class="m">4</span> <span class="nb">softtabstop</span><span class="p">=</span><span class="m">4</span> <span class="nb">expandtab</span> <span class="nb">textwidth</span><span class="p">=</span><span class="m">80</span> <span class="nb">smarttab</span>
</pre></div>
<p>And for a proper syntax hightlighting the following can be done
</p>
<pre>sudo aptitude install vim-puppet
mkdir -p ~/.vim/syntax
cp /usr/share/vim/addons/syntax/puppet.vim ~/.vim/syntax/
</pre>
<p>And definitely have a look at the vim plugin <a rel="nofollow" class="external free" href="https://github.com/scrooloose/syntastic">https://github.com/scrooloose/syntastic</a> which will report puppet errors directly in your buffer whenever you save the file (works for python/php etc as well).
</p><p>Of course symlinks can be used or you can just install vim-addon-manager to manage plugins. vim-puppet provides ftplugin and indent plugin as well. Maybe there are worth the time, but it is up to each user to decide.
</p>
<h3><span class="mw-headline" id="Emacs_guidelines" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Emacs_guidelines-Miscellaneous&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Emacs_guidelines-Miscellaneous"></span>Emacs guidelines<span data-mw-comment-end="h-Emacs_guidelines-Miscellaneous"></span></span></h3>
<p>Syntax Highlighting
</p><p>The elpa-puppet-mode deb package can be used for emacs syntax highlighting, or the raw emacs libraries can be found
<a rel="nofollow" class="external text" href="https://github.com/voxpupuli/puppet-mode">here</a>.
</p>
<pre>elpa-puppet-mode - Emacs major mode for Puppet manifests</pre>
<p>The following two sections can be added to a .emacs file to help with 4 space indentions and trailing whitespace.
</p>
<div class="mw-highlight mw-highlight-lang-emacs mw-content-ltr" dir="ltr"><pre><span></span><span class="c1">;; Puppet config with 4 spaces</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">puppet-indent-level</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">puppet-include-indent</span> <span class="mi">4</span><span class="p">)</span>

<span class="c1">;; Remove Trailing Whitespace on Save</span>
<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">'before-save-hook</span> <span class="ss">'delete-trailing-whitespace</span><span class="p">)</span>
</pre></div>
<h3><span class="mw-headline" id="Puppet_for_Wikimedia_VPS_Projects" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Puppet_for_Wikimedia_VPS_Projects-Miscellaneous&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Puppet_for_Wikimedia_VPS_Projects-Miscellaneous"></span>Puppet for <a href="/wiki/Portal:Wikimedia_VPS" class="mw-redirect" title="Portal:Wikimedia VPS">Wikimedia VPS Projects</a><span data-mw-comment-end="h-Puppet_for_Wikimedia_VPS_Projects-Miscellaneous"></span></span></h3>
<p>There is currently only one Puppet repository, and it is applied both to Cloud VPS and production instances.  Classes <i>may</i> be added to the Operations/Puppet repository that are only intended for use on a Cloud VPS instances.  The future is uncertain, though:  code is often reused, and Cloud VPS services are sometimes promoted to production.  For that reason, any changes made to Operations/Puppet must be held to the same style and security standards as code that would be applied on a production service.
</p>
<h3><span id="Packages_that_use_pip.2C_gem.2C_etc."></span><span class="mw-headline" id="Packages_that_use_pip,_gem,_etc." data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Packages_that_use_pip,_gem,_etc.-Miscellaneous&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Packages_that_use_pip,_gem,_etc.-Miscellaneous"></span>Packages that use pip, gem, etc.<span data-mw-comment-end="h-Packages_that_use_pip,_gem,_etc.-Miscellaneous"></span></span></h3>
<p>Other than mediawiki and related extensions, any software installed by puppet should be a Debian package and should come either from the WMF apt repo or from an official upstream Ubuntu repo.  Never use source-based packaging systems like pip or gem as these options haven't been properly evaluated and approved as secure by WMF Operations staff.
</p>
<h3><span class="mw-headline" id="Different_ways_to_install_apt_packages_with_puppet" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-Different_ways_to_install_apt_packages_with_puppet-Miscellaneous&quot;,&quot;replies&quot;:[&quot;h-method_1:_ensure_present-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;h-method_2:_ensure_latest-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;h-method_3:_ensure_version-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;h-method_4:_install_options-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;h-method_5:_apt_pinning-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;h-method_6:_combination-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;h-method_7:_apt_configuration_before_installation-Different_ways_to_install_apt_packages_with_puppet&quot;],&quot;headingLevel&quot;:3,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-Different_ways_to_install_apt_packages_with_puppet-Miscellaneous"></span>Different ways to install apt packages with puppet<span data-mw-comment-end="h-Different_ways_to_install_apt_packages_with_puppet-Miscellaneous"></span></span></h3>
<p>There are several different ways to install concrete apt packages with puppet, each with pros and cons.
</p><p>At WMF we recommend the usage of the puppet stdlib function <code>ensure_packages</code> when possible, which will simplify many of the typical usages (see <a href="https://phabricator.wikimedia.org/T266479" class="extiw" title="phabricator:T266479">task T266479</a> ):
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span> <span class="na">ensure_packages</span><span class="p">([</span><span class="s">'python3-git'</span><span class="p">,</span> <span class="s">'python3-pynetbox'</span><span class="p">,</span> <span class="s">'python3-requests'</span><span class="p">])</span>
</pre></div>
<p>The following is a discussion of the options of the lower-level <code>package</code> resource, for more specialized uses.
</p><p>In all cases, you need a repo configured in the host that provides this package.
</p>
<h4><span class="mw-headline" id="method_1:_ensure_present" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-method_1:_ensure_present-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-method_1:_ensure_present-Different_ways_to_install_apt_packages_with_puppet"></span>method 1: ensure present<span data-mw-comment-end="h-method_1:_ensure_present-Different_ways_to_install_apt_packages_with_puppet"></span></span></h4>
<p>The most basic method is to declare a package like this:
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">package</span> <span class="p">{</span> <span class="s">'htop'</span><span class="p">:</span>
    <span class="na">ensure</span> <span class="o">=></span> <span class="k">present</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
<p>Puppet will ensure the package is present (installed). If the package is already installed, puppet will do nothing. If it isn't installed, puppet will install the proper candidate (as reported by <code>apt-cache policy &lt;package></code>).
</p><p><br/>
Pros:
</p>
<ul><li>simple and straight forward.</li>
<li>allows to manually modify the version of the package in the system (i.e, manual upgrade of the package)</li>
<li>Good for security management (i.e, security package upgrades)</li></ul>
<p>Cons:
</p>
<ul><li>not very smart. If you need concrete package version, this method may not be enough.</li></ul>
<h4><span class="mw-headline" id="method_2:_ensure_latest" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-method_2:_ensure_latest-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-method_2:_ensure_latest-Different_ways_to_install_apt_packages_with_puppet"></span>method 2: ensure latest<span data-mw-comment-end="h-method_2:_ensure_latest-Different_ways_to_install_apt_packages_with_puppet"></span></span></h4>
<p>Using this method, puppet will ensure that the most recent package is installed.
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">package</span> <span class="p">{</span> <span class="s">'htop'</span><span class="p">:</span>
    <span class="na">ensure</span> <span class="o">=></span> <span class="k">latest</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
<p>Puppet not will only ensure the package is present, but that the higest version is installed (as reported by <code>apt-cache policy &lt;package></code>).
In packages that are frequently updated, this means that puppet will update it arbitrarily.
</p><p>Pros:
</p>
<ul><li>simple and straight forward.</li>
<li>allows to keep installed most recent version of the package, without further actions by the administrator.</li>
<li>Security package upgrades will be done automatically in most cases.</li></ul>
<p>Cons:
</p>
<ul><li>may be too smart. Upgrading packages without control may lead to unexpected results, specially those related to services (services will likely be restarted by the package upgrade).</li>
<li>may clash with manual package upgrades by the administrator (i.e, running manual upgrade in the server)</li>
<li>crazy things may happen if you play with adding different repos to the system that contain different versions of the same package</li>
<li>since auto upgrading may have unexpected results, this should be done only for trusted packages from trusted repos, or other special cases.</li></ul>
<h4><span class="mw-headline" id="method_3:_ensure_version" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-method_3:_ensure_version-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-method_3:_ensure_version-Different_ways_to_install_apt_packages_with_puppet"></span>method 3: ensure version<span data-mw-comment-end="h-method_3:_ensure_version-Different_ways_to_install_apt_packages_with_puppet"></span></span></h4>
<p>Using this method, puppet will ensure the package is installed in a concrete version.
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">package</span> <span class="p">{</span> <span class="s">'htop'</span><span class="p">:</span>
    <span class="na">ensure</span> <span class="o">=></span> <span class="na">x</span><span class="err">.</span><span class="na">y</span><span class="err">.</span><span class="na">z</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
<p>This overrides the candidate version reported by <code>apt-cache policy &lt;package></code>.
</p><p>Pros:
</p>
<ul><li>simple and straight forward.</li>
<li>a way to get a specific version of a package installed</li></ul>
<p>Cons:
</p>
<ul><li>requires a puppet patch to manage the version of the package, if that requires changes (for example, for security management).</li>
<li>if installing packages from different repos, the resolver may find clashes with the dependencies from other packages.</li>
<li>need concrete version specification, not too smart for some cases.</li>
<li><b>this is not the preferred mechanism for getting a concrete version installed</b> (see below). This may revert package security upgrades if puppet code wasn't patched accordingly.</li></ul>
<h4><span class="mw-headline" id="method_4:_install_options" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-method_4:_install_options-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-method_4:_install_options-Different_ways_to_install_apt_packages_with_puppet"></span>method 4: install options<span data-mw-comment-end="h-method_4:_install_options-Different_ways_to_install_apt_packages_with_puppet"></span></span></h4>
<p>You can pass specific install options to apt by means of the package declaration:
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="k">package</span> <span class="p">{</span> <span class="s">'htop'</span><span class="p">:</span>
    <span class="na">ensure</span>          <span class="o">=></span> <span class="o">&lt;</span><span class="na">whatever</span><span class="o">></span><span class="p">,</span>
    <span class="na">install_options</span> <span class="o">=></span> <span class="p">[</span><span class="s">'-t'</span><span class="p">,</span> <span class="s">'stretch-backports'</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>
<p>You can pass additional options to the apt call using this mechanism. In the example, this is the equivalent of using the <code>-t stretch-backports</code>, i.e, temporally give stretch-backports maximum priority in the resolver for calculating candidates.
</p><p>You can combine this option with any 'ensure' option.
</p><p>Pros:
</p>
<ul><li>simple way to override default resolver behaviour.</li>
<li>allows for manual package installations</li>
<li><b>TODO:</b> fill me.</li></ul>
<p>Cons:
</p>
<ul><li>if using ensure <i>present</i>, this is not enough for puppet to upgrade the package if it was previously installed (for example, by debian-installer).</li>
<li><b>TODO:</b> fill me.</li></ul>
<h4><span class="mw-headline" id="method_5:_apt_pinning" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-method_5:_apt_pinning-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-method_5:_apt_pinning-Different_ways_to_install_apt_packages_with_puppet"></span>method 5: apt pinning<span data-mw-comment-end="h-method_5:_apt_pinning-Different_ways_to_install_apt_packages_with_puppet"></span></span></h4>
<p>You can create an apt pinning and let the apt resolver use that when dealing with the package.
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="na">apt</span><span class="p">::</span><span class="na">pin</span> <span class="p">{</span> <span class="s">'my_pinning'</span><span class="p">:</span>
    <span class="k">package</span>  <span class="o">=></span> <span class="s">'htop'</span><span class="p">,</span>
    <span class="na">pin</span>      <span class="o">=></span> <span class="s">'component a=jessie-backports'</span><span class="p">,</span>
    <span class="na">priority</span> <span class="o">=></span> <span class="mi">1002</span><span class="p">,</span>
    <span class="k">before</span>  <span class="o">=></span> <span class="k">Package</span><span class="p">[</span><span class="na">htop</span><span class="p">],</span>
<span class="p">}</span>
<span class="k">package</span> <span class="p">{</span> <span class="s">'htop'</span><span class="p">:</span>
    <span class="na">ensure</span> <span class="o">=></span> <span class="k">present</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
<p>This methods create a file in <code>/etc/apt/preferences.d/</code> with the pinning configuration file. The pinning affects how the resolver behaves for that package (check that with <code>apt-cache policy &lt;package></code>).
</p><p>The pinning can be anything, from the component, release or version. You can combine this method with any 'ensure' option. Mind that if using 'present', and if the package is already installed but not meeting the pinning requirement, puppet won't reinstall it (because is already present).
</p><p>Pros:
</p>
<ul><li><b>this is the preferred way of getting a given package version installed</b>.</li>
<li>if using version pinning, the version specification is more flexible, allowing wildcards like <i>x.y.z*</i>.</li>
<li><b>TODO:</b> fill me.</li></ul>
<p>Cons:
</p>
<ul><li>may require a puppet patch to manage the version of the package (if using version pinning rather than component), if that requires changes (for example, for security management).</li>
<li>if installing packages from different repos, the resolver may find clashes with the dependencies from other packages.</li></ul>
<h4><span class="mw-headline" id="method_6:_combination" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-method_6:_combination-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-method_6:_combination-Different_ways_to_install_apt_packages_with_puppet"></span>method 6: combination<span data-mw-comment-end="h-method_6:_combination-Different_ways_to_install_apt_packages_with_puppet"></span></span></h4>
<p>You can combine any of the options above. You probably don't need this method unless in a very specific situation.
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span><span class="na">apt</span><span class="p">::</span><span class="na">pin</span> <span class="p">{</span> <span class="s">'my_pinning'</span><span class="p">:</span>
    <span class="k">package</span>  <span class="o">=></span> <span class="s">'htop'</span><span class="p">,</span>
    <span class="na">pin</span>      <span class="o">=></span> <span class="s">'version x.y.z*'</span><span class="p">,</span>
    <span class="na">priority</span> <span class="o">=></span> <span class="mi">1002</span><span class="p">,</span>
    <span class="k">before</span>  <span class="o">=></span> <span class="k">Package</span><span class="p">[</span><span class="na">htop</span><span class="p">],</span>
<span class="p">}</span>
<span class="k">package</span> <span class="p">{</span> <span class="s">'htop'</span><span class="p">:</span>
    <span class="na">ensure</span>          <span class="o">=></span> <span class="k">latest</span><span class="p">,</span>
    <span class="na">install_options</span> <span class="o">=></span> <span class="p">[</span><span class="s">'-t'</span><span class="p">,</span> <span class="s">'stretch-backports'</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>
<p>Pros:
</p>
<ul><li>the most expressive way to do almost anything regarding package installation.</li>
<li>if using version pinning, the version specification is more flexible, allowing wildcards like <i>x.y.z*</i>.</li>
<li><b>TODO:</b> fill me.</li></ul>
<p>Cons:
</p>
<ul><li>requires a puppet patch to manage the version of the package, if that requires changes (for example, for security management).</li>
<li>if installing packages from different repos, the resolver may find clashes with the dependencies from other packages.</li>
<li>doing manual package upgrades may create a ping/pong between your manual operation and the puppet run.</li>
<li><b>this is not the preferred mechanism for getting a concrete version installed (see above)</b>. This may revert package security upgrades if puppet code wasn't patched accordingly.</li></ul>
<h4><span class="mw-headline" id="method_7:_apt_configuration_before_installation" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-method_7:_apt_configuration_before_installation-Different_ways_to_install_apt_packages_with_puppet&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:4,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-method_7:_apt_configuration_before_installation-Different_ways_to_install_apt_packages_with_puppet"></span>method 7: apt configuration before installation<span data-mw-comment-end="h-method_7:_apt_configuration_before_installation-Different_ways_to_install_apt_packages_with_puppet"></span></span></h4>
<p>In some cases is interesting to create a given apt repo/pinning configuration and then package installation in the same puppet agent run.
This is a complex case as such we have created a custom resource <code>apt::package_from_component</code>:
</p>
<div class="mw-highlight mw-highlight-lang-puppet mw-content-ltr" dir="ltr"><pre><span></span>  <span class="na">apt</span><span class="p">::</span><span class="na">package_from_component</span> <span class="p">{</span> <span class="s">'librenms_php72'</span><span class="p">:</span>
    <span class="na">component</span> <span class="o">=></span> <span class="s">'component/php72'</span><span class="p">,</span>
    <span class="na">distro</span>    <span class="o">=></span> <span class="s">'buster-wikimedia'</span>
    <span class="na">packages</span>  <span class="o">=></span> <span class="p">[</span><span class="s">'php-cli'</span><span class="p">,</span> <span class="s">'php-curl'</span><span class="p">,</span> <span class="s">'php-gd'</span><span class="p">]</span>
  <span class="p">}</span>
</pre></div>
<p>Pros:
</p>
<ul><li><b>TODO:</b> fill me.</li></ul>
<p>Cons:
</p>
<ul><li><b>TODO:</b> fill me.</li></ul>
<h2><span class="mw-headline" id="References" data-mw-comment="{&quot;type&quot;:&quot;heading&quot;,&quot;level&quot;:0,&quot;id&quot;:&quot;h-References&quot;,&quot;replies&quot;:[],&quot;headingLevel&quot;:2,&quot;placeholderHeading&quot;:false,&quot;name&quot;:&quot;h-&quot;}"><span data-mw-comment-start="" id="h-References"></span>References<span data-mw-comment-end="h-References"></span></span></h2>
<ol class="references">
<li id="cite_note-1"><span class="mw-cite-backlink"><a href="#cite_ref-1">↑</a></span> <span class="reference-text"><a class="external free" href="https://phabricator.wikimedia.org/T147718">https://phabricator.wikimedia.org/T147718</a></span>
</li>
</ol>
<!-- 
NewPP limit report
Parsed by labweb1002
Cached time: 20220511101122
Cache expiry: 1814400
Reduced expiry: false
Complications: []
DiscussionTools time usage: 0.075 seconds
CPU time usage: 0.291 seconds
Real time usage: 0.603 seconds
Preprocessor visited node count: 632/1000000
Post‐expand include size: 5519/2097152 bytes
Template argument size: 1421/2097152 bytes
Highest expansion depth: 8/100
Expensive parser function count: 0/500
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 45286/5000000 bytes
Lua time usage: 0.038/10.000 seconds
Lua memory usage: 747684/52428800 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%   99.688      1 -total
 68.87%   68.652      2 Template:Warn
 66.73%   66.517      2 Template:Note
 63.35%   63.155      2 Template:Mbox
  4.43%    4.415      1 Template:SourceLinks
  3.67%    3.657      1 Template:TOC
  2.53%    2.519      1 Template:Phabricator
  1.87%    1.869      1 Template:Alert
-->

<!-- Saved in parser cache with key labswiki:pcache:idhash:4895-0!canonical and timestamp 20220511101121 and revision id 1952559. Serialized with JSON.
 -->
</div>
<div class="printfooter">Retrieved from "<a dir="ltr" href="https://wikitech.wikimedia.org/w/index.php?title=Puppet_coding&amp;oldid=1952559">https://wikitech.wikimedia.org/w/index.php?title=Puppet_coding&amp;oldid=1952559</a>"</div></div>
		<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="/wiki/Special:Categories" title="Special:Categories">Category</a>: <ul><li><a href="/wiki/Category:Puppet" title="Category:Puppet">Puppet</a></li></ul></div></div>
	</div>
</div>

<div id="mw-navigation">
	<h2>Navigation menu</h2>
	<div id="mw-head">
		

<nav id="p-personal" class="mw-portlet mw-portlet-personal vector-user-menu-legacy vector-menu" aria-labelledby="p-personal-label" role="navigation"  >
	<label
		id="p-personal-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Personal tools</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="pt-uls" class="mw-list-item active"><a class="uls-trigger" href="#"><span>English</span></a></li><li id="pt-createaccount" class="mw-list-item"><a href="/w/index.php?title=Special:CreateAccount&amp;returnto=Puppet+coding" title="You are encouraged to create an account and log in; however, it is not mandatory"><span>Create account</span></a></li><li id="pt-login" class="mw-list-item"><a href="/w/index.php?title=Special:UserLogin&amp;returnto=Puppet+coding" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o"><span>Log in</span></a></li></ul>
		
	</div>
</nav>

		<div id="left-navigation">
			

<nav id="p-namespaces" class="mw-portlet mw-portlet-namespaces vector-menu vector-menu-tabs" aria-labelledby="p-namespaces-label" role="navigation"  >
	<label
		id="p-namespaces-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Namespaces</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-nstab-main" class="selected mw-list-item"><a href="/wiki/Puppet_coding" title="View the content page [c]" accesskey="c"><span>Page</span></a></li><li id="ca-talk" class="mw-list-item"><a href="/wiki/Talk:Puppet_coding" rel="discussion" title="Discussion about the content page [t]" accesskey="t"><span>Discussion</span></a></li></ul>
		
	</div>
</nav>

			

<nav id="p-variants" class="mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown-noicon vector-menu vector-menu-dropdown" aria-labelledby="p-variants-label" role="navigation"  >
	<input type="checkbox"
		id="p-variants-checkbox"
		role="button"
		aria-haspopup="true"
		data-event-name="ui.dropdown-p-variants"
		class="vector-menu-checkbox"
		aria-labelledby="p-variants-label"
	/>
	<label
		id="p-variants-label"
		 aria-label="Change language variant"
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">English</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

		</div>
		<div id="right-navigation">
			

<nav id="p-views" class="mw-portlet mw-portlet-views vector-menu vector-menu-tabs" aria-labelledby="p-views-label" role="navigation"  >
	<label
		id="p-views-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Views</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="ca-view" class="selected mw-list-item"><a href="/wiki/Puppet_coding"><span>Read</span></a></li><li id="ca-viewsource" class="mw-list-item"><a href="/w/index.php?title=Puppet_coding&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e"><span>View source</span></a></li><li id="ca-history" class="mw-list-item"><a href="/w/index.php?title=Puppet_coding&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li></ul>
		
	</div>
</nav>

			

<nav id="p-cactions" class="mw-portlet mw-portlet-cactions emptyPortlet vector-menu-dropdown-noicon vector-menu vector-menu-dropdown" aria-labelledby="p-cactions-label" role="navigation"  title="More options" >
	<input type="checkbox"
		id="p-cactions-checkbox"
		role="button"
		aria-haspopup="true"
		data-event-name="ui.dropdown-p-cactions"
		class="vector-menu-checkbox"
		aria-labelledby="p-cactions-label"
	/>
	<label
		id="p-cactions-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">More</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</nav>

			
<div id="p-search" role="search" class="vector-search-box-vue  vector-search-box-show-thumbnail vector-search-box-auto-expand-width vector-search-box">
	<div>
			<h3 >
				<label for="searchInput">Search</label>
			</h3>
		<form action="/w/index.php" id="searchform"
			class="vector-search-box-form">
			<div id="simpleSearch"
				class="vector-search-box-inner"
				 data-search-loc="header-navigation">
				<input class="vector-search-box-input"
					 type="search" name="search" placeholder="Search Wikitech" aria-label="Search Wikitech" autocapitalize="sentences" title="Search Wikitech [f]" accesskey="f" id="searchInput"
				/>
				<input type="hidden" name="title" value="Special:Search"/>
				<input id="mw-searchButton"
					 class="searchButton mw-fallbackSearchButton" type="submit" name="fulltext" title="Search the pages for this text" value="Search" />
				<input id="searchButton"
					 class="searchButton" type="submit" name="go" title="Go to a page with this exact name if it exists" value="Go" />
			</div>
		</form>
	</div>
</div>

		</div>
	</div>
	

<div id="mw-panel">
	<div id="p-logo" role="banner">
		<a class="mw-wiki-logo" href="/wiki/Main_Page"
			title="Visit the main page"></a>
	</div>
	

<nav id="p-navigation" class="mw-portlet mw-portlet-navigation vector-menu vector-menu-portal portal" aria-labelledby="p-navigation-label" role="navigation"  >
	<label
		id="p-navigation-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Navigation</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-mainpage-description" class="mw-list-item"><a href="/wiki/Main_Page" icon="home" title="Visit the main page [z]" accesskey="z"><span>Main page</span></a></li><li id="n-recentchanges" class="mw-list-item"><a href="/wiki/Special:RecentChanges" icon="recentChanges" title="A list of recent changes in the wiki [r]" accesskey="r"><span>Recent changes</span></a></li><li id="n-Server-admin-log:-Prod" class="mw-list-item"><a href="/wiki/Server_Admin_Log"><span>Server admin log: Prod</span></a></li><li id="n-Admin-log:-RelEng" class="mw-list-item"><a href="/wiki/Release_Engineering/SAL"><span>Admin log: RelEng</span></a></li><li id="n-Incident-status" class="mw-list-item"><a href="/wiki/Incident_status"><span>Incident status</span></a></li><li id="n-Deployments" class="mw-list-item"><a href="/wiki/Deployments"><span>Deployments</span></a></li><li id="n-SRE-Team-Help" class="mw-list-item"><a href="/wiki/SRE/SRE_Team_requests"><span>SRE Team Help</span></a></li></ul>
		
	</div>
</nav>

	

<nav id="p-Cloud_VPS_&amp;_Toolforge" class="mw-portlet mw-portlet-Cloud_VPS_Toolforge vector-menu vector-menu-portal portal" aria-labelledby="p-Cloud_VPS_&amp;_Toolforge-label" role="navigation"  >
	<label
		id="p-Cloud_VPS_&amp;_Toolforge-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Cloud VPS &amp; Toolforge</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="n-Cloud-VPS-portal" class="mw-list-item"><a href="/wiki/Portal:Cloud_VPS"><span>Cloud VPS portal</span></a></li><li id="n-Toolforge-portal" class="mw-list-item"><a href="/wiki/Portal:Toolforge"><span>Toolforge portal</span></a></li><li id="n-Request-VPS-project" class="mw-list-item"><a href="https://phabricator.wikimedia.org/project/view/2875/"><span>Request VPS project</span></a></li><li id="n-Admin-log:-Cloud-VPS" class="mw-list-item"><a href="/wiki/Cloud_VPS_Server_Admin_Log"><span>Admin log: Cloud VPS</span></a></li></ul>
		
	</div>
</nav>


<nav id="p-tb" class="mw-portlet mw-portlet-tb vector-menu vector-menu-portal portal" aria-labelledby="p-tb-label" role="navigation"  >
	<label
		id="p-tb-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Tools</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="t-whatlinkshere" class="mw-list-item"><a href="/wiki/Special:WhatLinksHere/Puppet_coding" title="A list of all wiki pages that link here [j]" accesskey="j"><span>What links here</span></a></li><li id="t-recentchangeslinked" class="mw-list-item"><a href="/wiki/Special:RecentChangesLinked/Puppet_coding" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k"><span>Related changes</span></a></li><li id="t-specialpages" class="mw-list-item"><a href="/wiki/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q"><span>Special pages</span></a></li><li id="t-permalink" class="mw-list-item"><a href="/w/index.php?title=Puppet_coding&amp;oldid=1952559" title="Permanent link to this revision of the page"><span>Permanent link</span></a></li><li id="t-info" class="mw-list-item"><a href="/w/index.php?title=Puppet_coding&amp;action=info" title="More information about this page"><span>Page information</span></a></li><li id="t-cite" class="mw-list-item"><a href="/w/index.php?title=Special:CiteThisPage&amp;page=Puppet_coding&amp;id=1952559&amp;wpFormIdentifier=titleform" title="Information on how to cite this page"><span>Cite this page</span></a></li></ul>
		
	</div>
</nav>


<nav id="p-coll-print_export" class="mw-portlet mw-portlet-coll-print_export vector-menu vector-menu-portal portal" aria-labelledby="p-coll-print_export-label" role="navigation"  >
	<label
		id="p-coll-print_export-label"
		
		class="vector-menu-heading "
	>
		<span class="vector-menu-heading-label">Print/export</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="coll-create_a_book" class="mw-list-item"><a href="/w/index.php?title=Special:Book&amp;bookcmd=book_creator&amp;referer=Puppet+coding"><span>Create a book</span></a></li><li id="coll-download-as-rl" class="mw-list-item"><a href="/w/index.php?title=Special:DownloadAsPdf&amp;page=Puppet_coding&amp;action=show-download-screen"><span>Download as PDF</span></a></li><li id="t-print" class="mw-list-item"><a href="/w/index.php?title=Puppet_coding&amp;printable=yes" title="Printable version of this page [p]" accesskey="p"><span>Printable version</span></a></li></ul>
		
	</div>
</nav>

	
</div>

</div>

<footer id="footer" class="mw-footer" role="contentinfo" >
	<ul id="footer-info">
	<li id="footer-info-lastmod"> This page was last edited on 25 February 2022, at 15:11.</li>
	<li id="footer-info-copyright">Text is available under the <a href="https://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike License</a>;
additional terms may apply.
See <a href="https://foundation.wikimedia.org/wiki/Terms_of_Use">Terms of Use</a> for details.</li>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://foundation.wikimedia.org/wiki/Privacy_policy" class="extiw" title="wmf:Privacy policy">Privacy policy</a></li>
	<li id="footer-places-about"><a href="/wiki/Main_Page" title="Main Page">About Wikitech</a></li>
	<li id="footer-places-disclaimer"><a href="https://foundation.wikimedia.org/wiki/General_disclaimer" class="extiw" title="wikimedia:General disclaimer">Disclaimers</a></li>
	<li id="footer-places-wm-codeofconduct"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Code_of_Conduct">Code of Conduct</a></li>
	<li id="footer-places-mobileview"><a href="//wikitech.wikimedia.org/w/index.php?title=Puppet_coding&amp;mobileaction=toggle_view_mobile" class="noprint stopMobileRedirectToggle">Mobile view</a></li>
	<li id="footer-places-developers"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/How_to_contribute">Developers</a></li>
	<li id="footer-places-statslink"><a href="https://stats.wikimedia.org/#/wikitech.wikimedia.org">Statistics</a></li>
	<li id="footer-places-cookiestatement"><a href="https://foundation.wikimedia.org/wiki/Cookie_statement">Cookie statement</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://wikimediafoundation.org/"><img src="/static/images/footer/wikimedia-button.png" srcset="/static/images/footer/wikimedia-button-1.5x.png 1.5x, /static/images/footer/wikimedia-button-2x.png 2x" width="88" height="31" alt="Wikimedia Foundation" loading="lazy" /></a></li>
	<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/"><img src="/static/images/footer/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="/static/images/footer/poweredby_mediawiki_132x47.png 1.5x, /static/images/footer/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"/></a></li>
</ul>

</footer>

<script>(RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"discussiontools":{"limitreport-timeusage":"0.075"},"limitreport":{"cputime":"0.291","walltime":"0.603","ppvisitednodes":{"value":632,"limit":1000000},"postexpandincludesize":{"value":5519,"limit":2097152},"templateargumentsize":{"value":1421,"limit":2097152},"expansiondepth":{"value":8,"limit":100},"expensivefunctioncount":{"value":0,"limit":500},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":45286,"limit":5000000},"timingprofile":["100.00%   99.688      1 -total"," 68.87%   68.652      2 Template:Warn"," 66.73%   66.517      2 Template:Note"," 63.35%   63.155      2 Template:Mbox","  4.43%    4.415      1 Template:SourceLinks","  3.67%    3.657      1 Template:TOC","  2.53%    2.519      1 Template:Phabricator","  1.87%    1.869      1 Template:Alert"]},"scribunto":{"limitreport-timeusage":{"value":"0.038","limit":"10.000"},"limitreport-memusage":{"value":747684,"limit":52428800}},"cachereport":{"origin":"labweb1002","timestamp":"20220511101122","ttl":1814400,"transientcontent":false}}});mw.config.set({"wgBackendResponseTime":112,"wgHostname":"labweb1002"});});</script>
</body>
</html>