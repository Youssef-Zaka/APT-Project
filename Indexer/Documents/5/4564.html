<!DOCTYPE html>
<!--[if IE 6]>
<html id="ie6" lang="en-US">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 6) & !(IE 7) & !(IE 8)]><!-->
<html lang="en-US">
<!--<![endif]-->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<title>Uncategorized | code.flickr.com</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="stylesheet" type="text/css" media="all" href="https://code.flickr.net/wp-content/themes/flickr-code/style.css" />
<link rel="pingback" href="https://code.flickr.net/xmlrpc.php">
<!--[if lt IE 9]>
<script src="https://code.flickr.net/wp-content/themes/twentyeleven/js/html5.js" type="text/javascript"></script>
<![endif]-->
<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="code.flickr.com &raquo; Feed" href="https://code.flickr.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="code.flickr.com &raquo; Comments Feed" href="https://code.flickr.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="code.flickr.com &raquo; Uncategorized Category Feed" href="https://code.flickr.net/category/uncategorized/feed/" />
<script type="text/javascript">
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/code.flickr.net\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.9.3"}};
/*! This file is auto-generated */
!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([10084,65039,8205,55357,56613],[10084,65039,8203,55357,56613])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 0.07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0' href='https://code.flickr.net/wp-includes/css/dist/block-library/style.min.css?m=1650913121g' type='text/css' media='all' />
<style id='wp-block-library-inline-css'>
.has-text-align-justify{text-align:justify;}
</style>
<style id='wp-block-library-theme-inline-css'>
.wp-block-audio figcaption{color:#555;font-size:13px;text-align:center}.is-dark-theme .wp-block-audio figcaption{color:hsla(0,0%,100%,.65)}.wp-block-code>code{font-family:Menlo,Consolas,monaco,monospace;color:#1e1e1e;padding:.8em 1em;border:1px solid #ddd;border-radius:4px}.wp-block-embed figcaption{color:#555;font-size:13px;text-align:center}.is-dark-theme .wp-block-embed figcaption{color:hsla(0,0%,100%,.65)}.blocks-gallery-caption{color:#555;font-size:13px;text-align:center}.is-dark-theme .blocks-gallery-caption{color:hsla(0,0%,100%,.65)}.wp-block-image figcaption{color:#555;font-size:13px;text-align:center}.is-dark-theme .wp-block-image figcaption{color:hsla(0,0%,100%,.65)}.wp-block-pullquote{border-top:4px solid;border-bottom:4px solid;margin-bottom:1.75em;color:currentColor}.wp-block-pullquote__citation,.wp-block-pullquote cite,.wp-block-pullquote footer{color:currentColor;text-transform:uppercase;font-size:.8125em;font-style:normal}.wp-block-quote{border-left:.25em solid;margin:0 0 1.75em;padding-left:1em}.wp-block-quote cite,.wp-block-quote footer{color:currentColor;font-size:.8125em;position:relative;font-style:normal}.wp-block-quote.has-text-align-right{border-left:none;border-right:.25em solid;padding-left:0;padding-right:1em}.wp-block-quote.has-text-align-center{border:none;padding-left:0}.wp-block-quote.is-large,.wp-block-quote.is-style-large,.wp-block-quote.is-style-plain{border:none}.wp-block-search .wp-block-search__label{font-weight:700}.wp-block-group:where(.has-background){padding:1.25em 2.375em}.wp-block-separator{border:none;border-bottom:2px solid;margin-left:auto;margin-right:auto;opacity:.4}.wp-block-separator:not(.is-style-wide):not(.is-style-dots){width:100px}.wp-block-separator.has-background:not(.is-style-dots){border-bottom:none;height:1px}.wp-block-separator.has-background:not(.is-style-wide):not(.is-style-dots){height:2px}.wp-block-table thead{border-bottom:3px solid}.wp-block-table tfoot{border-top:3px solid}.wp-block-table td,.wp-block-table th{padding:.5em;border:1px solid;word-break:normal}.wp-block-table figcaption{color:#555;font-size:13px;text-align:center}.is-dark-theme .wp-block-table figcaption{color:hsla(0,0%,100%,.65)}.wp-block-video figcaption{color:#555;font-size:13px;text-align:center}.is-dark-theme .wp-block-video figcaption{color:hsla(0,0%,100%,.65)}.wp-block-template-part.has-background{padding:1.25em 2.375em;margin-top:0;margin-bottom:0}
</style>
<link rel='stylesheet' id='all-css-2' href='https://code.flickr.net/_static/??-eJzTLy/QzcxLzilNSS3WzyrWz01NyUxMzUnNTc0rQeEU5CRWphbp5qSmJyZX6uVm5uklFxfr6OPTDpRD5sM02efaGpqZGlgaGhsaGQEARKEu2Q==' type='text/css' media='all' />
<style id='global-styles-inline-css'>
body{--wp--preset--color--black: #000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #fff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--color--blue: #1982d1;--wp--preset--color--dark-gray: #373737;--wp--preset--color--medium-gray: #666;--wp--preset--color--light-gray: #e2e2e2;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--duotone--dark-grayscale: url('#wp-duotone-dark-grayscale');--wp--preset--duotone--grayscale: url('#wp-duotone-grayscale');--wp--preset--duotone--purple-yellow: url('#wp-duotone-purple-yellow');--wp--preset--duotone--blue-red: url('#wp-duotone-blue-red');--wp--preset--duotone--midnight: url('#wp-duotone-midnight');--wp--preset--duotone--magenta-yellow: url('#wp-duotone-magenta-yellow');--wp--preset--duotone--purple-green: url('#wp-duotone-purple-green');--wp--preset--duotone--blue-orange: url('#wp-duotone-blue-orange');--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
</style>
<link rel='stylesheet' id='all-css-4' href='https://code.flickr.net/_static/??-eJx9zMEOgjAQBNAfsmxrAsaD8Vt0HRG7LY27QPh768GDIfE4kzdDS3E8ZkM2sgcSlGypYYVgRia1VdCw6o628i4Dx1dtb/gPfy6vMnLUDU2TKzL1Q1Z6wsqFowu+OVJ13+KzOadT6Nrg24Pf+zcEp0W8' type='text/css' media='all' />
<link rel="https://api.w.org/" href="https://code.flickr.net/wp-json/" /><link rel="alternate" type="application/json" href="https://code.flickr.net/wp-json/wp/v2/categories/1" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://code.flickr.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://code.flickr.net/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.9.3" />
<style type='text/css'>img#wpstats{display:none}</style>
		<style type="text/css" id="twentyeleven-header-css">
			#site-title,
		#site-description {
			position: absolute;
			clip: rect(1px 1px 1px 1px); /* IE6, IE7 */
			clip: rect(1px, 1px, 1px, 1px);
		}
		</style>
	<link rel="stylesheet" type="text/css" id="wp-custom-css" href="https://code.flickr.net/?custom-css=e0fbe57d10" /></head>

<body class="archive category category-uncategorized category-1 custom-background wp-embed-responsive two-column right-sidebar">
<div id="page" class="hfeed">
	<header id="branding" role="banner">
			<hgroup>
				<h1 id="site-title"><span><a href="https://code.flickr.net/" rel="home">code.flickr.com</a></span></h1>
				<h2 id="site-description"></h2>
			</hgroup>

						<a href="https://code.flickr.net/">
									<img src="https://wp.flickr.net/wp-content/uploads/sites/3/2012/09/code-flickr-com-drawn-header-grey-large.png" width="1000" height="157" alt="" />
							</a>
			
							<div class="only-search with-image">
					<form method="get" id="searchform" action="https://code.flickr.net/">
		<label for="s" class="assistive-text">Search</label>
		<input type="text" class="field" name="s" id="s" placeholder="Search" />
		<input type="submit" class="submit" name="submit" id="searchsubmit" value="Search" />
	</form>
				</div>
			
			<nav id="access" role="navigation">
				<h3 class="assistive-text">Main menu</h3>
								<div class="skip-link"><a class="assistive-text" href="#content">Skip to primary content</a></div>
									<div class="skip-link"><a class="assistive-text" href="#secondary">Skip to secondary content</a></div>
												<div class="menu-menu-container"><ul id="menu-menu" class="menu"><li id="menu-item-2084" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2084"><a href="http://www.flickr.com/">Flickr</a></li>
<li id="menu-item-2085" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2085"><a href="http://blog.flickr.net/">Flickr Blog</a></li>
<li id="menu-item-2250" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2250"><a href="http://twitter.com/flickr">@flickr</a></li>
<li id="menu-item-2086" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2086"><a href="http://twitter.com/flickrapi">@flickrapi</a></li>
<li id="menu-item-2087" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2087"><a href="https://www.flickr.com/services/developer/">Developer Guidelines</a></li>
<li id="menu-item-2088" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2088"><a href="http://www.flickr.com/services/api/">API</a></li>
<li id="menu-item-2089" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2089"><a href="http://www.flickr.com/jobs/">Jobs</a></li>
</ul></div>			</nav><!-- #access -->
	</header><!-- #branding -->


	<div id="main">

		<section id="primary">
			<div id="content" role="main">

			
				<header class="page-header">
					<h1 class="page-title">Category Archives: <span>Uncategorized</span></h1>

									</header>

						<nav id="nav-above">
			<h3 class="assistive-text">Post navigation</h3>
			<div class="nav-previous"><a href="https://code.flickr.net/category/uncategorized/page/2/" ><span class="meta-nav">&larr;</span> Older posts</a></div>
			<div class="nav-next"></div>
		</nav><!-- #nav-above -->
	
								
					
	<article id="post-3617" class="post-3617 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2022/01/04/a-pluggable-solution-for-api-observability-on-our-php-system/" rel="bookmark">A Pluggable Solution for API Observability on our PHP System</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2022/01/04/a-pluggable-solution-for-api-observability-on-our-php-system/" title="2:51 pm" rel="bookmark"><time class="entry-date" datetime="2022-01-04T14:51:11-08:00">January 4, 2022</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/nickscheiblauer/" title="View all posts by nickscheiblauer" rel="author">nickscheiblauer</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><span style="font-weight: 400">When people think about tech and innovation, they often talk about the “next generation.”</span></p>
<p><span style="font-weight: 400">Just use GraphQL and life will be easier, many will tell you.</span></p>
<p><span style="font-weight: 400">The future of cloud-native is </span><i><span style="font-weight: 400">Lambda</span></i><span style="font-weight: 400">, claim others.</span></p>
<p><span style="font-weight: 400">Unfortunately, most of the conversations don’t talk about the question that is most top-of-mind for me: what does the next generation of tools look like </span><i><span style="font-weight: 400">for legacy systems</span></i><span style="font-weight: 400">?</span></p>
<p><span style="font-weight: 400">As a Senior Engineering Manager for Flickr’s backend team, here’s one of the major issues my team faces: we have a ton of code that engineers need to understand in order to safely and quickly ship changes. Flickr has built a product loved by millions of photographers for nearly two decades and we have some real history in our code base. You can imagine the amount of work it takes to maintain the stability of our large, complex, public-facing API—which impacts not just customers who use our API, but our own web, mobile, and desktop clients.</span></p>
<p><span style="font-weight: 400">The difficulty of wrangling a legacy code base is what led us to be interested in </span><a href="https://www.akitasoftware.com/"><span style="font-weight: 400">Akita</span></a><span style="font-weight: 400">, an observability company going after the dream of “one-click” observability. Akita’s first product passively watches API traffic using packet capture (PCAP) to provide automated API monitoring, automatically infer the structure of API endpoints, and automatically detect potential issues and breaking changes. Akita’s goal is to make it possible for organizations like ours, with our hundreds of thousands of lines of legacy code, to understand system behavior in order to move quickly.</span></p>
<p><span style="font-weight: 400">But there’s a catch: Akita’s first product, currently in beta, works only for representational state transfer (REST) APIs. Our API at Flickr, nearly twenty years old, coincides with the rise of REST. This blog post focuses on how I used Akita to introduce observability to our code base.</span></p>
<h2><span style="font-weight: 400">Moving fast with legacy systems</span></h2>
<p><span style="font-weight: 400">First, let me give some context on high-level responsibilities of backend engineering at Flickr. Since moving Flickr into the cloud two years ago we’ve had more time to focus on modernizing our services and improving our developer experience. This puts us in a much better position to build new features than before—but first, we need to streamline how we get things done, which is not nearly as simple as it sounds.</span></p>
<p><span style="font-weight: 400">Today, we serve up around a billion photos daily from millions of photographers. Nearly every Flickr API request executes legacy code in some way—code that is less tested, less documented, and sometimes dangerous to mess with. A great deal of care has to be taken to avoid disruptions. And when new features need to interact with older features, this can get complex fast! On top of all that, we need to find ways to help our small but mighty team focus their limited time and attention while navigating the old and the new, without the luxury of handing this problem over to an internal tools team.</span></p>
<p><span style="font-weight: 400">Our difficulty getting a handle on our legacy systems led us to become excited about using Akita for easy observability. Akita promised to tell us about our API interactions and potential issues with the API, all by passively watching API traffic. But there was, as I mentioned, a catch: Akita works only for REST APIs right now, and our API is… RESTish. Most notably, we never adopted the REST convention of using distinct URL paths for each service endpoint, and we rely heavily on passing parameters through the query string, or form-encoded in POSTs. This situation has historically made it hard for us to use other API tools as well.</span></p>
<h2><span style="font-weight: 400">Getting Akita to work for my REST-like format</span></h2>
<p><span style="font-weight: 400">Thankfully our PHP request handlers are plug and play so I quickly whipped up a new proof-of-concept handler showing that we </span><i><span style="font-weight: 400">could</span></i><span style="font-weight: 400"> start getting visibility into our API endpoints and their behavior using Akita. This gave me the ability to generate Akita traces using curl and the Akita command line interface (CLI) tool out of the box, but only within my local dev environment.</span></p>
<p><img class="alignnone size-medium wp-image-3620" src="https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-11-04-at-4.28.16-PM.png?w=800" alt="A screen shot of the Akita web console. The shot depicts the detected aPI specification of a single Flickr API call." width="800" height="334" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-11-04-at-4.28.16-PM.png 2450w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-11-04-at-4.28.16-PM.png?resize=150,63 150w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-11-04-at-4.28.16-PM.png?resize=800,334 800w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-11-04-at-4.28.16-PM.png?resize=768,321 768w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-11-04-at-4.28.16-PM.png?resize=1024,428 1024w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-11-04-at-4.28.16-PM.png?resize=1536,642 1536w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-11-04-at-4.28.16-PM.png?resize=2048,856 2048w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-11-04-at-4.28.16-PM.png?resize=500,209 500w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight: 400">Right away I spotted some things to improve, and more ideas came that afternoon. I wanted to put our `api_key` parameter into an Authorization header, and remove the `method` parameter since I’d used it in a fake service path. Also, our API returns a 200 HTTP Status on errors, including an element `stat` indicating failure. I wanted those to be HTTP 400s.</span></p>
<p><span style="font-weight: 400">But I had a conundrum: Akita works best when observing production traffic. Real, production API requests at production load will really fill in the nooks and crannies of our API models. My progress showed it would be </span><i><span style="font-weight: 400">so worth it</span></i><span style="font-weight: 400"> to go further, so I met with the Akita team and discussed using their Go-based plugin system to transform our live requests into a desirable format based on my proof-of-concept. It turns out that most of Akita’s tooling is </span><a href="https://github.com/akitasoftware/akita-cli"><span style="font-weight: 400">open source</span></a><span style="font-weight: 400"> and I could work on the plugin myself! This turned out to be the key to making Akita work with our RESTish format.</span></p>
<h2><span style="font-weight: 400">Fitting into the Go plugin format</span></h2>
<p><span style="font-weight: 400">Exciting news! I just needed to turn my prototype into something that I could run with the Akita agent every time.</span></p>
<p><span style="font-weight: 400">The Akita CLI has a mechanism for dynamically loading plugins, which can operate on the captured and parsed data before it is sent to the Akita cloud. My transformations of the API format into a more REST-like format could be packaged that way.</span></p>
<p><span style="font-weight: 400">I soon discovered that I was the first person to try building a third-party plugin. Akita told me that they used the plugin architecture internally to package a non-open-source plugin that infers data formats, but that is compiled into the client. </span></p>
<p><span style="font-weight: 400">My early attempts at working with the released CLI version resulted in nothing but discouraging error messages like:</span></p>
<p><em><span style="font-weight: 400">fatal error: runtime: no plugin module data</span></em></p>
<p><span style="font-weight: 400">I worked around this by compiling the open-source version of the Akita CLI myself and pointing the plugin build at the exact same version of the source code. An engineer at Akita reported the same problem and concluded that the plugin needed to be built at the same time as the program that will use it. Go’s idiosyncratic linking conventions seem to make it virtually impossible for such an external plugin to satisfy its dependencies against multiple versions of the base binary. Later, we learned the following from Russ Cox, confirming that our decision to abandon the external plugin approach was wise:</span></p>
<p><a href="https://twitter.com/_rsc/status/1459257455360229387"><span style="font-weight: 400">https://twitter.com/_rsc/status/1459257455360229387</span></a></p>
<p><img loading="lazy" class="alignnone size-medium wp-image-3622" src="https://code.flickr.net/wp-content/uploads/sites/3/2022/01/image3.png?w=767" alt="Screenshot of a Tweet from Russ Cox that responds to a quoted question asking what the Go Team's direction for Go Plugins is. Russ answers, &quot;Kind of rudderless right now. Higher priority things are taking all our cycles, so mostly benign neglect for plugins. Sorry.&quot;" width="767" height="355" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2022/01/image3.png 767w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/image3.png?resize=150,69 150w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/image3.png?resize=500,231 500w" sizes="(max-width: 767px) 100vw, 767px" /></p>
<p><span style="font-weight: 400">To make this process repeatable, we adopted a hybrid approach where I added the Flickr-specific transformations of the API as a plugin in a newly created Akita open source repository. (</span><a href="https://github.com/akitasoftware/plugin-flickr"><span style="font-weight: 400">You can check out the code here</span></a><span style="font-weight: 400">!) Akita will compile that plugin in all their future CLI builds so there would be no problem with dynamic loading. I can enable the plugin for my traces with a command-line flag and use the most recent version of the CLI without recompiling my plugin to match. This is the same way Akita incorporates modules for type inference. Other users can incorporate contributions in a similar way.</span></p>
<h2><span style="font-weight: 400">Using Akita to move faster</span></h2>
<p><span style="font-weight: 400">Now that we have the plugin written, we’re moving toward integration with our production environment. Here’s an example of what we’re able to understand with Akita. Note that the </span><em><span style="font-weight: 400">person.new</span></em><span style="font-weight: 400"> response element has been detected as both datetime and string data types. We should fix that!</span><img loading="lazy" class="alignnone size-medium wp-image-3621" src="https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-12-21-at-8.23.47-AM.png?w=800" alt="Another screenshot of the Akita web console. Two entries are highlighted, showing instances of mixed data types detected for the same field. " width="800" height="232" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-12-21-at-8.23.47-AM.png 2548w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-12-21-at-8.23.47-AM.png?resize=150,44 150w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-12-21-at-8.23.47-AM.png?resize=800,232 800w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-12-21-at-8.23.47-AM.png?resize=768,223 768w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-12-21-at-8.23.47-AM.png?resize=1024,297 1024w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-12-21-at-8.23.47-AM.png?resize=1536,446 1536w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-12-21-at-8.23.47-AM.png?resize=2048,595 2048w, https://code.flickr.net/wp-content/uploads/sites/3/2022/01/Screen-Shot-2021-12-21-at-8.23.47-AM.png?resize=500,145 500w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight: 400">Here’s what we’re integrating Akita to do:</span></p>
<ul>
<li><b>Taking snapshots of our API endpoints. </b><span style="font-weight: 400">Having a large API footprint makes it all the more important for us to generate defacto specifications and curate the result, rather than try to hand-write specifications from scratch. Once we have a solid OpenAPI3 specification we can make tactical changes to ensure the API adheres to the spec without doing a full-on rewrite of the backend.</span></li>
</ul>
<ul>
<li><b>Identifying changes to our API endpoints. </b><span style="font-weight: 400">The ability to detect unexpected or off-spec responses will make it a lot easier for us to code from the client side, particularly the Android and iOS mobile apps. We expect to reduce defensive exception handling on the client side, making our mobile code easier to work with and less of a resource hog. </span></li>
<li><b>Tracking our inter-service communication as we modernize our infrastructure. </b><span style="font-weight: 400">Observing the interaction between services is increasingly important as we use more and more microservices and refine our service oriented architecture. For example, having a high level view of impacted services during a production incident will expedite service recovery and get our users back to doing what they love.</span></li>
</ul>
<p><span style="font-weight: 400">While we currently have metrics, monitoring, and logging in place with AWS CloudWatch and Splunk, Akita is able to provide us the information we need in a structured, per-endpoint way, making it easier for our developers to understand what’s going on and focus their attention on what matters. Stay tuned for updates!</span></p>
<h2><span style="font-weight: 400">Thoughts on tools for legacy systems in general</span></h2>
<p><span style="font-weight: 400">I see our partnership with Akita as a key part of the beginning of our effort to innovate how to move fast with a legacy system. This problem is not unique to us: Facebook has built multiple type systems for multiple different dynamically typed languages to deal with it! But the fact that we can’t spin off dedicated teams to write compilers for PHP places its own set of constraints. And there are many companies that are in a similar boat: small or medium sized engineering teams of passionate, driven, smart people working on products they love and want you, their customer, to love, too.</span></p>
<p><span style="font-weight: 400">I love working on these sorts of problems because they are among the hardest to solve. It takes a lot more than finding a new database or coming up with a faster algorithm; working with large legacy codebases presents challenges that seem intractable. In my experience, you need the right balance of organization, process, tooling, and grit. </span></p>
<p><span style="font-weight: 400">Successful companies eventually reach the point where addressing these things is critical and necessary or delivering value slows to a crawl. I’ve found Flickr to be a unique combination of legacy systems, wonderful engineering heritage, and forward-looking, motivated people. If you work somewhere that would benefit from improved production and development observability, you should </span><a href="https://www.akitasoftware.com/"><span style="font-weight: 400">check out what Akita is up to</span></a><span style="font-weight: 400">. And if you’re interested in working with us here, check out the </span><a href="https://flickr.com/jobs"><span style="font-weight: 400">Flickr jobs page</span></a><span style="font-weight: 400">!</span></p>
<p>&nbsp;</p>
<p><em>Many thanks to Jean Yang, Mark Gritter, and the Akita team for their assistance with this post and our integration with their marvelous new product!</em></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3617 -->

				
					
	<article id="post-3599" class="post-3599 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2021/11/22/flickr-engineering-team-vision-guiding-principles/" rel="bookmark">Flickr Engineering Team Vision &#038; Guiding Principles</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2021/11/22/flickr-engineering-team-vision-guiding-principles/" title="4:00 pm" rel="bookmark"><time class="entry-date" datetime="2021-11-22T16:00:45-08:00">November 22, 2021</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/flickrengineering8/" title="View all posts by Alex Seville" rel="author">Alex Seville</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><span style="font-weight: 400;">There’s a rich history of engineering innovation and excellence at Flickr. The team has been involved in the development of specs and open standards, been an early adopter of technologies like NodeJS, and successfully migrated from Yahoo data centers to AWS in less than a year! </span></p>
<p><span style="font-weight: 400;">Through all the years, there has been a sense of vision and principles on the team, but nothing formally documented.  We were inspired by </span><a href="https://github.com/artsy/README/blob/master/culture/engineering-principles.md"><span style="font-weight: 400;">Artsy</span></a><span style="font-weight: 400;"> and </span><a href="https://www.amazon.jobs/en/landing_pages/pe-community-tenets"><span style="font-weight: 400;">Amazon</span></a><span style="font-weight: 400;"> to create a team vision and guiding principles, and share those with the team, job candidates, and the public.</span></p>
<p><span style="font-weight: 400;">We hope that this document evolves with the team, and look forward to discussing it with future coworkers!</span></p>
<p>&nbsp;</p>
<h2><strong>Flickr Engineering Team Vision</strong></h2>
<p><em><span style="font-weight: 400;">Flickr Engineering exists to design, build, and maintain software that enables the global community of photography enthusiasts to find inspiration, connect, and share. We succeed by building a culture of innovation, being generous with providing and soliciting feedback, embracing and sharing our strengths, and delivering consistently, reliably, and predictably.</span></em></p>
<p>&nbsp;</p>
<h2><strong>Flickr Engineering Guiding Principles</strong><b></b></h2>
<h3><b>1. Psychological Safety</b><b></b></h3>
<p><span style="font-weight: 400;">You and your coworkers are the most important element of the engineering organization. To learn, grow, and be productive as an engineer, you must feel safe at work. Everyone at Flickr Engineering, especially those in leadership positions, are responsible for fostering a psychologically safe work environment.</span></p>
<p><span style="font-weight: 400;">Ways to do that will include:</span></p>
<ul>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Admitting and discussing mistakes</span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Framing work as a learning experience</span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Ensuring communication and teamwork is inclusive and respectful</span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Growing a team comprised of individuals across various diverse backgrounds</span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Engaging in continuous feedback and praise to coworkers</span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Modeling open and respectful communication</span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Sharing knowledge and opportunities to help each other level up</span></li>
</ul>
<p><span style="font-weight: 400;">Further Reading:</span></p>
<ul>
<li style="list-style-type: none;">
<ul>
<li style="font-weight: 400;" aria-level="2"><a href="https://compassionatecoding.com/blog/2016/8/15/what-does-compassion-have-to-do-with-coding"><span style="font-weight: 400;">What Does Compassion have to do With Coding</span></a></li>
<li style="font-weight: 400;" aria-level="2"><a href="https://medium.com/artsy-blog/what-it-feels-like-to-work-in-a-supportive-environment-for-female-engineers-3c994a001007"><span style="font-weight: 400;">What it Feels Like to Work in a Supportive Environment for Female Engineers</span></a></li>
<li style="font-weight: 400;" aria-level="2"><a href="https://ashfurrow.com/blog/building-better-software-by-building-better-teams/"><span style="font-weight: 400;">Building Better Software by Building Better Teams</span></a></li>
<li style="font-weight: 400;" aria-level="2"><a href="https://hbr.org/2017/08/high-performing-teams-need-psychological-safety-heres-how-to-create-it"><span style="font-weight: 400;">High-Performing Teams Need Psychological Safety. Here’s How to Create It</span></a></li>
<li style="font-weight: 400;" aria-level="2"><a href="https://hackernoon.com/psychological-safety-risk-tolerance-and-high-functioning-software-teams-75701ed23f68"><span style="font-weight: 400;">Psychological Safety, Risk Tolerance and High Functioning Software Teams</span></a></li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3><b>2. Incremental Revolution</b><b></b></h3>
<p><span style="font-weight: 400;">Introduce new technologies slowly and incrementally. Avoid re-writes. Build tools to allow hybrids of different types of technology when possible. Sometimes you need to make a big leap, but aim to approach them incrementally.</span></p>
<p><span style="font-weight: 400;">Explore bleeding-edge technologies on projects with an end-date that can become safely classed “done.” These can be used to inform decisions on long-running projects. Run spike projects when trying to settle between technology trade-offs.</span></p>
<p><span style="font-weight: 400;">Examples include:</span><span style="font-weight: 400;"><br />
</span></p>
<ul>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Developing or adapting code to macro-services </span></li>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Avoid creating more stacks to support, by not anticipating the scale of the work involved</span></li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3><b>3. Own Your Dependencies</b><b></b></h3>
<p><span style="font-weight: 400;">Take the dependencies which fit your problem and make them better. If there&#8217;s no perfect match, take a 90% fit and contribute back to get it to 100%.</span></p>
<p><span style="font-weight: 400;">We use dependencies to save re-inventing, but it doesn’t mean our responsibility stops at installing it. Security patches, updates, roadmap changes are all vital to be aware of and tracked.</span></p>
<p><span style="font-weight: 400;">Our goal will be to feel like we can influence the design and execution of all the components in our apps. Aim to be a trusted contributor to the communities surrounding your work, communicate clearly and publicly, and be empathetic to the priorities of others.</span></p>
<p><span style="font-weight: 400;">Examples:</span></p>
<ul>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Node modules for NodeJS projects</span></li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3><b>4. Done Means Done</b><b></b></h3>
<p><span style="font-weight: 400;">Being responsible for your code extends beyond delivery date. Done being done means feeling confident that you&#8217;ve protected your changes with tests, ensured deployment works, and feel confident in your tools for measuring.</span></p>
<p><span style="font-weight: 400;">When something is done, it doesn&#8217;t mean that you&#8217;ll never need to go back to it, but that going back to it is a new project. It&#8217;s done.</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3><b>5. Build for 10x</b><b></b></h3>
<p><span style="font-weight: 400;">Technology choices should strive to be optimal while avoiding over-engineering. When designing systems or evaluating scalability and performance, we aim for today&#8217;s decisions to withstand 10x the traffic, data, or scale. Flickr is big and we can’t always anticipate the way a feature of a system will be used, especially as things evolve, but scale has always increased. This realistic horizon helps us balance the need to move quickly with the sometimes-competing need to invest in infrastructure and architecture. It also recognizes that solutions are expected to evolve and be replaced.</span></p>
<ul>
<li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Further Reading</span>
<ul>
<li style="font-weight: 400;" aria-level="2"><a href="https://lethain.com/migrations/"><span style="font-weight: 400;">Migrations: the sole scalable fix to tech debt</span></a></li>
<li style="font-weight: 400;" aria-level="2"><a href="https://lethain.com/productivity-in-the-age-of-hypergrowth/"><span style="font-weight: 400;">Productivity in the age of hypergrowth.</span></a></li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3><b>6. Appreciate What Came Before</b><b></b></h3>
<p><span style="font-weight: 400;">We respect our predecessors and the decisions they made. We can’t always know the context, constraints, or reasons for a decision, so we’ll give them the benefit of the doubt.</span></p>
<p><span style="font-weight: 400;">We appreciate the value of working systems and the lessons they embody. We understand that many problems are not essentially new.</span></p>
<p><span style="font-weight: 400;">We learn together from mistakes, and appreciate it as an experience that helps us grow.</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3599 -->

				
					
	<article id="post-3590" class="post-3590 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2018/04/20/together/" rel="bookmark">Together</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2018/04/20/together/" title="3:15 pm" rel="bookmark"><time class="entry-date" datetime="2018-04-20T15:15:17-07:00">April 20, 2018</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/almonroth/" title="View all posts by Matthew Roth" rel="author">Matthew Roth</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>Flickr is excited to be <a href="https://www.smugmug.com/together">joining SmugMug</a>!</p>
<p>We’re looking forward to some interesting and challenging engineering projects in the next year, and would love to have more great people join the team!</p>
<p>We want to talk to people who are interested in working on an inclusive, diverse team, building large-scale systems that are backing a much-loved product.</p>
<p>You can learn more about open positions at: <a href="http://jobs.smugmug.com/">http://jobs.smugmug.com/</a></p>
<p>Read our <a href="https://blog.flickr.net/en/2018/04/20/together-smugmug-flickr/">announcement blog post</a> and <a href="https://blog.flickr.net/en/2018/04/20/together-smugmug-flickr-faq/">our extended Q&amp;A</a> for more details.</p>
<p>~The Flickr Team</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3590 -->

				
					
	<article id="post-3571" class="post-3571 post type-post status-publish format-standard hentry category-uncategorized tag-machine-learning tag-machine-tags tag-neural-network tag-similarity-search tag-visual-similarity">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/" rel="bookmark">Introducing Similarity Search at Flickr</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/" title="6:04 pm" rel="bookmark"><time class="entry-date" datetime="2017-03-07T18:04:36-08:00">March 7, 2017</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/claytonhoo/" title="View all posts by Clayton Mellina" rel="author">Clayton Mellina</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><span style="font-weight:400;">At Flickr, we understand that the value in our image corpus is only unlocked when our members can find photos and photographers that inspire them, so we strive to enable the discovery and appreciation of new photos.</span></p>
<p><span style="font-weight:400;">To further that effort, today we are introducing </span><b>similarity search</b><span style="font-weight:400;"> on Flickr. If you hover over a photo on a search result page, you will reveal a “&#8230;” button that exposes a menu that gives you the option to search for photos similar to the photo you are currently viewing.</span></p>
<p><span style="font-weight:400;">In many ways, photo search is very different from traditional web or text search. First, the goal of web search is usually to satisfy a particular information need, while with photo search the goal is often one of </span><i><span style="font-weight:400;">discovery</span></i><span style="font-weight:400;">; as such, it should be delightful as well as functional. We have taken this to heart throughout Flickr. For instance, our color search feature, which allows filtering by color scheme, and our style filters, which allow filtering by styles such as “minimalist” or “patterns,” encourage exploration. Second, in traditional web search, the goal is usually to match documents to a set of keywords in the query. That is, the query is in the same modality—text—as the documents being searched. Photo search usually matches </span><i><span style="font-weight:400;">across</span></i><span style="font-weight:400;"> modalities: text to image. Text querying is a necessary feature of a photo search engine, but, as the saying goes, a picture is worth a thousand words. And beyond saving people the effort of so much typing, many visual concepts genuinely defy accurate description. Now, we’re giving our community a way to easily explore those visual concepts with the “&#8230;” button, a feature we call the </span><b>similarity pivot</b><span style="font-weight:400;">.</span></p>
<p><img loading="lazy" class="alignnone size-medium wp-image-3572" src="https://wp.flickr.net/wp-content/uploads/sites/3/2017/03/demo.gif?w=800" alt="" width="800" height="412" /></p>
<p><span style="font-weight:400;">The similarity pivot is a significant addition to the Flickr experience because it offers our community an entirely new way to explore and discover the billions of incredible photos and millions of incredible photographers on Flickr. It allows people to look for </span><a href="https://www.flickr.com/search/?similarity_id=29327172003"><span style="font-weight:400;">images of a particular style</span></a><span style="font-weight:400;">, it gives people a view into </span><a href="https://www.flickr.com/search/?similarity_id=5742058855"><span style="font-weight:400;">universal behaviors</span></a><span style="font-weight:400;">, and even when it “messes up,” it can force people to look at the </span><a href="https://www.flickr.com/search/?similarity_id=14198128453"><span style="font-weight:400;">unexpected</span></a> <a href="https://www.flickr.com/search/?similarity_id=28863966765"><span style="font-weight:400;">commonalities</span></a><span style="font-weight:400;"> and </span><a href="https://www.flickr.com/search/?similarity_id=8002923505"><span style="font-weight:400;">oddities</span></a><span style="font-weight:400;"> of our visual world with a </span><a href="https://www.flickr.com/search/?similarity_id=13759436465"><span style="font-weight:400;">fresh</span></a> <a href="https://www.flickr.com/search/?similarity_id=15346205045"><span style="font-weight:400;">perspective</span></a><span style="font-weight:400;">.</span></p>
<h2><span style="font-weight:400;">What is “similarity”?</span></h2>
<p><span style="font-weight:400;">To understand how an experience like this is powered, we first need to understand what we mean by “similarity.” There are many ways photos can be similar to one another. Consider some examples.</span></p>
<p><img loading="lazy" class="alignnone size-medium wp-image-3573" src="https://wp.flickr.net/wp-content/uploads/sites/3/2017/03/color_sim.png?w=800" alt="" width="800" height="343" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2017/03/color_sim.png 1033w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/color_sim.png?resize=150,64 150w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/color_sim.png?resize=800,343 800w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/color_sim.png?resize=768,329 768w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/color_sim.png?resize=1024,439 1024w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/color_sim.png?resize=500,214 500w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><img loading="lazy" class="alignnone size-medium wp-image-3576" src="https://wp.flickr.net/wp-content/uploads/sites/3/2017/03/texture_sim.png?w=800" alt="" width="800" height="343" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2017/03/texture_sim.png 1030w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/texture_sim.png?resize=150,64 150w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/texture_sim.png?resize=800,343 800w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/texture_sim.png?resize=768,330 768w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/texture_sim.png?resize=1024,439 1024w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/texture_sim.png?resize=500,215 500w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><img loading="lazy" class="alignnone size-medium wp-image-3575" src="https://wp.flickr.net/wp-content/uploads/sites/3/2017/03/semantic_sim.png?w=800" alt="" width="800" height="344" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2017/03/semantic_sim.png 1029w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/semantic_sim.png?resize=150,65 150w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/semantic_sim.png?resize=800,344 800w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/semantic_sim.png?resize=768,331 768w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/semantic_sim.png?resize=1024,441 1024w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/semantic_sim.png?resize=500,215 500w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight:400;">It is apparent that all of these groups of photos illustrate some notion of “similarity,” but each is different. Roughly, they are: similarity of color, similarity of texture, and similarity of semantic category. And there are many others that you might imagine as well.</span></p>
<p>What notion of similarity is best suited for a site like Flickr? Ideally, we’d like to be able to capture multiple types of similarity, but we decided early on that semantic similarity—similarity based on the semantic content of the photos—was vital to facilitate discovery on Flickr. This requires a deep understanding of image content for which we employ deep neural networks.</p>
<p>We have been using deep neural networks at Flickr for a while for various tasks such as object recognition, NSFW prediction, and even prediction of aesthetic quality. For these tasks, we train a neural network to map the raw pixels of a photo into a set of relevant tags, as illustrated below.</p>
<p><img loading="lazy" class="alignnone size-medium wp-image-3578" src="https://wp.flickr.net/wp-content/uploads/sites/3/2017/03/nn_tag.png?w=800" alt="" width="800" height="230" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_tag.png 1408w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_tag.png?resize=150,43 150w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_tag.png?resize=800,230 800w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_tag.png?resize=768,220 768w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_tag.png?resize=1024,294 1024w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_tag.png?resize=1000,288 1000w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_tag.png?resize=500,143 500w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight:400;">Internally, the neural network accomplishes this mapping incrementally by applying a series of transformations to the image, which can be thought of as a vector of numbers corresponding to the pixel intensities. Each transformation in the series produces another vector, which is in turn the input to the next transformation, until finally we have a vector that we specifically constrain to be a list of probabilities for each class we are trying to recognize in the image. To be able to go from raw pixels to a semantic label like “hot air balloon,” the network discards lots of information about the image, including information about  appearance, such as the color of the balloon, its relative position in the sky, etc. Instead, we can extract an internal vector in the network before the final output.</span></p>
<p><img loading="lazy" class="alignnone size-medium wp-image-3579" src="https://wp.flickr.net/wp-content/uploads/sites/3/2017/03/nn_feature.png?w=800" alt="" width="800" height="458" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_feature.png 1244w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_feature.png?resize=150,86 150w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_feature.png?resize=800,458 800w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_feature.png?resize=768,440 768w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_feature.png?resize=1024,586 1024w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/nn_feature.png?resize=500,286 500w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight:400;">For common neural network architectures, this vector—which we call a “feature vector”—has many hundreds or thousands of dimensions. We can’t necessarily say with certainty that any one of these dimensions means something in particular as we could at the final network output, whose dimensions correspond to tag probabilities. But these vectors have an important property: when you compute the </span><a href="https://en.wikipedia.org/wiki/Euclidean_distance"><span style="font-weight:400;">Euclidean distance</span></a><span style="font-weight:400;"> between these vectors, images containing similar content will tend to have feature vectors closer together than images containing dissimilar content. You can think of this as a way that the network has learned to organize information present in the image so that it can output the required class prediction. This is exactly what we are looking for: Euclidian distance in this high-dimensional feature space is a measure of semantic similarity. The graphic below illustrates this idea: points in the neighborhood around the query image are semantically similar to the query image, whereas points in neighborhoods further away are not.</span></p>
<p><img loading="lazy" class="alignnone size-medium wp-image-3580" src="https://wp.flickr.net/wp-content/uploads/sites/3/2017/03/retrieval.png?w=800" alt="" width="800" height="366" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2017/03/retrieval.png 1686w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/retrieval.png?resize=150,69 150w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/retrieval.png?resize=800,366 800w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/retrieval.png?resize=768,352 768w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/retrieval.png?resize=1024,469 1024w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/retrieval.png?resize=1536,703 1536w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/retrieval.png?resize=500,229 500w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight:400;">This measure of similarity is not perfect and cannot capture all possible notions of similarity—it will be constrained by the particular task the network was trained to perform, i.e., scene recognition. However, it is effective for our purposes, and, importantly, it contains information beyond merely the semantic content of the image, such as appearance, composition, and texture. Most importantly, it gives us a simple algorithm for finding visually similar photos: compute the distance in the feature space of a query image to each index image and return the images with lowest distance. Of course, there is much more work to do to make this idea work for billions of images.</span></p>
<h2><span style="font-weight:400;">Large-scale approximate nearest neighbor search</span></h2>
<p><span style="font-weight:400;">With an index as large as Flickr’s, computing distances exhaustively for each query is intractable. Additionally, storing a high-dimensional floating point feature vector for each of billions of images takes a large amount of disk space and poses even more difficulty if these features need to be in memory for fast ranking. To solve these two issues, we adopt a state-of-the-art approximate nearest neighbor algorithm called </span><a href="http://image.ntua.gr/iva/files/lopq.pdf"><span style="font-weight:400;">Locally Optimized Product Quantization</span></a><span style="font-weight:400;"> (LOPQ).</span></p>
<p><span style="font-weight:400;">To understand LOPQ, it is useful to first look at a simple strategy. Rather than ranking all vectors in the index, we can first filter a set of good candidates and only do expensive distance computations on them. For example, we can use an algorithm like </span><a href="https://en.wikipedia.org/wiki/K-means_clustering"><i><span style="font-weight:400;">k</span></i><span style="font-weight:400;">-means</span></a><span style="font-weight:400;"> to cluster our index vectors, find the cluster to which each vector is assigned, and index the corresponding cluster id for each vector. At query time, we find the cluster that the query vector is assigned to and fetch the items that belong to the same cluster from the index. We can even expand this set if we like by fetching items from the next nearest cluster.</span></p>
<p><span style="font-weight:400;">This idea will take us far, but not far enough for a billions-scale index. For example, with 1 billion photos, we need 1 million clusters so that each cluster contains an average of 1000 photos. At query time, we will have to compute the distance from the query to each of these 1 million cluster centroids in order to find the nearest clusters. This is quite a lot. We can do better, however, if we instead split our vectors in half by dimension and cluster each half separately. In this scheme, each vector will be assigned to a pair of cluster ids, one for each half of the vector. If we choose k = 1000 to cluster both halves, we have k<sup>2</sup>= 1000 * 1000 = 1e6 possible pairs. In other words, by clustering each half separately and assigning each item a pair of cluster ids, we can get the same granularity of partitioning (1 million clusters total) with only 2 * 1000 distance computations with half the number of dimensions for a total computational savings of 1000x. Conversely, for the same computational cost, we gain a factor of k more partitions of the data space, providing a much finer-grained index.</span></p>
<p><span style="font-weight:400;">This idea of splitting vectors into subvectors and clustering each split separately is called </span><a href="https://lear.inrialpes.fr/pubs/2011/JDS11/jegou_searching_with_quantization.pdf"><i><span style="font-weight:400;">product quantization</span></i></a><span style="font-weight:400;">. When we use this idea to index a dataset it is called the </span><a href="http://cache-ash04.cdn.yandex.net/download.yandex.ru/company/cvpr2012.pdf"><i><span style="font-weight:400;">inverted multi-index</span></i></a><span style="font-weight:400;">, and it forms the basis for fast candidate retrieval in our similarity index. Typically the distribution of points over the clusters in a multi-index will be unbalanced as compared to a standard k-means index, but this unbalance is a fair trade for the much higher resolution partitioning that it buys us. In fact, a multi-index will only be balanced across clusters if the two halves of the vectors are perfectly statistically independent. This is not the case in most real world data, but some heuristic preprocessing—like </span><a href="https://en.wikipedia.org/wiki/Principal_component_analysis"><span style="font-weight:400;">PCA-ing</span></a><span style="font-weight:400;"> and permuting the dimensions so that the cumulative per-dimension variance is approximately balanced between the halves—helps in many cases. And just like the simple k-means index, there is a fast algorithm for finding a ranked list of clusters to a query if we need to expand the candidate set.</span></p>
<p><span style="font-weight:400;">After we have a set of candidates, we must rank them. We could store the full vector in the index and use it to compute the distance for each candidate item, but this would incur a large memory overhead (for example, 256 dimensional vectors of 4 byte floats would require 1Tb for 1 billion photos) as well as a computational overhead. LOPQ solves these issues by performing another product quantization, this time on the </span><i><span style="font-weight:400;">residuals</span></i><span style="font-weight:400;"> of the data. The residual of a point is the difference vector between the point and its closest cluster centroid. Given a residual vector and the cluster indexes along with the corresponding centroids, we have enough information to reproduce the original vector exactly. Instead of storing the residuals, LOPQ product quantizes the residuals, usually with a higher number of splits, and stores only the cluster indexes in the index. For example, if we split the vector into 8 splits and each split is clustered with 256 centroids, we can store the compressed vector with only 8 bytes regardless of the number of dimensions to start (though certainly a higher number of dimensions will result in higher approximation error). With this </span><a href="https://en.wikipedia.org/wiki/Lossy_compression"><span style="font-weight:400;">lossy representation</span></a><span style="font-weight:400;"> we can produce a reconstruction of a vector from the 8 byte codes: we simply take each quantization code, look up the corresponding centroid, and concatenate these 8 centroids together to produce a reconstruction. Likewise, we can approximate the distance from the query to an index vector by computing the distance between the query and the reconstruction. We can do this computation quickly for many candidate points by computing the squared difference of each split of the query to all of the centroids for that split. After computing this table, we can compute the squared difference for an index point by looking up the precomputed squared difference for each of the 8 indexes and summing them together to get the total squared difference. This caching trick allows us to quickly rank many candidates without resorting to distance computations in the original vector space.</span></p>
<p>LOPQ adds one final detail: for each cluster in the multi-index, LOPQ fits a local rotation to the residuals of the points that fall in that cluster. This rotation is simply a PCA that aligns the major directions of variation in the data to the axes followed by a permutation to heuristically balance the variance across the splits of the product quantization. Note that this is the exact preprocessing step that is usually performed at the top-level multi-index. It tends to make the approximate distance computations more accurate by mitigating errors introduced by assuming that each split of the vector in the production quantization is statistically independent from other splits. Additionally, since a rotation is fit for each cluster, they serve to fit the local data distribution better.</p>
<p>Below is a diagram from the LOPQ paper that illustrates the core ideas of LOPQ. K-means (a) is very effective at allocating cluster centroids, illustrated as red points, that target the distribution of the data, but it has other drawbacks at scale as discussed earlier. In the 2d example shown, we can imagine product quantizing the space with 2 splits, each with 1 dimension. Product Quantization (b) clusters each dimension independently and cluster centroids are specified by pairs of cluster indexes, one for each split. This is effectively a grid over the space. Since the splits are treated as if they were statistically independent, we will, unfortunately, get many clusters that are “wasted” by not targeting the data distribution. We can improve on this situation by rotating the data such that the main dimensions of variation are axis-aligned. This version, called Optimized Product Quantization (c), does a better job of making sure each centroid is useful. LOPQ (d) extends this idea by first coarsely clustering the data and then doing a separate instance of OPQ for each cluster, allowing highly targeted centroids while still reaping the benefits of product quantization in terms of scalability.</p>
<p><img loading="lazy" class="alignnone size-medium wp-image-3581" src="https://wp.flickr.net/wp-content/uploads/sites/3/2017/03/lopq.png?w=800" alt="" width="800" height="689" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2017/03/lopq.png 1022w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/lopq.png?resize=150,129 150w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/lopq.png?resize=800,689 800w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/lopq.png?resize=768,661 768w, https://code.flickr.net/wp-content/uploads/sites/3/2017/03/lopq.png?resize=348,300 348w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight:400;">LOPQ is state-of-the-art for quantization methods, and you can find more information about the algorithm, as well as benchmarks, </span><a href="http://image.ntua.gr/iva/research/lopq/"><span style="font-weight:400;">here</span></a><span style="font-weight:400;">. Additionally, we provide an </span><a href="https://github.com/yahoo/lopq"><span style="font-weight:400;">open-source implementation</span></a><span style="font-weight:400;"> in Python and Spark which you can apply to your own datasets. The algorithm produces a set of cluster indexes that can be queried efficiently in an inverted index, as described. We have also explored use cases that use these indexes as a hash for fast deduplication of images and large-scale clustering. These extended use cases are studied </span><a href="https://arxiv.org/abs/1604.06480"><span style="font-weight:400;">here</span></a><span style="font-weight:400;">.</span></p>
<h2><span style="font-weight:400;">Conclusion</span></h2>
<p><span style="font-weight:400;">We have described our system for large-scale visual similarity search at Flickr. Techniques for producing high-quality vector representations for images with deep learning are constantly improving, enabling new ways to search and explore large multimedia collections. These techniques are being applied in other domains as well to, for example, produce vector representations for </span><a href="https://en.wikipedia.org/wiki/Word2vec"><span style="font-weight:400;">text</span></a><span style="font-weight:400;">, </span><a href="https://arxiv.org/pdf/1502.04681.pdf"><span style="font-weight:400;">video</span></a><span style="font-weight:400;">, and even </span><a href="https://arxiv.org/pdf/1603.00856.pdf"><span style="font-weight:400;">molecules</span></a><span style="font-weight:400;">. Large-scale approximate nearest neighbor search has importance and potential application in these domains as well as many others. Though these techniques are in their infancy, we hope similarity search provides a useful new way to appreciate the amazing collection of images at Flickr and surface photos of interest that may have previously gone undiscovered. We are excited about the future of this technology at Flickr and beyond.</span></p>
<p><b>Acknowledgements</b></p>
<p><span style="font-weight:400;">Yannis Kalantidis, Huy Nguyen, Stacey Svetlichnaya, Arel Cordero. Special thanks to the rest of the Computer Vision and Machine Learning team and the Vespa search team who manages Yahoo’s internal search engine.</span></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="https://code.flickr.net/tag/machine-learning/" rel="tag">machine learning</a>, <a href="https://code.flickr.net/tag/machine-tags/" rel="tag">machine tags</a>, <a href="https://code.flickr.net/tag/neural-network/" rel="tag">neural network</a>, <a href="https://code.flickr.net/tag/similarity-search/" rel="tag">similarity search</a>, <a href="https://code.flickr.net/tag/visual-similarity/" rel="tag">visual similarity</a>			</span>
						
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3571 -->

				
					
	<article id="post-3550" class="post-3550 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2017/01/05/a-year-without-a-byte/" rel="bookmark">A Year Without a Byte</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2017/01/05/a-year-without-a-byte/" title="1:47 am" rel="bookmark"><time class="entry-date" datetime="2017-01-05T01:47:56-08:00">January 5, 2017</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/archieflickr/" title="View all posts by Archie Russell" rel="author">Archie Russell</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>One of the largest cost drivers in running a service like Flickr is storage. We&#8217;ve described multiple techniques to get this cost down over the years: use of <a href="https://yahooeng.tumblr.com/post/116391291701/yahoo-cloud-object-store-object-storage-at">COS</a>, <a href="http://code.flickr.net/2015/06/25/real-time-resizing-of-flickr-images-using-gpus">creating sizes dynamically</a> on GPUs and <a href="http://code.flickr.net/2015/09/25/perceptual-image-compression-at-flickr/">perceptual compression</a>. These projects have been very successful, but our storage cost is still significant.<br />
At the beginning of 2016, we challenged ourselves to go further &#8212; to go a full year without needing new storage hardware. Using multiple techniques, we got there.</p>
<h2>The Cost Story</h2>
<p>A little back-of-the-envelope math shows storage costs are a real concern. On a very high-traffic day, Flickr users upload as many as twenty-five million photos. These photos require an average of 3.25 megabytes of storage each, totalling over 80 terabytes of data. Stored naively in a cloud service similar to S3, this day&#8217;s worth of data would cost over $30,000 per year, and continue to incur costs every year.</p>
<p>And a very large service will have over two hundred million active users. At a thousand images each, storage in a service similar to S3 would cost over $250 million per year (or $1.25 / user-year) plus network and other expenses. This compounds as new users sign up and existing users continue to take photos at an accelerating rate. Thankfully, our costs, and <em>every</em> large service&#8217;s costs, are different than storing naively at S3, but remain significant.</p>
<p class="figure"><img loading="lazy" src="https://c1.staticflickr.com/1/445/32109964665_f465976673_o.png" alt="" width="800" height="600" /><br />
<span class="caption"><br />
Cost per byte have decreased, but bytes per image from iPhone-type platforms have increased. Cost per image hasn&#8217;t changed significantly.<br />
</span></p>
<p>Storage costs <em>do</em> drop over time. For example, S3 costs dropped from $0.15 per gigabyte month in 2009 to $0.03 per gigabyte-month in 2014, and cloud storage vendors have added low-cost options for data that is infrequently accessed. NAS vendors have also delivered large price reductions.</p>
<p>Unfortunately, these lower costs <em>per byte</em> are counteracted by other forces. On iPhones, increasing camera resolution, burst mode and the addition of short animations (Live Photos) have increased bytes-per-image rapidly enough to keep storage cost <em>per image</em> roughly constant. And iPhone images are far from the largest.</p>
<p>In response to these costs, photo storage services have pursued a variety of product options. To name a few: storing lower quality images or re-compressing, charging users for their data usage, incorporating advertising, selling associated products such as prints, and tying storage to purchases of handsets.</p>
<p>There are also a number of engineering approaches to controlling storage costs. We sketched out a few and cover three that we implemented below: adjusting thresholds on our storage systems, rolling out existing savings approaches to more images, and deploying lossless JPG compression.</p>
<h2>Adjusting Storage Thresholds</h2>
<p>As we dug into the problem, we looked at our storage systems in detail. We discovered that our settings were based on assumptions about high write and delete loads that didn&#8217;t hold. Our storage is pretty static. Users only rarely delete or change images once uploaded. We also had two distinct areas of just-in-case space. 5% of our storage was reserved space for snapshots, useful for undoing accidental deletes or writes, and 8.5% was held free in reserve. This resulted in about 13% of our storage going unused. Trade lore states that disks should remain 10% free to avoid performance degradation, but we found 5% to be sufficient for our workload. So we combined our our two just-in-case areas into one and reduced our free space threshold to that level. This was our simplest approach to the problem (by far), but it resulted in a large gain. With a couple simple configuration changes, we freed up more than 8% of our storage.</p>
<p class="figure"><img loading="lazy" src="https://c1.staticflickr.com/1/267/31961928142_a5f68d8501_o.png" alt="" width="800" height="600" /><br />
<span class="caption"><br />
Adjusting storage thresholds<br />
</span></p>
<h2>Extending Existing Approaches</h2>
<p>In our earlier posts, we have described dynamic generation of thumbnail sizes and perceptual compression. Combining the two approaches decreased thumbnail storage requirements by 65%, though we hadn&#8217;t applied these techniques to many of our images uploaded prior to 2014. One big reason for this: large-scale changes to older files are inherently risky, and require significant time and engineering work to do safely.</p>
<p>Because we were concerned that further rollout of dynamic thumbnail generation would place a heavy load on our resizing infrastructure, we targeted only thumbnails from less-popular images for deletes. Using this approach, we were able to handle our complete resize load with just four GPUs. The process put a heavy load on our storage systems; to minimize the impact we randomized our operations across volumes. The entire process took about four months, resulting in even more significant gains than our storage threshold adjustments.</p>
<p class="figure"><img loading="lazy" src="https://c1.staticflickr.com/1/315/31269155834_a74f75a611_o.png" alt="" width="800" height="600" /><br />
<span class="caption"><br />
Decreasing the number of thumbnail sizes<br />
</span></p>
<h2>Lossless JPG Compression</h2>
<p>Flickr has had a long-standing commitment to keeping uploaded images byte-for-byte intact. This has placed a floor on how much storage reduction we can do, but there are tools that can losslessly compress JPG images. Two well-known options are <a href="http://www.elektronik.htw-aalen.de/packjpg/">PackJPG</a> and <a href="https://blogs.dropbox.com/tech/2016/07/lepton-image-compression-saving-22-losslessly-from-images-at-15mbs">Lepton</a>, from Dropbox. These tools work by decoding the JPG, then very carefully compressing it using a more efficient approach. This typically shrinks a JPG by about 22%. At Flickr&#8217;s scale, this is significant. The downside is that these re-compressors use a lot of CPU. PackJPG compresses at about 2MB/s on a single core, or about fifteen core-years for a single petabyte worth of JPGs. Lepton uses multiple cores and, at 15MB/s, is much faster than packJPG, but uses roughly the same amount of CPU time.</p>
<p>This CPU requirement also complicated on-demand serving. If we recompressed all the images on Flickr, we would need potentially thousands of cores to handle our decompress load. We considered putting some restrictions on access to compressed images, such as requiring users to login to access original images, but ultimately found that if we targeted only rarely accessed private images, decompressions would occur only infrequently. Additionally, restricting the maximum size of images we compressed limited our CPU time per decompress. We rolled this out as a component of our existing serving stack without requiring any additional CPUs, and with only minor impact to user experience.</p>
<p>Running our users&#8217; original photos through lossless compression was probably our highest-risk approach. We can recreate thumbnails easily, but a corrupted source image cannot be recovered. Key to our approach was a re-compress-decompress-verify strategy: every recompressed image was decompressed and compared to its source before removing the uncompressed source image.</p>
<p>This is still a work-in-progress. We have compressed many images but to do our entire corpus is a lengthy process, and we had reached our zero-new-storage-gear goal by mid-year.</p>
<h2>On The Drawing Board</h2>
<p>We have several other ideas which we&#8217;ve investigated but haven&#8217;t implemented yet.</p>
<p>In our current storage model, we have originals and thumbnails available for every image, each stored in two datacenters. This model assumes that the images need to be viewable relatively quickly at any point in time. But private images belonging to accounts that have been inactive for more than a few months are unlikely to be accessed. We could &#8220;freeze&#8221; these images, dropping their thumbnails and recreate them when the dormant user returns. This &#8220;thaw&#8221; process would take under thirty seconds for a typical account. Additionally, for photos that are private (but not dormant), we could go to a single uncompressed copy of each thumbnail, storing a compressed copy in a second datacenter that would be decompressed as needed.</p>
<p>We might not even need two copies of each dormant original image available on disk. We&#8217;ve pencilled out a model where we place one copy on a slower, but underutilized, tape-based system while leaving the other on disk. This would decrease availability during an outage, but as these images belong to dormant users, the effect would be minimal and users would still see their thumbnails. The delicate piece here is the placement of data, as seeks on tape systems are prohibitively slow. Depending on the details of what constitutes a &#8220;dormant&#8221; photo these techniques could comfortably reduce storage used by over 25%.</p>
<p>We&#8217;ve also looked into de-duplication, but we found our duplicate rate is in the 3% range. Users do have many duplicates of their <em>own</em> images on their devices, but these are excluded by our upload tools.  We&#8217;ve also looked into using alternate image formats for our thumbnail storage.    <a href="https://developers.google.com/speed/webp/">WebP</a> can be much more compact than ordinary JPG but our use of perceptual compression gets us close to WebP byte size and permits much faster resize.  The <a href="http://bellard.org/bpg/">BPG</a> project proposes a <em>dramatically</em> smaller, H.265 based encoding but has IP and other issues.</p>
<p>There are several similar optimizations available for videos. Although Flickr is primarily image-focused, videos are typically much larger than images and consume considerably more storage.</p>
<h2>Conclusion</h2>
<p class="figure"><img loading="lazy" src="https://c1.staticflickr.com/1/751/32071867876_1cd6466b9a_o.png" alt="" width="800" height="600" /><br />
<span class="caption"><br />
Optimization over several releases<br />
</span></p>
<p>Since 2013 we&#8217;ve optimized our usage of storage by nearly 50%.  Our latest efforts helped us get through 2016 without purchasing any additional storage,  and we still have a few more options available.</p>
<p>Peter Norby, Teja Komma, Shijo Joy and Bei Wu formed the core team for our zero-storage-budget project. Many others assisted the effort.</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3550 -->

				
					
	<article id="post-3432" class="post-3432 post type-post status-publish format-standard hentry category-uncategorized tag-careers tag-jobs">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2016/05/11/we-want-you-and-your-teammates/" rel="bookmark">We Want You&#8230; and Your Teammates</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2016/05/11/we-want-you-and-your-teammates/" title="8:19 pm" rel="bookmark"><time class="entry-date" datetime="2016-05-11T20:19:40-07:00">May 11, 2016</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/xanthet/" title="View all posts by Xanthe Travlos" rel="author">Xanthe Travlos</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><a href="https://www.flickr.com/jobs"><span style="font-weight:400;"><img loading="lazy" class="size-medium wp-image-3436 aligncenter" src="https://wp.flickr.net/wp-content/uploads/sites/3/2016/05/14493569810_7ac064e3c4_o.jpg?w=800" alt="14493569810_7ac064e3c4_o" width="800" height="210" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2016/05/14493569810_7ac064e3c4_o.jpg 9208w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/14493569810_7ac064e3c4_o.jpg?resize=150,39 150w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/14493569810_7ac064e3c4_o.jpg?resize=800,210 800w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/14493569810_7ac064e3c4_o.jpg?resize=768,202 768w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/14493569810_7ac064e3c4_o.jpg?resize=1024,269 1024w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/14493569810_7ac064e3c4_o.jpg?resize=1536,404 1536w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/14493569810_7ac064e3c4_o.jpg?resize=2048,538 2048w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/14493569810_7ac064e3c4_o.jpg?resize=500,131 500w" sizes="(max-width: 800px) 100vw, 800px" /></span></a><a href="https://www.flickr.com/jobs"><span style="font-weight:400;">We&#8217;re hiring here at Flickr</span></a><span style="font-weight:400;"> and we got pretty excited the other week when we saw Stripe’s post: </span><a href="https://stripe.com/blog/bring-your-own-team"><span style="font-weight:400;">BYOT (Bring Your Own Team)</span></a><span style="font-weight:400;">. The sum of the parts is greater than the whole and all that. Genius &lt;big hat tip to them&gt;.</span></p>
<p><span style="font-weight:400;">In case you didn’t read Stripe’s post, here’s the gist: you’re a team player, you like to make an impact, focus on a tough problem, set a challenging goal, and see the fruits of your labor after blood, sweat, and tears (or, maybe just brainpower). But you’ve got the itch to collaborate, to talk an idea through, break it down, and parallelize tasks or simply to be around your mates through work and play. Turns out you already have your go-to group of colleagues, roommates, siblings, or buddies that push, inspire, and get the best out of you. Well, in that case we may want to hire all of you! </span></p>
<p><span style="font-weight:400;">Like Stripe, we understand the importance of team dynamics. So if you’ve already got something good going on, we want in on it too. We love Stripe and are stoked for this initiative of theirs, but if Flickr tickles your fancy (and it does ours :) consider bringing that team of yours this way too, especially if you’ve got a penchant for mobile development. We’d love to chat! </span></p>
<p><span style="font-weight:400;">Email us: jobs at flickr.com</span></p>
<p><img loading="lazy" class="alignnone size-medium wp-image-3445" src="https://wp.flickr.net/wp-content/uploads/sites/3/2016/05/team-crop.jpg?w=800" alt="Team crop" width="800" height="497" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2016/05/team-crop.jpg 1200w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/team-crop.jpg?resize=150,93 150w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/team-crop.jpg?resize=800,497 800w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/team-crop.jpg?resize=768,477 768w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/team-crop.jpg?resize=1024,637 1024w, https://code.flickr.net/wp-content/uploads/sites/3/2016/05/team-crop.jpg?resize=483,300 483w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p>Photos by: <a href="https://www.flickr.com/photos/cjmartin/14493569810/in/photolist-o5KkmE-s1Ab2X-oB9Jcz-r6894C-8UE9qs-nUiqdZ-nUD1T8-nSeAva-pu3e82-pEYdJy-rtfXVi-pAY9az-6qsxHF-nTFAd6-p3U1U1-qqhDn3-qY2QhS-or84zJ-osKqkn-qhnbAv-r5mmHv-ejKoBB-rASeqq-ejKp2H-qJV7kr-en2Lwp-oqgHNq-qsiNCQ-gKdheW-qDW829-o3RLfK-rw8To2-qbYAJC-nMYHBp-q4sajA-s3j5Ec-rj62WB-rxW8je-r31xGH-rqTqsT-occV8T-pRUg6U-en2L4a-p4R7rj-6cMnzR-oF16rb-7QBcD1-5XH2Yb-5XdwzJ-qjBx4n'">@Chris Martin</a> and <a href="https://www.flickr.com/photos/superic/17255895320/in/photolist-shQYuy-4y4vxZ-fqd5ou-dLQWLM">@Captain Eric Willis</a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="https://code.flickr.net/tag/careers/" rel="tag">careers</a>, <a href="https://code.flickr.net/tag/jobs/" rel="tag">jobs</a>			</span>
						
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3432 -->

				
					
	<article id="post-3319" class="post-3319 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2016/03/24/configuration-management-for-distributed-systems-using-github-and-cfg4j/" rel="bookmark">Configuration management for distributed systems (using GitHub and cfg4j)</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2016/03/24/configuration-management-for-distributed-systems-using-github-and-cfg4j/" title="4:39 am" rel="bookmark"><time class="entry-date" datetime="2016-03-24T04:39:31-07:00">March 24, 2016</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/norbertpotocki/" title="View all posts by norbertpotocki" rel="author">norbertpotocki</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><i>Norbert Potocki, Software Engineer @ Yahoo Inc.</i></p>
<h2><b>Warm up: <i>Why configuration management?</i></b></h2>
<p>When working with large-scale software systems, configuration management becomes crucial; supporting non-uniform environments gets greatly simplified if you decouple code from configuration. While building complex software/products such as <a href="https://www.flickr.com/">Flickr</a>, we had to come up with a simple, yet powerful, way to manage configuration. Popular approaches to solving this problem include using configuration files or having a dedicated configuration service. Our new solution combines the extremely popular <a href="http://github.com/">GitHub</a> and <a href="http://www.cfg4j.org/">cfg4j</a> library, giving you a very flexible approach that will work with applications of any size.</p>
<h4><b>Why should I decouple configuration from the code?</b></h4>
<ul>
<li>Faster configuration changes (e.g. flipping feature toggles): Configuration can simply be injected without requiring parts of your code to be reloaded and re-executed. Config-only updates tend to be faster than code deployment.</li>
<li>Different configuration for different environments: Running your app on a laptop or in a test environment requires a different set of settings than production instance.</li>
<li>Keeping credentials private: If you don’t have a dedicated credential store, it may be convenient to keep credentials as part of configuration. They usually aren’t supposed to be “public,” but the code still may be. Be a good sport and don&#8217;t keep credentials in a public GitHub repo. :)</li>
</ul>
<h2><b>Meet the Gang: <i>Overview of configuration management players</i></b></h2>
<p>Let’s see what configuration-specific components we’ll be working with today:</p>
<figure class="tmblr-full"><img class=" aligncenter" src="https://56.media.tumblr.com/33746f4780ff5e56d99c88e77e44e163/tumblr_inline_o47joy3QLn1t3d6pa_540.png" alt="image" /><figcaption><i> <small>Figure 1 &#8211;  Overview of configuration management components</small><br />
</i></figcaption></figure>
<p><i>Configuration repository and editor</i>: Where your configuration lives. We&#8217;re using <a href="https://git-scm.com/">Git</a> for storing configuration files and <a href="http://github.com/">GitHub</a> as an ad hoc editor.</p>
<p><i>Push cache </i>: Intermediary store that we use to improve fetch speed and to ease load on GitHub servers.</p>
<p><i>CD pipeline</i>: Continuous deployment pipeline pushing changes from repository to push cache, and validating config correctness.</p>
<p><i>Configuration library</i>: Fetches configs from push cache and exposing them to your business logic.</p>
<p><i>Bootstrap configuration </i>: Initial configuration specifying where your push cache is (so that library knows where to get configuration from).</p>
<p>All these players work as a team to provide an end-to-end configuration management solution.</p>
<h4><b>The Coach: <i>Configuration repository and editor</i></b></h4>
<p>The first thing you might expect from the configuration repository and editor is ease of use. Let’s enumerate what that means:</p>
<ul>
<li>Configuration should be easy to read and write.</li>
<li>It should be straightforward to add a new configuration set.</li>
<li>You most certainly want to be able to review changes if your team is bigger than one person.</li>
<li>It’s nice to see a history of changes, especially when you’re trying to fix a bug in the middle of the night.</li>
<li>Support from popular IDEs &#8211; freedom of choice is priceless.</li>
<li>Multi-tenancy support (optional) is often pragmatic.</li>
</ul>
<p>So what options are out there that may satisfy those requirements? The three very popular formats for storing configuration are <a href="http://yaml.org/">YAML</a>, Java Property files, and XML files. We use YAML &#8211; it is widely supported by multiple programming languages and IDEs, and it’s very readable and easy to understand, even by a non-engineer.</p>
<p>We could use a dedicated configuration store; however, the great thing about files is that they can be easily versioned by version control tools like Git, which we decided to use as it’s widely known and proven.</p>
<p>Git provides us with a history of changes and an easy way to branch off configuration. It also has great support in the form of GitHub which we use both as an editor (built-in support for YAML files) and collaboration tool (pull requests, forks, review tool). Both are nicely glued together by following the<a href="http://nvie.com/posts/a-successful-git-branching-model/"> Git flow branching model.</a> Here’s an example of a configuration file that we use:</p>
<figure class="tmblr-full"><img class=" aligncenter" src="https://56.media.tumblr.com/23132e30bc9ea96dc7a6dd21d1125a7a/tumblr_inline_o47m8ne6iT1t3d6pa_540.png" alt="" /><figcaption><i> <small>Figure 2 &#8211;  configuration file preview</small><br />
</i></figcaption></figure>
<p>One of the goals was to make managing multiple configuration sets (execution environments) a breeze. We need the ability to add and remove environments quickly. If you look at the screenshot below, you’ll notice a “prod-us-east” directory in the path. For every environment, we store a separate directory with config files in Git. All of them have the exact same structure and only differ in YAML file contents.</p>
<p>This solution makes working with environments simple and comes in very handy during local development or new production fleet rollout (see use cases at the end of this article). Here’s a sample config repo for a project that has only one “feature”:</p>
<figure class="tmblr-full"><img class=" aligncenter" src="https://56.media.tumblr.com/06b1f785bb828923d6cd2b82f4b9f100/tumblr_inline_o47medL5NH1t3d6pa_540.png" alt="" /><figcaption><i><small>Figure 3 &#8211;  support for multiple environments</small><br />
</i></figcaption></figure>
<p>Some of the products that we work with at Yahoo have a very granular architecture with hundreds of micro-services working together. For scenarios like this, it’s convenient to store configurations for all services in a single repository. It greatly reduces the overhead of maintaining multiple repositories. We support this use case by having multiple top-level directories, each holding configurations for one service only.</p>
<h4><b>The sprinter: <i>Push cache</i></b></h4>
<p>The main role of push cache is to decrease the load put on the GitHub server and improve configuration fetch time. Since speed is the only concern here, we decided to keep the push cache simple: it’s just a key-value store. <a href="http://consul.io/">Consul</a> was our choice, in part because it’s fully distributed.</p>
<p>You can install Consul clients on the edge nodes and they will keep being synchronized across the fleet. This greatly improves both the reliability and the performance of the system. If performance is not a concern, any key-value store will do. You can skip using push cache altogether and connect directly to Github, which comes in handy during development (see use cases to learn more about this).</p>
<h4><b>The Manager: <i>CD Pipeline</i></b></h4>
<p>When the configuration repository is updated, a CD pipeline kicks in. This fetches configuration, converts it into a more optimized format, and pushes it to cache. Additionally, the CD pipeline validates the configuration (once at pull-request stage and again after being merged to master) and controls multi-phase deployment by deploying config change to only 20% of production hosts at one time.</p>
<h4><b>The Mascot: <i>Bootstrap configuration</i></b></h4>
<p>Before we can connect to the push cache to fetch configuration, we need to know where it is. That’s where bootstrap configuration comes into play. It’s very simple. The config contains the hostname, port to connect to, and the name of the environment to use. You need to put this config with your code or as part of the CD pipeline. This simple yaml file binding Spring profiles to different Consul hosts suffices for our needs:</p>
<figure class="tmblr-full"><img class=" aligncenter" src="https://56.media.tumblr.com/738020b5614fc06a26b85d2dc13789ad/tumblr_inline_o47k33QdkU1t3d6pa_540.png" alt="image" /><figcaption><i><small>Figure 4 &#8211;  bootstrap configuration<br />
</small><br />
</i></figcaption></figure>
<h4><b>The Cool Guy: <i>Configuration library</i></b></h4>
<figure><img class=" aligncenter" src="https://56.media.tumblr.com/1370245b95cb98f542762a8040c6bf50/tumblr_inline_o47k4bgxl51t3d6pa_540.png" alt="image" /></figure>
<p>The configuration library takes care of fetching the configuration from push cache and exposing it to your business logic. We use the library called <a href="http://www.cfg4j.org/">cfg4j</a> (&#8220;configuration for java&#8221;). This library re-loads configurations from the push cache every few seconds and injects them into configuration objects that our code uses. It also takes care of local caching, merging properties from different repositories, and falling back to user-provided defaults when necessary (read more at <a href="http://www.cfg4j.org/">http://www.cfg4j.org/</a>).</p>
<p>Briefly summarizing how we use cfg4j’s features:</p>
<ul>
<li>Configuration auto-reloading: Each service reloads configuration every ~30 seconds and auto re-configures itself.</li>
<li>Multi-environment support: for our multiple environments (beta, performance, canary, production-us-west, production-us-east, etc.).</li>
<li>Local caching: Remedies service interruption when the push cache or configuration repository is down and also improves the performance for obtaining configs.</li>
<li>Fallback and merge strategies: Simplifies local development and provides support for multiple configuration repositories.</li>
<li>Integration with Dependency Injection containers &#8211; because we love DI!</li>
</ul>
<p>If you want to play with this library yourself, there’s plenty of examples both in<a href="http://www.cfg4j.org/"> its documentation</a> and<a href="https://github.com/cfg4j/cfg4j-sample-apps"> cfg4j-sample-apps Github repository</a>.</p>
<h4><b>The Heavy Lifter: <i>Configurable code</i></b></h4>
<p>The most important piece is business logic. To best make use of a configuration service, the business logic has to be able to re-configure itself in runtime. Here are a few rules of thumb and code samples:<b><br />
</b></p>
<ul>
<li>Use dependency injection for injecting configuration. This is how we do it using Spring Framework (see the bootstrap configuration above for host/port values):</li>
</ul>
<p><a href="https://gist.github.com/norbertpotocki/e91aa64b524592432630" rel="nofollow">https://gist.github.com/norbertpotocki/e91aa64b524592432630</a></p>
<ul>
<li>Use configuration objects to inject configuration instead of providing configuration directly &#8211; here’s where the difference is:</li>
</ul>
<p>Direct configuration injection (won’t reload as config changes)<br />
<a href="https://gist.github.com/norbertpotocki/eac0a927ca2df45c2a0b" rel="nofollow">https://gist.github.com/norbertpotocki/eac0a927ca2df45c2a0b</a></p>
<p>Configuration injection via “interface binding” (will reload as config changes):<br />
<a href="https://gist.github.com/norbertpotocki/0c0b5b9aa9d11c06c937" rel="nofollow">https://gist.github.com/norbertpotocki/0c0b5b9aa9d11c06c937</a></p>
<h2><b>The exercise: <i>Common use-cases (applying our simple solution)</i></b></h2>
<h4><b>Configuration during development (local overrides)</b></h4>
<p>When you develop a feature, a main concern is the ability to evolve your code quickly.  A full configuration-management pipeline is not conducive to this. We use the following approaches when doing local development:<b><br />
</b></p>
<ul>
<li>Add a temporary configuration file to the project and use cfg4j&#8217;s <i>MergeConfigurationSource</i> for reading config both from the configuration store and your file. By making your local file a primary configuration source, you provide an override mechanism. If the property is found in your file, it will be used. If not, cfg4j will fall back to using values from configuration store. Here’s an example (reference examples above to get a complete code):</li>
</ul>
<p><a href="https://gist.github.com/norbertpotocki/289f3943249ea2813dcf" rel="nofollow">https://gist.github.com/norbertpotocki/289f3943249ea2813dcf</a></p>
<ul>
<li>Fork the configuration repository, make changes to the fork and use cfg4j&#8217;s GitConfigurationSource to access it directly (no push<br />
cache required):</li>
</ul>
<p><a href="https://gist.github.com/norbertpotocki/dacdcc6671a2158ded5e" rel="nofollow">https://gist.github.com/norbertpotocki/dacdcc6671a2158ded5e</a></p>
<ul>
<li>Set up your private push cache, point your service to the cache, and edit values in it directly.</li>
</ul>
<h4><b>Configuration defaults</b></h4>
<p>When you work with multiple environments, some of them may share a configuration. That’s when using configuration defaults may be convenient. You can do this by creating a “default” environment and using cfg4j&#8217;s MergeConfigurationSource for reading config first from the original environment and then (as a fallback) from “default” environment.</p>
<h4><b>Dealing with outages</b></h4>
<p>Configuration repository, push cache, and configuration CD pipeline can experience outages. To minimize the impact of such events, it’s good practice to cache configuration locally (in-memory) after each fetch. cfg4j does that automatically.</p>
<h4><b>Responding to incidents &#8211; ultra fast configuration updates (skipping configuration CD pipeline)</b></h4>
<p>Tests can’t always detect all problems. Bugs leak to the production environment and at times it’s important to make a config change as fast as possible to stop the fire. If you’re using push cache, the fastest way to modify config values is to make changes directly within the cache. Consul offers a rich REST API and web ui for updating configuration in the key-value store.</p>
<h4><b>Keeping code and configuration in sync</b></h4>
<p>Verifying that code and configuration are kept in sync happens at the configuration CD pipeline level. One part of the continuous deployment process deploys the code into a temporary execution environment, and points it to the branch that contains the configuration changes. Once the service is up, we execute a batch of functional tests to verify configuration correctness.</p>
<h2><b>The cool down: <i>Summary</i></b></h2>
<p>The presented solution is the result of work that we put into building huge-scale photo-serving services. We needed a simple, yet flexible, configuration management system. Combining <a href="https://git-scm.com/">Git</a>, <a href="https://github.com/">Github</a>, <a href="http://consul.io/">Consul</a> and <a href="http://www.cfg4j.org/">cfg4j</a> provided a very satisfactory solution that we encourage you to try.</p>
<p><i>I want to thank the following people for reviewing this article: <b>Bhautik Joshi, Elanna Belanger, Archie Russell</b>.</i></p>
<p>PS. You can also follow me on <a href="https://twitter.com/norbert_potocki">Twitter</a>, <a href="https://github.com/norbertpotocki">GitHub</a>, <a href="https://www.linkedin.com/in/norbertpotocki">LinkedIn</a> or <a href="http://potocki.io/post/141230472743/configuration-management-for-distributed-systems">my private blog</a>.</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3319 -->

				
					
	<article id="post-3238" class="post-3238 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2015/11/18/flickrs-experience-with-ios-9/" rel="bookmark">Flickr&#8217;s experience with iOS 9</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2015/11/18/flickrs-experience-with-ios-9/" title="6:00 am" rel="bookmark"><time class="entry-date" datetime="2015-11-18T06:00:47-08:00">November 18, 2015</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/rocirs/" title="View all posts by Rocir Santiago" rel="author">Rocir Santiago</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>In the last couple of months, Apple has released new features as part of iOS 9 that allow a deeper integration between apps and the operating system. Among those features are Spotlight Search integration, Universal Links, and 3D Touch for iPhone 6S and iPhone 6S Plus.</p>
<p>Here at Flickr, we have added support for these new features and we have learned a few lessons that we would love to share.</p>
<h2><strong>Spotlight Search</strong></h2>
<p>There are two different kinds of content that can be searched through Spotlight: the kind that you explicitly index, and the kind that gets indexed based on the state your app is in. To explicitly index content, you use Core Spotlight, which lets you index multiple items at once. To index content related to your app’s current state, you use NSUserActivity: when a piece of content becomes visible, you start an activity to make iOS aware of this fact. iOS can then determine which pieces of content are more frequently visited, and thus more relevant to the user. NSUserActivity also allows us to mark certain items as public, which means that they might be shown to other iOS users as well.</p>
<p>For a better user experience, we index as much useful information as we can right off the bat. We prefetch all the user&#8217;s albums, groups, and people they follow, and add them to the search index using Core Spotlight. Indexing an item looks like this:</p>
<pre class="brush: objc; title: ; notranslate" title="">
// Create the attribute set, which encapsulates the metadata of the item we're indexing
CSSearchableItemAttributeSet *attributeSet = [[CSSearchableItemAttributeSet alloc] initWithItemContentType:(NSString *)kUTTypeImage];
attributeSet.title = photo.title;
attributeSet.contentDescription = photo.searchableDescription;
attributeSet.keywords = photo.keywords;
attributeSet.thumbnailData = UIImageJPEGRepresentation(photo.thumbnail, 0.98);

// Create the searchable item and index it.
CSSearchableItem *searchableItem = [[CSSearchableItem alloc] initWithUniqueIdentifier:[NSString stringWithFormat:@&amp;quot;%@/%@&amp;quot;, photo.identifier, photo.searchContentType] domainIdentifier:@&amp;quot;FLKCurrentUserSearchDomain&amp;quot; attributeSet:attributeSet];
[[CSSearchableIndex defaultSearchableIndex] indexSearchableItems:@[ searchableItem ] completionHandler:^(NSError * _Nullable error) {
                       if (error) {
                           // Handle failures.
                       }
              }];
</pre>
<p>Since we have multiple kinds of data &#8211; photos, albums, and groups &#8211; we had to create an identifier that is a combination of its type and its actual model ID.</p>
<p>Many users will have a large amount of data to be fetched, so it&#8217;s important that we take measures to make sure that the app still performs well. Since searching is unlikely to happen right after the user opens the app (that&#8217;s when we start prefetching this data, if needed), all this work is performed by a low-priority NSOperationQueue. If we ever need to fetch images to be used as thumbnails, we request it with low-priority <code>NSURLSessionDownloadTask</code>. These kinds of measures ensure that we don&#8217;t affect the performance of any operation or network request triggered by user actions, such as fetching new images and pages when scrolling through content.</p>
<p>Flickr provides a huge amount of public content, including many amazing photos. If anybody searches for &#8220;Northern Lights&#8221; in Spotlight, shouldn&#8217;t we show them our best Aurora Borealis photos? For this public content &#8211; photos, public groups, tags and so on &#8211; we leverage NSUserActivity, with its new search APIs, to make it all searchable when viewed. Here&#8217;s an example:</p>
<pre class="brush: objc; title: ; notranslate" title="">
CSSearchableItemAttributeSet *attributeSet = [[CSSearchableItemAttributeSet alloc] initWithItemContentType:(NSString *) kUTTypeImage];
// Setup attributeSet the same way we did before...
// Set the related unique identifier, so it matches to any existing item indexed with Core Spotlight.     
attributeSet.relatedUniqueIdentifier = [NSString stringWithFormat:@&amp;quot;%@/%@&amp;quot;, photo.identifier, photo.searchContentType];
        
self.userActivity = [[NSUserActivity alloc] initWithActivityType:@&amp;quot;FLKSearchableUserActivityType&amp;quot;];
self.userActivity.title = photo.title;
self.userActivity.keywords = [NSSet setWithArray:photo.keywords];
self.userActivity.webpageURL = photo.photoPageURL;
self.userActivity.contentAttributeSet = attributeSet;
self.userActivity.eligibleForSearch = YES;
self.userActivity.eligibleForPublicIndexing = photo.isPublic;
self.userActivity.requiredUserInfoKeys = [NSSet setWithArray:self.userActivity.userInfo.allKeys];
        
[self.userActivity becomeCurrent];
</pre>
<p>Every time a user opens a photo, public group, location page, etc., we create a new NSUserActivity and make it current. The more often a specific activity is made current, the more relevant iOS considers it. In fact, the more often an activity is made current by any number of different users, the more relevant Apple considers it globally, and the more likely it will show up for other iOS users as well (provided it’s public).</p>
<p>Until now we’ve only seen half the picture. We’ve seen how to index things for Spotlight search; when a user finally does search and taps on a result, how do we take them to the right place in our app? We’ll get to this a bit later, but for now suffice it to say that you’ll get a call to the method <code>application:continueUserActivity:restorationHandler:</code> to our application delegate.</p>
<p>It&#8217;s important to note that if we wanted to make use of the <code>userInfo</code> in the <code>NSUserActivity</code>, iOS won&#8217;t give it back to you for free in this method. To get it, we have to make sure that we assigned an NSSet to the <code>requiredUserInfoKeys</code> property of our <code>NSUserActivity</code> when we created it. In their documentation, Apple also tells us that if you set the <code>webpageURL</code> property when <code>eligibleForSearch</code> is <code>YES</code>, you need to make sure that you’re pointing to the right web URL corresponding to your content, otherwise you might end up with duplicate results in Spotlight (Apple crawls your site for content to surface in Spotlight, and if it finds the same content at a different URL it’ll think it’s a different piece of content).</p>
<h2><strong>Universal Links</strong></h2>
<p>In order to support Universal Links, Apple requires that every domain supported by the app host an &#8220;apple-app-site-association&#8221; file at its root. This is a JSON file that describes which relative paths in your domains can be handled by the app. When a user taps a link from another app in iOS, if your app is able to handle that domain for a specific path, it will open your app and call <code>application:continueUserActivity:restorationHandler:</code>. Otherwise your application won’t be opened &#8211; Safari will handle the URL instead.</p>
<pre class="brush: plain; title: ; notranslate" title="">
{
    &amp;quot;applinks&amp;quot;: {
        &amp;quot;apps&amp;quot;: [],
        &amp;quot;details&amp;quot;: {
            &amp;quot;XXXXXXXXXX.com.some.flickr.domain&amp;quot;: {
                &amp;quot;paths&amp;quot;: [
                    &amp;quot;/&amp;quot;,
                    &amp;quot;/photos/*&amp;quot;,
                    &amp;quot;/people/*&amp;quot;,
                    &amp;quot;/groups/*&amp;quot;
                ]
            }
        }
    }
}
</pre>
<p>This file has to be hosted on HTTPS with a valid certificate. Its MIME type needs to be &#8220;application/pkcs7-mime.&#8221; No redirects are allowed when requesting the file. If the only intent is to support Universal Links, no further steps are required. But if you’re also using this file to support Handoffs (introduced in iOS 8), then your file has to be CMS signed by a valid TLS certificate.</p>
<p>In Flickr, we have a few different domains. That means that each one of flickr.com, <a href="http://www.flickr.com" rel="nofollow">http://www.flickr.com</a>, m.flickr.com and flic.kr must provide its own JSON association file, whether or not they differ. In our case, the flic.kr domain actually does support different paths, since it’s only used for short URLs; hence, its &#8220;apple-app-site-association&#8221; is different than the others.</p>
<p>On the client side, only a few steps are required to support Universal Links. First, “Associated Domains” must be enabled under the Capabilities tab of the app’s target settings. For each supported domain, an entry &#8220;applinks:&#8221; entry must be added. Here is how it looks for Flickr:</p>
<p><img loading="lazy" class="aligncenter size-full wp-image-3272" src="https://wp.flickr.net/wp-content/uploads/sites/3/2015/11/screen-shot-2015-10-28-at-2-00-59-pm.png" alt="Screen Shot 2015-10-28 at 2.00.59 PM" width="755" height="181" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2015/11/screen-shot-2015-10-28-at-2-00-59-pm.png 755w, https://code.flickr.net/wp-content/uploads/sites/3/2015/11/screen-shot-2015-10-28-at-2-00-59-pm.png?resize=150,36 150w, https://code.flickr.net/wp-content/uploads/sites/3/2015/11/screen-shot-2015-10-28-at-2-00-59-pm.png?resize=500,120 500w" sizes="(max-width: 755px) 100vw, 755px" /></p>
<p>That is it. Now if someone receives a text message with a Flickr link, she will jump right to the Flickr app when she taps on it.</p>
<h2><strong>Deep linking into the app</strong></h2>
<p>Great! We have Flickr photos showing up as search results and Flickr URLs opening directly in our app. Now we just have to get the user to the proper place within the app. There are different entry points into our app, and we need to make the implementation consistent and avoid code duplication.</p>
<p>iOS has been supporting deep linking for a while already and so has Flickr. To support deep linking, apps could register to handle custom URLs (meaning a custom scheme, such as myscheme://mydata/123). The website corresponding to the app could then publish links directly to the app. For every custom URL published on the Flickr website, our app translates it into a representation of the data to be shown. This representation looks like this:</p>
<pre class="brush: objc; title: ; notranslate" title="">
@interface FLKRoute : NSObject

@property (nonatomic) FLKRouteType type;
@property (nonatomic, copy) NSString *identifier;

@end
</pre>
<p>It describes the type of data to present, and a unique identifier for that type of data.</p>
<pre class="brush: objc; title: ; notranslate" title="">
- (void)navigateToRoute:(FLKRoute *)route
{
    switch (route.type) {
        case FLKRouteTypePhoto:
            // Navigate to photo screen
            break;
        case FLKRouteTypeAlbum:
           // Navigate to album screen
            break;
        case FLKRouteTypeGroup:
            // Navigate to group screen
            break;
        // ...
        default:
            break;
    }
}
</pre>
<p>Now, all we have to do is to make sure we are able to translate both NSURLs and NSUserActivity objects into FLKRoute instances. For NSURLs, this translation is straightforward. Our custom URLs follow the same pattern as the corresponding website URLs; their paths correspond exactly. So translating both website URLs and custom URLs is a matter of using NSURLComponents to extract the necessary information to create the FLKRoute object.</p>
<p>As for NSUserActivity objects passed into <code>application:continueUserActivity:restorationHandler:</code>, there are two cases. One arises when the NSUserActivity instance was used to index a public item in the app. Remember that when we created the NSUserActivity object we also assigned its <code>webpageURL</code>? This is really handy because it not only uniquely identifies the data we want to present, but also gives us a NSURL object, which we can handle the same way we handle deep links or Universal Links.</p>
<p>The other case is when the NSUserActivity originated from a CSSearchableItem; we have some more work to do in this case. We need to parse the identifier we created for the item and translate it into a FLKRoute. Remember that our item&#8217;s identifier is a combination of its type and the model ID. We can decompose it and then create our route object. Its simplified implementation looks like this:</p>
<pre class="brush: objc; title: ; notranslate" title="">
FLKRoute * FLKRouteFromSearchableItemIdentifier(NSString *searchableItemIdentifier)
{
    NSArray *routeComponents = [searchableItemIdentifier componentsSeparatedByString:@&amp;quot;/&amp;quot;];
    if ([routeComponents count] != 2) { // type + id
        return nil;
    }
    
    // Handle the route type
    NSString *searchableItemContentType = [routeComponents firstObject];
    FLKRouteType type = FLKRouteTypeFromSearchableItemContentType(searchableItemContentType);
    
    // Get the item identifier
    NSString *itemIdentifier = [routeComponents lastObject];
    
    // Build the route object
    FLKRoute *route = [FLKRoute new];
    route.type = type;
    route.parameter = itemIdentifier;
    
    return route;
}
</pre>
<p>Now we have all our bases covered and we&#8217;re sure that we’ll drop the user in the right place when she lands in our app. The final application delegate method looks like this:</p>
<pre class="brush: objc; title: ; notranslate" title="">
- (BOOL)application:(nonnull UIApplication *)application continueUserActivity:(nonnull NSUserActivity *)userActivity restorationHandler:(nonnull void (^)(NSArray * __nullable))restorationHandler
{
    FLKRoute *route;
    NSString *activityType = [userActivity activityType];
    NSURL *url;
    
    if ([activityType isEqualToString:CSSearchableItemActionType]) {
        // Searchable item from Core Spotlight
        NSString *itemIdentifier = [userActivity.userInfo objectForKey:CSSearchableItemActivityIdentifier];
        route = FLKRouteFromSearchableItemIdentifier(itemIdentifier);
        
    } else if ([activityType isEqualToString:@&amp;quot;FLKSearchableUserActivityType&amp;quot;] ||
               [activityType isEqualToString:NSUserActivityTypeBrowsingWeb]) {
        // Searchable item from NSUserActivity or Universal Link
        url = userActivity.webpageURL;
        route = [url flk_route];
        
    }
    
    if (route) {
        [self.router navigateToRoute:route];
        return YES;
    } else if (url) {
        [[UIApplication sharedApplication] openURL:url]; // Fail gracefully
        return YES;
    } else {
        return NO;
    }
}
</pre>
<h2><strong>3D Touch</strong></h2>
<p>With the release of iPhone 6S and iPhone 6S Plus, Apple introduced a new gesture that can be used with your iOS app: 3D Touch. One of the coolest features it has brought is the ability to preview content before pushing it onto the navigation stack. This is also known as &#8220;peek and pop.&#8221;</p>
<p>You can easily see how this feature is implemented in the native Mail app. But you won&#8217;t always have a simple UIView hierarchy like Mail’s UITableView, where a tap anywhere on a cell opens a UIViewController. Take Flickr&#8217;s notifications screen, for example:</p>
<p><img loading="lazy" class="aligncenter size-medium wp-image-3273" src="https://wp.flickr.net/wp-content/uploads/sites/3/2015/11/4-0-04-core-five-notifications.png?w=450" alt="4.0-04-core-five-notifications" width="450" height="800" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2015/11/4-0-04-core-five-notifications.png 750w, https://code.flickr.net/wp-content/uploads/sites/3/2015/11/4-0-04-core-five-notifications.png?resize=84,150 84w, https://code.flickr.net/wp-content/uploads/sites/3/2015/11/4-0-04-core-five-notifications.png?resize=450,800 450w, https://code.flickr.net/wp-content/uploads/sites/3/2015/11/4-0-04-core-five-notifications.png?resize=576,1024 576w, https://code.flickr.net/wp-content/uploads/sites/3/2015/11/4-0-04-core-five-notifications.png?resize=169,300 169w" sizes="(max-width: 450px) 100vw, 450px" /></p>
<p>If the user taps on a photo in one of these cells, it will open the photo view. But if the user taps on another user&#8217;s name, it will open that user’s profile view. Previews of these UIViewControllers should be shown accordingly. But the &#8220;peek and pop&#8221; mechanism requires you to register a delegate on your UIViewController with <code>registerForPreviewingWithDelegate:sourceView:</code>, which means that you’re working in a much higher layer. Your UIViewController’s view might not even know about its subviews’ structures.</p>
<p>To solve this problem, we used UIView&#8217;s method <code>hitTest:withEvent:</code>. As the documentation describes, it will give us the &#8220;farthest descendant of the receiver in the view hierarchy.&#8221; But not every hitTest will necessarily return the UIView that we want. So we defined a protocol, <code>FLKPeekAndPopTargetView</code>, that must be implemented by any UIView subclass that wants to support peeking and popping from it. That view is then responsible for returning the model used to populate the UIViewController that the user is trying to preview. If the view doesn&#8217;t implement this protocol, we query its superview. We keep checking for it until a UIView is found or there aren&#8217;t any more superviews available. This is how this logic looks:</p>
<pre class="brush: objc; title: ; notranslate" title="">
+ (id)modelAtLocation:(CGPoint)location inSourceView:(UIView*)sourceView
    
    // Walk up hit-test tree until we find a peek-pop target.
    UIView *testView = [sourceView hitTest:location withEvent:nil];
    id model = nil;
    while(testView &amp;amp;&amp;amp; !model) {
      
        // Check if the current testView conforms to the protocol.
        if([testView conformsToProtocol:@protocol(FLKPeekAndPopTargetView)]) {
            
            // Translate location to view coordinates.
            CGPoint locationInView = [testView convertPoint:location fromView:sourceView];
            
            // Get model from peek and pop target.
            model = [((id&amp;lt;FLKPeekAndPopTargetView&amp;gt;)testView) flk_peekAndPopModelAtLocation:locationInView];
            
        } else {
            //Move up view tree to next view
            testView = testView.superview;
        }
    }
    
    return model;
}
</pre>
<p>With this code in place, all we have to do is to implement <code>UIViewControllerPreviewingDelegate</code> methods in our delegate, perform the <code>hitTest</code> and take the model out of the <code>FLKPeekAndPopTargetView</code>&#8216;s implementor. Here&#8217;s is the final implementation:</p>
<pre class="brush: objc; title: ; notranslate" title="">
- (UIViewController *)previewingContext:(id&amp;lt;UIViewControllerPreviewing&amp;gt;)previewingContext
              viewControllerForLocation:(CGPoint)location {
    
    id model = [[self class] modelAtLocation:location inSourceView:previewingContext.sourceView];
    UIViewController *viewController = nil;
    if ([model isKindOfClass:[FLKPhoto class]]) {
        viewController = // ... UIViewController that displays a photo.
    } else if ([model isKindOfClass:[FLKAlbum class]]) {
        viewController = // ... UIViewController that displays an album.
    } else if ([model isKindOfClass:[FLKGroup class]]) {
        viewController = // ... UIViewController that displays a group.
    } // ...
    return viewController;
    
}

- (void)previewingContext:(id&amp;lt;UIViewControllerPreviewing&amp;gt;)previewingContext
     commitViewController:(UIViewController *)viewControllerToCommit {
    
    [self.navigationController pushViewController:viewControllerToCommit animated:YES];
    
}
</pre>
<p>Last but not least, we added support for Quick Actions. Now the user has the ability to quickly jump into a specific section of the app just by pressing down on the app icon. Defining these Quick Actions statically in the Info.plist file is an easy way to implement this feature, but we decided to go one step further and define these options dynamically. One of the options we provide is &#8220;Upload Photo,&#8221; which takes the user to the asset picker screen. But if the user has Auto Uploadr turned on, this option isn’t that relevant, so instead we provide a different app icon menu option in its place.</p>
<p>Here&#8217;s how you can create Quick Actions:</p>
<pre class="brush: objc; title: ; notranslate" title="">
NSMutableArray&amp;lt;UIApplicationShortcutItem *&amp;gt; *items = [NSMutableArray array];
    
[items addObject:[[UIApplicationShortcutItem alloc] initWithType:@&amp;quot;FLKShortcutItemFeed&amp;quot;
                                                  localizedTitle:NSLocalizedString(@&amp;quot;Feed&amp;quot;, nil)]];
    
[items addObject:[[UIApplicationShortcutItem alloc] initWithType:@&amp;quot;FLKShortcutItemTakePhoto&amp;quot;
                                                  localizedTitle:NSLocalizedString(@&amp;quot;Upload Photo&amp;quot;, nil)] ];

[items addObject:[[UIApplicationShortcutItem alloc] initWithType:@&amp;quot;FLKShortcutItemNotifications&amp;quot;
                                                  localizedTitle:NSLocalizedString(@&amp;quot;Notifications&amp;quot;, nil)]];
    
[items addObject:[[UIApplicationShortcutItem alloc] initWithType:@&amp;quot;FLKShortcutItemSearch&amp;quot;
                                                  localizedTitle:NSLocalizedString(@&amp;quot;Search&amp;quot;, nil)]];
    
[[UIApplication sharedApplication] setShortcutItems:items];
</pre>
<p>And this is how it looks like when the user presses down on the app icon:</p>
<p><img loading="lazy" class="size-medium wp-image-3270 aligncenter" src="https://wp.flickr.net/wp-content/uploads/sites/3/2015/11/img_0344.png?w=450" alt="IMG_0344" width="450" height="800" srcset="https://code.flickr.net/wp-content/uploads/sites/3/2015/11/img_0344.png 750w, https://code.flickr.net/wp-content/uploads/sites/3/2015/11/img_0344.png?resize=84,150 84w, https://code.flickr.net/wp-content/uploads/sites/3/2015/11/img_0344.png?resize=450,800 450w, https://code.flickr.net/wp-content/uploads/sites/3/2015/11/img_0344.png?resize=576,1024 576w, https://code.flickr.net/wp-content/uploads/sites/3/2015/11/img_0344.png?resize=169,300 169w" sizes="(max-width: 450px) 100vw, 450px" /></p>
<p>Finally, we have to handle where to take the user after she selects one of these options. This is yet another place where we can make use of our <code>FLKRoute</code> object. To handle the app opening from a Quick Action, we need to implement <code>application:performActionForShortcutItem:completionHandler:</code> in the app delegate.</p>
<pre class="brush: objc; title: ; notranslate" title="">
- (void)application:(UIApplication *)application performActionForShortcutItem:(UIApplicationShortcutItem *)shortcutItem completionHandler:(void (^)(BOOL))completionHandler {
    FLKRoute *route = [shortcutItem flk_route];
     [self.router navigateToRoute:route];
    completionHandler(YES);
}
</pre>
<h2><strong>Conclusion</strong></h2>
<p>There is a lot more to consider when shipping these features with an app. For example, with Flickr, there are various platforms the user could be using. It is important to make sure that the Spotlight index is up to date to reflect changes made anywhere. If the user has created a new album and/or left a group from his desktop browser, we need to make sure that those changes are reflected in the app, so the newly-created album can be found through Spotlight, but the newly-departed group cannot.</p>
<p>All of this work should be totally opaque to the user, without hogging the device&#8217;s resources and deteriorating the user experience overall. That requires some considerations around threading and network priorities. Network requests for UI-relevant data should not be blocked because we have other network requests happening at the same time. With some careful prioritizing, using <code>NSOperationQueue</code> and <code>NSURLSession</code>, we managed to accomplish this with no major problems.</p>
<p>Finally, we had to consider privacy, one of the pillars of Flickr. We had to be extremely careful not to violate any of the user&#8217;s settings. We’re careful to never publicly index private content, such as photos and albums. Also, photos marked “restricted” are not publicly indexed since they might expose content that some users might consider offensive.</p>
<p>In this blog post we went into the basics of integrating iOS 9 Search, Universal Links, and 3D Touch in Flickr for iOS. In order to focus on those features, we simplified some of our examples to demonstrate how you could get started with them in your own app, and to show what challenges we faced.</p>
<div class="hiring-banner">
<p class="group-photo"><a title="Flickr September 2014 by Bhautik Joshi, on Flickr" href="https://www.flickr.com/photos/captin_nod/14965686478/"><img loading="lazy" src="https://farm4.staticflickr.com/3893/14965686478_9278dbe39c_m.jpg" alt="Flickr September 2014" width="120" height="80" /></a></p>
<p>Like this post? Have a love of online photography? Want to work with us? Flickr is hiring <strong>mobile, back-end and front-end engineers</strong>, in our San Francisco office. <strong>Find out more at <a href="https://www.flickr.com/jobs/">flickr.com/jobs</a></strong>.</p>
</div>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3238 -->

				
					
	<article id="post-3181" class="post-3181 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2015/09/25/perceptual-image-compression-at-flickr/" rel="bookmark">Perceptual Image Compression at Flickr</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2015/09/25/perceptual-image-compression-at-flickr/" title="5:35 pm" rel="bookmark"><time class="entry-date" datetime="2015-09-25T17:35:47-07:00">September 25, 2015</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/archieflickr/" title="View all posts by Archie Russell" rel="author">Archie Russell</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><i><span style="font-weight:400;">Archie Russell, Peter Norby, Saeideh Bakhshi</span></i></p>
<p>At Flickr our users really care about image quality.  They <i>also</i> care a lot about how responsive our apps are.  Addressing both of these concerns simultaneously is challenging;  higher quality images have larger file sizes and are slower to transfer.   Slow transfers are especially noticeable on mobile devices.   Flickr had historically aimed for high quality at the expense of larger files, but in late 2014 we implemented a method to <em>both</em> maintain image quality and decrease the byte-size of the images we serve to users.   As image appearance is very important to our users,  we performed an extensive user test before rolling this change out.   Here&#8217;s how we did it.</p>
<h2>Background:  JPEG Quality Settings</h2>
<div style="width: 355px" class="wp-caption alignright"><img loading="lazy" src="https://c1.staticflickr.com/1/755/21476411998_b47d8c2eb6_o.png" alt="" width="345" height="226" /><p class="wp-caption-text">Fig 1.    JPEG settings vs file size for a test image.</p></div>
<p>JPEG compression has several tuneable knobs.   The <b><i>q-value</i></b> is the best known of these; it adjusts the level of spatial detail stored for fine details;  a higher q-value typically keeps more detail.    However,  as q-value gets very close to 100,  file size increases dramatically,  usually without improving image appearance.</p>
<p>If file size and app performance isn&#8217;t an issue,  dialing up q-value is an easy way to get really nice-looking images; this is what Flickr has done in the past.    And if appearance isn&#8217;t very important,  dialing down q-value is a viable option.    But if you want <i>both</i>,  you&#8217;re kind of stuck.   Additionally,  q-value isn&#8217;t one-size-fits-all,  some images look great at q-value 80 while others don&#8217;t.</p>
<p>Another commonly adjusted setting is chroma-subsampling,  which alters the amount of color information stored in a JPEG file.    With a setting of 4:4:4,  the two chroma (color) channels in a JPG have as much information as the luminance channel.   In an image with a setting of 4:2:0, each chroma channel has only a quarter as much information as in an a 4:4:4 image.</p>
<table>
<tbody>
<tr>
<td style="text-align:center;"><img loading="lazy" class="alignnone" src="https://c1.staticflickr.com/1/573/21660491855_8874629a88_o.jpg" alt="" width="490" height="310" /> q=96,  chroma=4:4:4 <em>(125KB)</em></td>
<td style="text-align:center;"><img loading="lazy" class="alignnone" src="https://c1.staticflickr.com/1/752/21634483046_65f33afefc_o.jpg" alt="" width="490" height="310" />q=70, chroma=4:4:4 <em>(67KB)</em></td>
</tr>
<tr>
<td style="text-align:center;"><img loading="lazy" class="alignnone" src="https://c1.staticflickr.com/1/781/21660537205_b4bc70dbd5_o.jpg" alt="" width="490" height="310" />q=96, chroma=4:2:0 <em>(62KB)</em></td>
<td style="text-align:center;"><img loading="lazy" class="alignnone" src="https://c1.staticflickr.com/1/701/21472657030_c0f4906109_o.jpg" alt="" width="490" height="310" /> q=70, chroma=4:2:0 <em>(62KB)</em></td>
</tr>
</tbody>
</table>
<p>Table 1:   JPEG stored at different quality and chroma levels.   The upper left image is saved at high quality and chroma level; notice the color and detail in the folds of the red flag.   The lower right image has the lowest quality;  notice artifacts along the right edges of the red flag.</p>
<h2>Perceptual JPEG Compression</h2>
<p>Ideally we&#8217;d have an algorithm which automatically tuned all JPEG parameters to make a file smaller, but which would limit <i>perceptible</i> changes to the image.  Technology exists that attempts to do this and can decrease image file size by 30-50%. This compression ratio is highly dependent on image content and dimensions.</p>
<table>
<tbody>
<tr>
<td style="text-align:center;"><img loading="lazy" class="alignnone" src="https://c1.staticflickr.com/1/714/21671860802_7c6a2e0c24_o.jpg" alt="" width="490" height="310" /></td>
<td style="text-align:center;"><img loading="lazy" class="alignnone" src="https://c1.staticflickr.com/1/667/21495346570_61ce77defd_o.jpg" alt="" width="490" height="310" /></td>
</tr>
<tr>
<td style="text-align:center;">compressed: 112KB</td>
<td style="text-align:center;">non-compressed: 224KB</td>
</tr>
</tbody>
</table>
<p><span class="caption">Fig 2. <a href="https://c1.staticflickr.com/1/714/21671860802_7c6a2e0c24_o.jpg" target="_blank">Compressed</a> cropped JPEG is 50% smaller than <a href="https://c1.staticflickr.com/1/667/21495346570_61ce77defd_o.jpg" target="_blank">not-compressed</a> cropped JPEG, above, with no obvious defects.  Compression ratio is similar for a <a href="https://c1.staticflickr.com/1/751/21642985766_73dc62fc53_o.jpg" target="_blank">compressed 2048-pixel </a>wide JPEG (475KB) of the entire scene and its <a href="https://c1.staticflickr.com/1/623/21481122700_01d36020e7_o.jpg" target="_blank">corresponding not-compressed</a> JPEG (897KB). </span></p>
<p>We were pleased with perceptually compressed images in non-structured examinations.  The compressed images were smaller and nearly indistinguishable from their sources.   But we wanted to really quantify how well the technology worked before considering incorporating it into Flickr.  The standard computational tools for evaluating compression, such as SSIM, are fairly simplistic and don&#8217;t do a great job at modeling how a user sees things.  To really evaluate this technology had to use a better measure of perceptibility:  human minds.</p>
<p><img src="https://c1.staticflickr.com/1/752/21038236064_32950459f4_o.png" alt="The Gamified Taste Test" width="800" /></p>
<p>To test whether our image compression would impact user perception of image quality, we put together a &#8220;taste test.&#8221;  The taste test is constructed as a game with multiple rounds where users look at both compressed and uncompressed images.  Users accumulate points the longer they play, and get more points for doing well at the game.  We maintained a leaderboard to encourage participation and used only internal testers.The game&#8217;s test images came from a diverse collection of 250 images contributed by Flickr staff.  The images came from a variety of cameras and included a number of subjects from photographers with varying skill levels.</p>
<p><img loading="lazy" src="https://c1.staticflickr.com/1/751/21472835618_213bac1351_o.jpg" alt="sampling of images used in taste test" width="800" height="528" /><br />
<span class="caption">Fig 3. A sampling of images used in our taste test.</span></p>
<p>In each round, our test code randomly select a test image, and present two variants of this image side by side.  50% of the time we present the user two identical images; the rest of the time we present one compressed image and one uncompressed image.  We ask the tester if the two images look the same or different and we&#8217;d expect a user choosing randomly OR a user unable to distinguish the two cases would answer correctly about half the time.  We randomly swap the location of the compressed images to compensate for user bias to the left or the right.  If testers choose correctly, they are presented with a second question: &#8220;Which image did you prefer, and why?&#8221;</p>
<p><img src="https://c2.staticflickr.com/6/5742/21038190014_37a5a38144_o.png" alt="two kittens in a video game" /><br />
<span class="caption">Fig 4. Screenshot of taste test.</span></p>
<p>Our test displays images simultaneously to prevent testers noticing a longer load time for the larger, non-compressed image.  The images are presented with either 320, 640, or 1600 pixels on their longest side.  The 320 &amp; 640px images are shown for 12 seconds before being dimmed out.  The intent behind this detail is to represent how real users interact with our images.  The 1600px images stay on screen for 20 seconds, as we expect larger images to be viewed for longer periods of time by real users.   We award 100 points per round, regardless of whether a tester chose correctly and also award a bonus of 400 points when a tester correctly identifies whether images were identical or different.  We update the tester&#8217;s score every five tests so that the user perceives an increasing score without being rewarded immediately for any particular behavior.</p>
<h2>Taste Test Outcome and Deployment</h2>
<p>We ran our taste test for two weeks and analyzed our results.    Although we let users play as long as they liked,  we skipped the first result per user as a &#8220;warm-up&#8221; and considered only the subsequent ten results,  this limited the potential for users training themselves to spot compression artifacts.   We disregarded users that had fewer than eleven results.</p>
<table>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
<tbody>
<tr>
<td style="text-align:center;"><b>images</b></td>
<td style="text-align:center;"><b>total results</b></td>
<td style="text-align:center;"><b># labeled &#8220;identical&#8221; by tester</b></td>
<td style="text-align:center;"><b>% labeled &#8220;identical&#8221; by tester</b></td>
</tr>
<tr>
<td>two identical images</td>
<td style="text-align:center;"><span style="font-weight:400;">368</span></td>
<td style="text-align:center;"><span style="font-weight:400;">253</span></td>
<td style="text-align:center;"><span style="font-weight:400;">68.8%</span></td>
</tr>
<tr>
<td>one compressed, one non-compressed</td>
<td style="text-align:center;"><span style="font-weight:400;">352</span></td>
<td style="text-align:center;"><span style="font-weight:400;">238</span></td>
<td style="text-align:center;"><span style="font-weight:400;">67.6%</span></td>
</tr>
</tbody>
</table>
<p><span class="caption">Table 2.   Taste test results.   Testers select &#8220;identical&#8221; at nearly the same rate, whether the input is identical or not.</span></p>
<p>When our testers were presented with two <i>identical</i> images, they thought the images were identical only 68.8% of the time(!), and when presented with a compressed image next to a non-compressed image,  our testers thought the images were identical slightly less often:  67.6% of the time.  This difference was small enough for us,  and our statisticians told us it was statistically insignificant.  Our image pairs were so similar that multiple testers thought all images were identical and reported that the test system was buggy. We inspected the images most often labeled different, and found no significant artifacts in the compressed versions.</p>
<p>So even in this side-by-side test,  perceptual image compression is just barely noticeable when images are presented side-by-side.  As the Flickr website wouldn&#8217;t ever show compressed and uncompressed images at the same time, and the use of compression had large benefits in storage footprint and site performance, we elected to go forward.</p>
<p>At the beginning of 2014 we silently rolled out perceptual-based compression on our image thumbnails (we don&#8217;t alter the &#8220;original&#8221; images uploaded by our users).  The slight changes to image appearance went unnoticed by users, but user interactions with Flickr became much faster,  especially for users with slow connections, while our storage footprint became much smaller.  This was a best-case scenario for us.</p>
<p>Evaluating perceptual compression was a considerable task,  but it gave the confidence we needed to apply this compression in production to our users.    This marked the first time Flickr had adjusted image settings in years, and, it was fun.<br />
<img src="https://c1.staticflickr.com/1/633/21670107841_8b1a09c0a8_o.png" alt="High Score List" width="800" /><br />
<span class="caption">Fig 5.  Taste test high score list</span></p>
<h2>Epilogue</h2>
<p>After eighteen months of perceptual compression at Flickr,  we adjusted our settings slightly to shrink images an additional 15%.   For our users on mobile devices,  15% fewer bytes per image makes for a much more responsive experience.We had run a taste test on this newer setting and users were were able to spot our compression slightly more often than with our original settings.   When presented a pair of identical images, our testers declared these images identical 65.2% of the time,  when presented with different images,  of our testers declared the images identical 62% of the time.   It wasn&#8217;t as imperceptible as our original approach, but, we decided it was close enough to roll out.</p>
<p>Boy were we wrong!   A few very vocal users spotted the compression and didn&#8217;t like it at all.    The Flickr Help Forum had a very lively thread which <a href="http://petapixel.com/2015/06/08/flickr-decreased-quality-and-increased-compression-and-users-arent-happy/">Petapixel picked up</a>.  We <span style="text-decoration:line-through;">beat our heads against the wall</span> considered our options and came up with a middle path between our initial and follow-on approaches,  giving us smaller, faster-to-load files while still maintaining the appearance our users expect.</p>
<p>Through our use of perceptual compression,  combined with our use of <a href="http://code.flickr.net/2015/06/25/real-time-resizing-of-flickr-images-using-gpus/">on-the-fly resize</a> and <a href="http://yahooeng.tumblr.com/post/116391291701/yahoo-cloud-object-store-object-storage-at">COS</a>,  we&#8217;ve been able to decrease our storage footprint dramatically, while simultaneously improving user experience. It&#8217;s a win all around but we&#8217;re not done yet &#8212; we still have a few tricks up our sleeves.</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3181 -->

				
					
	<article id="post-3114" class="post-3114 post type-post status-publish format-standard hentry category-uncategorized tag-api tag-caching tag-data-model tag-eviction tag-model">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2015/09/01/the-data-freshener/" rel="bookmark">The Data Freshener</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2015/09/01/the-data-freshener/" title="4:26 pm" rel="bookmark"><time class="entry-date" datetime="2015-09-01T16:26:49-07:00">September 1, 2015</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/ericsoco/" title="View all posts by ericsoco" rel="author">ericsoco</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<div style="width:340px;">
    <a href="https://www.flickr.com/photos/hellomokona/956099245/">https://www.flickr.com/photos/hellomokona/956099245/</a><br />
    <em>So fresh</em>
</div>
<p>&nbsp;</p>
<h2>Change</h2>
<p>You may have noticed some changes in Flickr a couple months back. Like, half the site changed. 95% even, by some metrics. Some say CHANGE IT BACK! while others welcome change. Whatever your thoughts, the changes are here, and they mean things. For example, they mean new visual design and better usability. They mean a faster site. Unfortunately, up until recently, they also meant more stale data. Yuck.</p>
<div style="width:480px;">
    <a data-flickr-embed="true" href="https://www.flickr.com/photos/spcbrass/4388396268/" title="Change by spcbrass, on Flickr"><img loading="lazy" src="https://farm3.staticflickr.com/2759/4388396268_87224c6556_z.jpg" width="640" height="480" alt="Change"></a><script async src="https://embedr.flickr.com/assets/client-code.js" charset="utf-8"></script><br />
    <em>Change</em><br />
    &nbsp;
</div>
<p>Why? What? Well&#8230;here’s the deal. We have a new-ish frontend stack we’ve been using for the past couple years now. It’s an <a href="http://isomorphic.net/javascript">isomorphic</a> <a href="https://en.wikipedia.org/wiki/Single-page_application">single-page application</a>, runs on <a href="http://nodejs.org">node.js</a>, and is generally awesome. We call it Reboot.</p>
<div style="width:480px;">
    <a data-flickr-embed="true" href="https://www.flickr.com/photos/wafer/6897507098/" title="hi there / i am the computer by waferbaby, on Flickr"><img loading="lazy" src="https://farm6.staticflickr.com/5466/6897507098_78d4c5a056_z.jpg" width="640" height="425" alt="hi there / i am the computer"></a><script async src="https://embedr.flickr.com/assets/client-code.js" charset="utf-8"></script><br />
    <em>Reboot</em><br />
    &nbsp;
</div>
<p>In the World of Reboot, we treat data with kid gloves. We &lt;3 data. We never want to give it up, never want to let it down. Once we pull data from our APIs, we store the fetched data in your browser so that we don’t have to fetch it again the next time it’s needed. This means faster page loads and faster navigation, and less API traffic (and thus a more stable and scalable API). The data cached in your browser exists as long as the current Reboot session &#8212; until you refresh or leave Reboot for a non-Rebooted page.</p>
<p>However, this also meant that data could become stale. You change the date taken of your photo, someone else adds a comment, you navigate to a page with cached data&#8230;and you don’t see the changes. Wat? Yeah. So, this was not a huge problem until we moved lots of pages onto Reboot in the beginning of May. From that point forward, most Flickr user sessions have spent their entirety on Reboot, feeding off the same stale loaves of cached data.</p>
<div style="width:480px;">
    <a href="https://www.flickr.com/photos/recyclethis/157108084/">https://www.flickr.com/photos/recyclethis/157108084/</a><br />
    <em>Staleness</em><br />
    &nbsp;
</div>
<h2>The thinking (design / prototypes)</h2>
<p>We considered a number of possibilities for freshening up data during a user session. A brief history of the strategies we sampled, and their results:</p>
<h3>1. Refresh on update</h3>
<div style="width:480px;">
    <a data-flickr-embed="true" href="https://www.flickr.com/photos/the_family_farm/2571858493/" title="Ice Tea by MzScarlett / A.K.A. Michelle, on Flickr"><img loading="lazy" src="https://farm4.staticflickr.com/3075/2571858493_34a1f75ac3_z.jpg" width="640" height="480" alt="Ice Tea"></a><script async src="https://embedr.flickr.com/assets/client-code.js" charset="utf-8"></script><br />
    &nbsp;
</div>
<p>The first stab focused on updating data locally after it was changed by the user. Most of our simpler use cases already updated as expected, but some trickier cases with indirect relationships did not. For example, changing the date taken of a photo updated the data model for the photo, but deleting a photo did not necessarily ensure the photo was removed from all the cached albums, groups, and galleries to which it belonged. (Note that the photo was removed correctly from the backend, just not from the cached representation of those entities on the client.)</p>
<p>Cleaning up these relationships using change events between models helped, but didn’t solve all our problems. When someone outside of the local session (read: another user) changed data, it would not reflect in the current session. The only way to catch changes from outside the current session was to be more aggressive about evicting models.</p>
<h3>2. Nuclear option</h3>
<div style="width:480px;">
    <a href="https://www.flickr.com/photos/sdasmarchives/8091816484/">https://www.flickr.com/photos/sdasmarchives/8091816484/</a><br />
    &nbsp;
</div>
<p>The pendulum swung all the way in the other direction &#8212; instead of surgical removal of data models we knew to be out-of-date, what would happen if we removed all cached data on every navigation? This prototype was quick to build, and incredibly destructive. By doing this, all our cached data always remained as fresh as could be, but we essentially reverted to Web 1.0 &#8212; with the exception of the Reboot framework, everything was reloaded on every page.</p>
<p>Not surprisingly, this blew up API traffic (locally only! did not unleash that disaster at scale), and inflated page load times like a Jeff Koons sculpture. It did give us some baseline timing metrics we could point to as worst-case scenarios, however. The next step was to swing the pendulum back toward the middle &#8212; to a carefully-knitted solution that would preserve fast page loads and navigation, while ensuring the freshest data we could serve up.</p>
<h3>3. Refetch on navigate</h3>
<div style="width:340px;">
    <a data-flickr-embed="true" href="https://www.flickr.com/photos/daveemerson/4296539211/" title="fetched by Dave's Domain, on Flickr"><img loading="lazy" src="https://farm5.staticflickr.com/4029/4296539211_c054e6b762_z.jpg" width="498" height="640" alt="fetched"></a><script async src="https://embedr.flickr.com/assets/client-code.js" charset="utf-8"></script><br />
    &nbsp;
</div>
<p>At this point, our challenge was to find a solution that would keep navigation fast, API traffic slim, and pick up all changes to session data, whether local or remote. We ended up with a solution we call “refetching”: evicting and requesting new data models as the model is needed by the application. But when?<br />
We could refetch periodically or on a user action; we determined that the best time to trigger a refetch was on navigation &#8212; when the user navigates, cached models become eligible for refetching. Specifically, when the user navigates between sections of the site, refetching is triggered. This proved to be the happiest medium between speed and freshness.</p>
<p>A high-level outline of how the refetching strategy works:</p>
<ul>
<li>The user loads a page; data are requested from the API, and models are cached. As new models are created, they’re marked as being fresh.</li>
<li>The user navigates to another site section (e.g. Photostream → Search); all freshness marks are removed from all models. They’re now all eligible for refetching.</li>
<li>As Reboot builds the new page, it requests data models from the cache. Since they no longer have their seal of freshness, they are refetched, and marked as fresh once retrieved and cached.</li>
</ul>
<p>One important note &#8212; refetching is not triggered on browser back/forward navigation. Users expect near-immediate navigation, thanks to browser caching, when navigating to already-viewed content. Therefore, we refetch only when the user clicks a link to navigate to a new site section.</p>
<h3>4. Miscellany</h3>
<p>There were a couple other options we considered and rejected from the start, but they’re worth mentioning here.</p>
<p>One was a <a href="https://en.wikipedia.org/wiki/Time_to_live">TTL (time-to-live) algorithm</a>, commonly used in caching applications. TTL algorithms expire data and evict from the cache a certain amount of time after they’re written or last updated. The arbitrary nature of TTL would mean that users would sometimes have fresh data and sometimes stale; it would be fresh more often than without any solution, but freshness would vary arbitrarily and would not result in much of an improvement on user experience.</p>
<p>The other was to write an algorithm that tracks the amount of time since a data model was last accessed, and refetch when it grows too old. While this sounded interesting at first, it has the same flaw as a standard TTL algorithm &#8212; freshness becomes arbitrary. It’s also more complex to implement, and might end up not being worth the complexity.</p>
<h2>The doing (implementation)</h2>
<p>So that was it! Refetch on navigate, all done. Right?&#8230;.of course not. With the general strategy in place, the devil started sneaking around in all the details. Some of the highlights:</p>
<h3>Exemptions</h3>
<p>It proved to be not the best idea to evict on all navigation. For example, in Reboot we often preload photo metadata models on pages with lists of photos, in order to make navigation into the photo page snappy. The refetch setup therefore has an exemption config that allows us to easily retain models when navigating into, away from, or between specific site sections.</p>
<h3>Child models</h3>
<p>We often have parent-child associations between data models. For example, the data model for a photo has a reference to a data model for the author of the photo. When the photo model is refetched, the person model must be refetched as well. This means the function doing the eviction and refetching has to recurse through all child models.</p>
<h3>Collections</h3>
<p>An issue similar to child models above, but more complex, is the case of a model containing a list of other models. For example, the data model for a person’s photostream contains a list of photo models.</p>
<p>What made this particularly tricky is pagination and filtering &#8212; say you load the first 2 pages of your photostream, set your view filter to private, jump to page 5, switch the view to “Date taken”, and navigate away and back to your photostream&#8230;imagine the mess of different models with partially-loaded collections. Evicting one parent model, and its children, might evict photo models from the collection within another, without properly refetching. The solution here actually lay in the controller responsible for fetching pages: if a requested page of models is not already completely in-cache, a refetch will always happen to ensure we have all the data, in its freshest state.</p>
<h3>Refetch only once per page view</h3>
<p>Critical to the refetch-on-navigation strategy is to refetch only once per navigation. This was not too difficult, but essential to get right. We accomplish this by adding a flag when a model is initially fetched and upserted into the cache. When navigating to a new, non-exempt site section, all those flags are cleared, and any model requested by the new page will be refetched. When refetched, the model is again upserted into the cache and marked as fresh, until the next navigation.</p>
<h2>But did it fresh?</h2>
<div style="width:480px;">
    <a data-flickr-embed="true" href="https://www.flickr.com/photos/libellule24/4438085129/" title="Go on without me by Senorita Lena, on Flickr"><img loading="lazy" src="https://farm5.staticflickr.com/4019/4438085129_58cbbeb2f9_z.jpg" width="640" height="427" alt="Go on without me"></a><script async src="https://embedr.flickr.com/assets/client-code.js" charset="utf-8"></script><br />
    &nbsp;
</div>
<p>With the thinking and the doing out of the way, it was time to push all this to production. Because these changes are essentially pulling the rug out from underneath the data layer on every navigation, we had to tread very carefully in order to prevent any negative impact to the end user experience.</p>
<p>We did very thorough manual and automated testing across all of Reboot. We left the feature turned on for staff users for a while, to be able to respond to any bug reports. Finally, the time came to test on Real People. There were three things we needed to keep an eye on: errors (of course), impact on page navigation timing, and API traffic. Since refetching implies more requests for data, we needed to be sure that we were keeping the user experience smooth and fast, and also that we weren’t blowing up our data centers.</p>
<div style="width:480px;">
    &nbsp;<br />
    <a href="https://www.flickr.com/photos/karolfranks/6296290871/">https://www.flickr.com/photos/karolfranks/6296290871/</a><br />
    <em>All in</em><br />
    &nbsp;
</div>
<p>In order to get a good read on these things, though, we had to go all in. Letting in just a small percentage of users would not give reliable numbers for timing or traffic impacts, due to the noise inherent in relatively small sample sizes. So, we did something unusual: we turned on refetching for all users for a short period of time. We flipped on refetching and kept an eagle eye on our stats for 2 hours, then reverted; then, we took a careful look at the aggregated data to see how the experiment went.</p>
<p>Surprisingly, the impact on both timing and traffic was relatively low. After some thought, we decided this is most likely because the changes disproportionately impact people on long sessions, say a Flickr tab open for hours or days. Most people don’t hang around that long; they come, they go. Also, the photo page represents north of 90% of our page views, and is exempt from refetching (see Exemptions above).</p>
<p>So where did we end up? A negligible bump in navigation timing and API traffic, and fresher data for all. Perhaps an anticlimactic resolution, but the story we’ve heard today outlines a serious consideration for anyone building an application with a data caching layer: keep in mind from the beginning how you plan to deal with stale data, but in a way that keeps all the other benefits of a single-page application.</p>
<div style="width:480px;">
    <a data-flickr-embed="true" href="https://www.flickr.com/photos/pinguino/6800265589/" title="#CCC is a breadcat by pinguino, on Flickr"><img loading="lazy" src="https://farm8.staticflickr.com/7151/6800265589_3204a4723b_z.jpg" width="640" height="427" alt="#CCC is a breadcat"></a><script async src="https://embedr.flickr.com/assets/client-code.js" charset="utf-8"></script><br />
    <em>Busting through staleness. Yep.</em>
</div>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="https://code.flickr.net/tag/api/" rel="tag">api</a>, <a href="https://code.flickr.net/tag/caching/" rel="tag">caching</a>, <a href="https://code.flickr.net/tag/data-model/" rel="tag">data model</a>, <a href="https://code.flickr.net/tag/eviction/" rel="tag">eviction</a>, <a href="https://code.flickr.net/tag/model/" rel="tag">model</a>			</span>
						
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3114 -->

				
						<nav id="nav-below">
			<h3 class="assistive-text">Post navigation</h3>
			<div class="nav-previous"><a href="https://code.flickr.net/category/uncategorized/page/2/" ><span class="meta-nav">&larr;</span> Older posts</a></div>
			<div class="nav-next"></div>
		</nav><!-- #nav-above -->
	
			
			</div><!-- #content -->
		</section><!-- #primary -->

		<div id="secondary" class="widget-area" role="complementary">
					<aside id="search-2" class="widget widget_search">	<form method="get" id="searchform" action="https://code.flickr.net/">
		<label for="s" class="assistive-text">Search</label>
		<input type="text" class="field" name="s" id="s" placeholder="Search" />
		<input type="submit" class="submit" name="submit" id="searchsubmit" value="Search" />
	</form>
</aside>
		<aside id="recent-posts-2" class="widget widget_recent_entries">
		<h3 class="widget-title">Recent Posts</h3>
		<ul>
											<li>
					<a href="https://code.flickr.net/2022/02/14/safer-internet-day-and-open-source-codes-of-conduct/">Safer Internet Day and Open Source Codes of Conduct</a>
									</li>
											<li>
					<a href="https://code.flickr.net/2022/01/04/a-pluggable-solution-for-api-observability-on-our-php-system/">A Pluggable Solution for API Observability on our PHP System</a>
									</li>
											<li>
					<a href="https://code.flickr.net/2021/11/22/flickr-engineering-team-vision-guiding-principles/">Flickr Engineering Team Vision &#038; Guiding Principles</a>
									</li>
											<li>
					<a href="https://code.flickr.net/2018/04/20/together/">Together</a>
									</li>
											<li>
					<a href="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/">Introducing Similarity Search at Flickr</a>
									</li>
					</ul>

		</aside><aside id="archives-2" class="widget widget_archive"><h3 class="widget-title">Archives</h3>
			<ul>
					<li><a href='https://code.flickr.net/2022/02/'>February 2022</a></li>
	<li><a href='https://code.flickr.net/2022/01/'>January 2022</a></li>
	<li><a href='https://code.flickr.net/2021/11/'>November 2021</a></li>
	<li><a href='https://code.flickr.net/2018/04/'>April 2018</a></li>
	<li><a href='https://code.flickr.net/2017/03/'>March 2017</a></li>
	<li><a href='https://code.flickr.net/2017/01/'>January 2017</a></li>
	<li><a href='https://code.flickr.net/2016/09/'>September 2016</a></li>
	<li><a href='https://code.flickr.net/2016/05/'>May 2016</a></li>
	<li><a href='https://code.flickr.net/2016/04/'>April 2016</a></li>
	<li><a href='https://code.flickr.net/2016/03/'>March 2016</a></li>
	<li><a href='https://code.flickr.net/2015/12/'>December 2015</a></li>
	<li><a href='https://code.flickr.net/2015/11/'>November 2015</a></li>
	<li><a href='https://code.flickr.net/2015/09/'>September 2015</a></li>
	<li><a href='https://code.flickr.net/2015/07/'>July 2015</a></li>
	<li><a href='https://code.flickr.net/2015/06/'>June 2015</a></li>
	<li><a href='https://code.flickr.net/2015/03/'>March 2015</a></li>
	<li><a href='https://code.flickr.net/2014/10/'>October 2014</a></li>
	<li><a href='https://code.flickr.net/2014/08/'>August 2014</a></li>
	<li><a href='https://code.flickr.net/2014/07/'>July 2014</a></li>
	<li><a href='https://code.flickr.net/2014/05/'>May 2014</a></li>
	<li><a href='https://code.flickr.net/2014/04/'>April 2014</a></li>
	<li><a href='https://code.flickr.net/2014/02/'>February 2014</a></li>
	<li><a href='https://code.flickr.net/2013/09/'>September 2013</a></li>
	<li><a href='https://code.flickr.net/2013/06/'>June 2013</a></li>
	<li><a href='https://code.flickr.net/2013/03/'>March 2013</a></li>
	<li><a href='https://code.flickr.net/2012/12/'>December 2012</a></li>
	<li><a href='https://code.flickr.net/2012/10/'>October 2012</a></li>
	<li><a href='https://code.flickr.net/2012/07/'>July 2012</a></li>
	<li><a href='https://code.flickr.net/2012/06/'>June 2012</a></li>
	<li><a href='https://code.flickr.net/2012/05/'>May 2012</a></li>
	<li><a href='https://code.flickr.net/2012/04/'>April 2012</a></li>
	<li><a href='https://code.flickr.net/2012/02/'>February 2012</a></li>
	<li><a href='https://code.flickr.net/2012/01/'>January 2012</a></li>
	<li><a href='https://code.flickr.net/2011/12/'>December 2011</a></li>
	<li><a href='https://code.flickr.net/2011/10/'>October 2011</a></li>
	<li><a href='https://code.flickr.net/2011/09/'>September 2011</a></li>
	<li><a href='https://code.flickr.net/2011/08/'>August 2011</a></li>
	<li><a href='https://code.flickr.net/2011/07/'>July 2011</a></li>
	<li><a href='https://code.flickr.net/2011/06/'>June 2011</a></li>
	<li><a href='https://code.flickr.net/2011/03/'>March 2011</a></li>
	<li><a href='https://code.flickr.net/2011/02/'>February 2011</a></li>
	<li><a href='https://code.flickr.net/2011/01/'>January 2011</a></li>
	<li><a href='https://code.flickr.net/2010/11/'>November 2010</a></li>
	<li><a href='https://code.flickr.net/2010/10/'>October 2010</a></li>
	<li><a href='https://code.flickr.net/2010/09/'>September 2010</a></li>
	<li><a href='https://code.flickr.net/2010/08/'>August 2010</a></li>
	<li><a href='https://code.flickr.net/2010/07/'>July 2010</a></li>
	<li><a href='https://code.flickr.net/2010/05/'>May 2010</a></li>
	<li><a href='https://code.flickr.net/2010/04/'>April 2010</a></li>
	<li><a href='https://code.flickr.net/2010/03/'>March 2010</a></li>
	<li><a href='https://code.flickr.net/2010/02/'>February 2010</a></li>
	<li><a href='https://code.flickr.net/2010/01/'>January 2010</a></li>
	<li><a href='https://code.flickr.net/2009/12/'>December 2009</a></li>
	<li><a href='https://code.flickr.net/2009/11/'>November 2009</a></li>
	<li><a href='https://code.flickr.net/2009/10/'>October 2009</a></li>
	<li><a href='https://code.flickr.net/2009/09/'>September 2009</a></li>
	<li><a href='https://code.flickr.net/2009/07/'>July 2009</a></li>
	<li><a href='https://code.flickr.net/2009/06/'>June 2009</a></li>
	<li><a href='https://code.flickr.net/2009/05/'>May 2009</a></li>
	<li><a href='https://code.flickr.net/2009/04/'>April 2009</a></li>
	<li><a href='https://code.flickr.net/2009/03/'>March 2009</a></li>
	<li><a href='https://code.flickr.net/2009/02/'>February 2009</a></li>
	<li><a href='https://code.flickr.net/2009/01/'>January 2009</a></li>
	<li><a href='https://code.flickr.net/2008/12/'>December 2008</a></li>
	<li><a href='https://code.flickr.net/2008/11/'>November 2008</a></li>
	<li><a href='https://code.flickr.net/2008/10/'>October 2008</a></li>
	<li><a href='https://code.flickr.net/2008/09/'>September 2008</a></li>
	<li><a href='https://code.flickr.net/2008/08/'>August 2008</a></li>
	<li><a href='https://code.flickr.net/2008/07/'>July 2008</a></li>
	<li><a href='https://code.flickr.net/2008/06/'>June 2008</a></li>
	<li><a href='https://code.flickr.net/2008/05/'>May 2008</a></li>
	<li><a href='https://code.flickr.net/2008/04/'>April 2008</a></li>
			</ul>

			</aside><aside id="categories-2" class="widget widget_categories"><h3 class="widget-title">Categories</h3>
			<ul>
					<li class="cat-item cat-item-11749740"><a href="https://code.flickr.net/category/api-2/">API</a>
</li>
	<li class="cat-item cat-item-564792"><a href="https://code.flickr.net/category/change-log/">changelog</a>
</li>
	<li class="cat-item cat-item-5784"><a href="https://code.flickr.net/category/event/">event</a>
</li>
	<li class="cat-item cat-item-29160"><a href="https://code.flickr.net/category/geo/" title="All things geo related">geo</a>
</li>
	<li class="cat-item cat-item-139037766"><a href="https://code.flickr.net/category/hadoop/">hadoop</a>
</li>
	<li class="cat-item cat-item-32"><a href="https://code.flickr.net/category/infrastructure/">infrastructure</a>
</li>
	<li class="cat-item cat-item-139037765"><a href="https://code.flickr.net/category/kittens/">kittens</a>
</li>
	<li class="cat-item cat-item-20156"><a href="https://code.flickr.net/category/labs/">labs</a>
</li>
	<li class="cat-item cat-item-171"><a href="https://code.flickr.net/category/meta/">meta</a>
</li>
	<li class="cat-item cat-item-7092"><a href="https://code.flickr.net/category/metrics/">metrics</a>
</li>
	<li class="cat-item cat-item-139037764"><a href="https://code.flickr.net/category/open-source/">open source</a>
</li>
	<li class="cat-item cat-item-1930"><a href="https://code.flickr.net/category/performance/">performance</a>
</li>
	<li class="cat-item cat-item-304"><a href="https://code.flickr.net/category/photos/">photos</a>
</li>
	<li class="cat-item cat-item-2373"><a href="https://code.flickr.net/category/search/">search</a>
</li>
	<li class="cat-item cat-item-1 current-cat"><a aria-current="page" href="https://code.flickr.net/category/uncategorized/">Uncategorized</a>
</li>
	<li class="cat-item cat-item-249276"><a href="https://code.flickr.net/category/uploadr/">uploadr</a>
</li>
	<li class="cat-item cat-item-412"><a href="https://code.flickr.net/category/video/">video</a>
</li>
	<li class="cat-item cat-item-830560"><a href="https://code.flickr.net/category/xulrunner/">xulrunner</a>
</li>
			</ul>

			</aside><aside id="meta-2" class="widget widget_meta"><h3 class="widget-title">Meta</h3>
		<ul>
						<li><a href="https://code.flickr.net/wp-login.php">Log in</a></li>
			<li><a href="https://code.flickr.net/feed/">Entries feed</a></li>
			<li><a href="https://code.flickr.net/comments/feed/">Comments feed</a></li>

			<li><a href="https://wordpress.org/">WordPress.org</a></li>
		</ul>

		</aside>		</div><!-- #secondary .widget-area -->
	</div><!-- #main -->

	<footer id="colophon" role="contentinfo">

			

			<div id="site-generator">
				&copy; 2022 Flickr, Inc. All rights reserved. | 
								Powered by <a href="https://wpvip.com/?utm_source=vip_powered_wpcom&#038;utm_medium=web&#038;utm_campaign=VIP%20Footer%20Credit&#038;utm_term=code.flickr.net" rel="generator nofollow" class="powered-by-wpcom">WordPress VIP</a>			</div>
	</footer><!-- #colophon -->
</div><!-- #page -->

<script type="text/javascript" src="https://code.flickr.net/_static/??-eJzTLy/QTc7PK0nNK9EvyClNz8wr1i+uzCtJrMjITM/IAeKS1CJMEWP94uSizIISoOIM5/yiVL2sYh19oowqycgsStEtSCwqqdRNKiotzkgFmeEEYvknZTkTbxBeN4HNC8hJzMwDGmifa2toZmJpYW5mbmyeBQACOFzS" ></script><script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://code.flickr.net/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.head.appendChild( corecss );
		var themecssurl = "https://code.flickr.net/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		document.head.appendChild( themecss );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();

	// Infinite scroll support
	if ( typeof( jQuery ) !== 'undefined' ) {
		jQuery( function( $ ) {
			$( document.body ).on( 'post-load', function() {
				SyntaxHighlighter.highlight();
			} );
		} );
	}
</script>
<script src='https://stats.wp.com/e-202218.js' defer></script>
<script>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:10.9',blog:'185426273',post:'0',tz:'-7',srv:'code.flickr.net',hp:'vip'} ]);
	_stq.push([ 'clickTrackerInit', '185426273', '0' ]);
</script>

<script async src="https://embedr.flickr.com/assets/client-code.js" charset="utf-8"></script>

</body>
</html>
